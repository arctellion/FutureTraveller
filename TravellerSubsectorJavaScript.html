<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveller</title>
</head>
<body>
    <script src="SystemGenerator.js"></script>
    <style>
        fieldset{
            font-family:'Consolas','Inconsolas','Courier New', Courier, monospace;
            display:inline-block;
            vertical-align: text-top;
        }
        fieldset legend{
            cursor:pointer;
            user-select: none;
        }
        fieldset legend:hover{
            color:red;
        }
        label{
            user-select: none;
        }
        fieldset > fieldset{
            background-color:rgba(0,0,0,0.05);
        }
        fieldset *{
            line-height:1.5em;
        }
        fieldset.collapsed *:not(legend){
            display:none;
        }
        fieldset > legend::before{
            content:"▼ ";
        }
        fieldset.collapsed > legend::before{
            content:"► ";
        }
        canvas{
            border:1px solid black;
            background-color:white;
        }
        .travelcodepickers select option[value="Amber"] {
            background: rgb(255, 255, 127);
        }
        .travelcodepickers select[data-color="Amber"]{
            background-color: rgb(255, 255, 127);;
        }
        .travelcodepickers select option[value="Red"] {
            background: pink;
        }
        .travelcodepickers select[data-color="Red"]{
            background-color: pink;
        }
        #SystemDetailsContainer{
            display:inline-block;
                        position:absolute;
            border:1px solid gray;
            background-color:white;
            color:black;
            box-shadow:2px 2px 4px black;
            font-family:'Candara','Segoe UI',sans-serif;
            min-width:30rem;
            text-align:center;
        }
        #SystemDetails{
            position:relative;
            display:inline-block;
            text-align:left;
        }
        #SystemDetails h1, #SystemDetails h2, #SystemDetails h3,  #SystemDetails h4{

            font-family:'Candara','Eras Demi ITC','Eras Demi','Eras','Segoe UI',sans-serif;
            margin-top:0; margin-bottom:0;
        }
    </style>
    <fieldset>
        <legend>Controls</legend>
        <fieldset class="collapsed">
            <legend>Appearance</legend>                
            <label for="sizeSlider">Scale: <span id="sizeIndicator"></span></label><input type="range" min="4" max="50" id="sizeSlider" />
            <label for="slctStyle">Theme: </label><select name="slctStyle" id="slctStyle" data-text="white" data-canvasbg="black" data-hexfg="cyan" data-hexbg="rgba(0,200,255,0.2)">
                <option value="light">light</option>
                <option value="dark">dark</option>
                <option value="transparent">transparent</option>
                <option selected="selected" value="custom">custom</option>
            </select>
            <br/>                
            <fieldset id="customSettings" class="collapsed">
                <legend>Advanced</legend>
                <label for="textColor">Text Color: <input type="text" name="textColor" id="textColor" /></label><br/>
                <label for="hexBorderColor">Border Color: <input type="text" name="hexBorderColor" id="hexBorderColor" /></label><br/>
                <label for="hexBackgroundColor">Hex Fill: <input type="text" id="hexBackgroundColor" name="hexBackgroundColor" /></label><br/>
                <label for="canvasBackgroundColor">Background Color: <input type="text" name="canvasBackgroundColor" id="canvasBackgroundColor" /></label><br/>
                <label for="fontFamily">Font: <input type="text" id="fontFamily" name="fontFamily" value="Segoe UI, sans-serif"/></label>
            </fieldset>
        </fieldset>
        <fieldset class="collapsed">
            <legend>Overlays</legend>
            <label for="slcHeatMap">Heat Map: <select name="slcHeatMap" id="slcHeatMap">
                <option value="-1" selected=selected>No Heatmap</option>
                <option value="0">Starport</option>
                <option value="1">Size</option>
                <option value="2">Atmosphere</option>
                <option value="3">Hydrography</option>
                <option value="4">Population</option>
                <option value="5">Government Type</option>
                <option value="6">Law Level</option>
                <option value="7">Tech Level</option>
                <option value="8">Importance</option>
            </select>
        </label><br/>
        <label for="chkShowTravelCodes"><input type="checkbox" name="chkShowTravelCodes" id="chkShowTravelCodes" checked="checked"/> Show Travel Codes</label>
        </fieldset>        
        <fieldset class="collapsed">
            <legend>Systems</legend>
            <select name="slctMapSize" id="slctMapSize">
                <option value="Subsector">Subsector (8x10)</option>
                <option value="Quadrant">Quadrant (16x20)</option>
                <option value="Sector">Sector (32x40)</option>
            </select>         
            <label for="btnPopulateSystems"><input type="button" id="btnPopulateSystems" name="btnPopulateSystems" value="Populate Map"></label>
            <label for="btnClearSystems"><input type="button" id="btnClearSystems" name="btnClearSystems" value="Clear Map"></label>
            <br/><fieldset class="collapsed">
                <legend>Configuration</legend>
                <fieldset class="collapsed">
                    <legend>Astrographics</legend>
                    <label for="slctMainworldRules">System Gen Ruleset: 
                        <select name="slctMainworldRules" id="slctMainworldRules">
                            <option value="T5">T5</option>
                        </select></label><br/>
                    <label for="slctStellarDensity">Stellar Density: <select name="slctStellarDensity" id="slctStellarDensity">
                        <option value="Extra Galactic">Extra Galactic (1%)</option>
                        <option value="Rift">Rift (3%)</option>
                        <option value="Sparse">Sparse (17%)</option>
                        <option value="Scattered">Scattered (33%)</option>
                        <option value="Standard" selected="selected">Standard (50%)</option>
                        <option value="Dense">Dense (66%)</option>
                        <option value="Cluster">Cluster (83%)</option>
                        <option value="Core">Core (91%)</option>
                        <option value="Clump">Dense in middle</option>
                    </select></label><br/>
                    <label for="slctGGFrequency">Gas Giant Occurrence: <select name="slctGGFrequency" id="slctGGFrequency">
                        <option selected=selected value=8>8- on 2D (T5) 72%</option>
                        <option value=9>9- on 2D (CE) 83%</option>
                    </select></label>
                </fieldset>
                <fieldset class="collapsed">
                    <legend>Demographics</legend>
                    <label for="slctMaxTechLevel">Maximum Tech Level: 
                        <select name="slctMaxTechLevel" id="slctMaxTechLevel">
                            <option value=22 >22 (N)</option>
                            <option value=21>21 (M)</option>
                            <option value=20>20 (L)</option>
                            <option value=19>19 (K)</option>
                            <option value=18>18 (J)</option>
                            <option value=17>17 (H)</option>
                            <option value=16 selected="selected">16 (G)</option>
                            <option value=15>15 (F)</option>
                            <option value=14>14 (E)</option>
                            <option value=13>13 (D)</option>
                            <option value=12>12 (C)</option>
                            <option value=11>11 (B)</option>
                            <option value=10>10 (A)</option>
                            <option value=9>9</option>
                            <option value=8>8</option>
                            <option value=7>7</option>
                            <option value=6>6</option>
                            <option value=5>5</option>
                            <option value=4>4</option>
                            <option value=3>3</option>
                            <option value=2>2</option>
                            <option value=1>1</option>
                            <option value=0>0</option>
                        </select>
                    </label>
                    <br/>
                    <label for="chkPermitDieback" title="Dieback worlds have 0 population but TL>0"><input checked="checked" type="checkbox" name="chkPermitDieback" id="chkPermitDieback" /> Permit Dieback Worlds</label>
                    <br/><label for="slctDiebackTLPenalty">Uninhabited world TL -<select name="slctDiebackTLPenalty" id="slctDiebackTLPenalty">
                        <option value=5>5</option>
                        <option value=4>4</option>
                        <option value=3>3</option>
                        <option selected="selected" value=2>2</option>
                        <option value=1>1</option>
                        <option value=0>0</option>
                    </select></label>
                </fieldset>
                <fieldset class="collapsed travelcodepickers">
                    <legend>Travel Zones</legend>
                    <input type="button" value="Remove travel codes" id="btnClearTravelCodes" />
                    <fieldset>
                        <legend>Automatic Assignment</legend>
                        <input type="button" disabled=true value="Apply travel zones" id="btnApplyTravelCodes" />
                        <input type="button" disabled=true value="Thriggle Defaults" id="btnResetTravelCodes">
                        <input type="button" value="CE Defaults" id="btnCETravelCodes">
                        <input type="button" value="T5 Defaults" id="btnT5TravelCodes">
                        <br/>
                        <fieldset class="collapsed">
                            <legend>Habitation</legend>
                            <label for="slctRedZoneX" title="Pop>0 but Starport=X"><select data-color="Red" name="slctRedZoneX"  id="slctRedZoneX">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option selected="selected" value="Red">Red</option>
                            </select> Inhabited w/out Starport</label><br/>
                            <label for="slctAmberZoneBa" title="Barren worlds have 0 population and TL=0"><select data-color="Amber" name="slctAmberZoneBa"  id="slctAmberZoneBa">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Barren Worlds </label><br/>
                            <label for="slctAmberZoneBaX" title="Pop=0 and Starport=X"><select data-color="N/A" name="slctAmberZoneBaX"  id="slctAmberZoneBaX">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Uninhabited w/out Starport</label><br/>
                            <label for="slctAmberDieback" title="Dieback worlds have 0 population but TL>0"><select data-color="Red" name="slctAmberDieback" id="slctAmberDieback">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option selected="selected" value="Red">Red</option>
                            </select> Dieback Worlds </label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Atmosphere</legend>
                            <label for="slctAmberZoneAtmo"><select data-color="Amber" name="slctAmberZoneAtmo" id="slctAmberZoneAtmo">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Dangerous Atmospheres (<select id="slctDangerousAtmoThreshold">
                                <option value=10>10</option>
                                <option value=11>11</option>
                                <option selected="selected" value=12>12</option>
                            </select>+)</label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Law Level</legend>
                            <label for="slctRedGovLaw"><select name="slctRedGovLaw" data-color="Amber" id="slctRedGovLaw">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Law + Government >= <select id="slctRedGovLawThreshold">
                                <option value=30>30</option>
                                <option value=29>29</option>
                                <option value=28>28</option>
                                <option value=27>27</option>
                                <option value=26>26</option>
                                <option value=25>25</option>
                                <option value=24>24</option>
                                <option value=23>23</option>
                                <option selected=selected value=22>22</option>
                                <option value=21>21</option>
                                <option value=20>20</option>
                                <option value=19>19</option>
                            </select></label><br/>
                            <label for="slctAmberGovLaw"><select name="slctAmberGovLaw" data-color="N/A" id="slctAmberGovLaw">
                                <option selected="selected" value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Law + Government >= <select id="slctAmberGovLawThreshold">
                                <option value=30>30</option>
                                <option value=29>29</option>
                                <option value=28>28</option>
                                <option value=27>27</option>
                                <option value=26>26</option>
                                <option value=25>25</option>
                                <option value=24>24</option>
                                <option value=23>23</option>
                                <option value=22>22</option>
                                <option value=21>21</option>
                                <option selected=selected value=20>20</option>
                                <option value=19>19</option>
                            </select></label><br/>
                            <label for="slctAmberZoneLL"><select name="slctAmberZoneLL" data-color="N/A" id="slctAmberZoneLL">
                                <option selected="selected" value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Highest LL World(s) (min <select id="slctMaxLawLevelThreshold">
                                <option value=15>15</option>
                                <option value=14>14</option>
                                <option value=13>13</option>
                                <option value=12>12</option>
                                <option value=11>11</option>
                                <option value=10>10</option>
                                <option selected=selected value=9>9</option>
                                <option value=8>8</option>
                            </select>+)</label><br/>
                            <label for="slctAmberZone9LL"><select data-color="N/A" name="slctAmberZone9LL" id="slctAmberZone9LL">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> High Law (<select id="slctLawLevelThreshold">
                                <option value=15>15</option>
                                <option value=14>14</option>
                                <option value=13>13</option>
                                <option value=12>12</option>
                                <option value=11>11</option>
                                <option value=10>10</option>
                                <option selected=selected value=9>9</option>
                                <option value=8>8</option>
                            </select>+) Worlds </label><br/>
                            <label for="slctAmberZone0LL"><select data-color="N/A" name="slctAmberZone0LL" id="slctAmberZone0LL">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Lawless Worlds</label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Government</legend>
                            <label for="slctAmberZoneGov0"><select data-color="N/A" name="slctAmberZoneGov0" id="slctAmberZoneGov0">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Ungoverned Worlds</label><br/>
                            <label for="slctAmberZoneGov7"><select data-color="N/A" name="slctAmberZoneGov7" id="slctAmberZoneGov7">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Balkanized Worlds</label><br/>
                            <label for="slctAmberZoneGov10"><select data-color="N/A" name="slctAmberZoneGov10" id="slctAmberZoneGov10">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Charismatic Dictatorships</label><br/>
                        </fieldset>
                        
                    </fieldset>
                   
                </fieldset>
            </fieldset>
            
        </fieldset>
    </fieldset>
    <br/>
    <canvas id="canvas"></canvas>
    <br/>
    <fieldset>
        <legend>Data</legend>
        <textarea name="data" id="data" cols="30" rows="10"></textarea>
        <input type="button" value="Apply" id="btnApplyData">
    </fieldset>
    <div id="SystemDetailsContainer" style="display:none;">
        <div id="SystemDetails">
            <h1><span data-system="tcoord"></span>: <span data-system="name">System Name</span> <span data-system="uwp"></span></h1>
            <h3><span data-importance="description">System Importance</span> system (<span data-importance="weeklytraffic"></span> ships/week)</h3>
            <h4 data-mainworld="tradecodes" data-lookup="tradecode" data-join=", " ></h4>
            <h4><span style="font-weight:heavy">Bases:</span> <span style="font-weight:normal" data-system="bases" data-join=", " data-ifblank="None" >None</span></h4>
            <h4><span data-system="travelcodenotes"></span></h4>
            <h3>System Map:</h3>
            <ul id="maplist"></ul>
        </div>
    </div>
    <script src="NameGenerator.js"></script>
    <script>
        (function(){
            //globals
            var wordMaker;
            var HEX_SIZE = 27,
                HEX_BORDER_COLOR = "white",
                HEX_BACKGROUND_COLOR = "rgba(0,0,0,0.7)",
                HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)",
                CANVAS_BACKGROUND_COLOR = "rgb(50,50,50)",
                CAPITAL_TEXT_COLOR = "rgb(255,100,100)",
                CAPITAL_BACKGROUND_COLOR = "black",
                TEXT_COLOR = "white",
                CANVAS_PADDING = 20,
                SUBSECTOR_WIDTH = 8,
                SUBSECTOR_HEIGHT = 10,
                FONT = "sans-serif";
            var HEX_MATH = {
                radius:HEX_SIZE,
                xOffset:HEX_SIZE*3,
                yOffset:HEX_SIZE*4,
                diameter:HEX_SIZE*2
            }
            
            var mins = [-1,-1,-1,-1,-1,-1,-1,-1,-3], 
            maxes = [0,0,0,0,0,0,0,0,5], 
            labels = ["starport","size","atmo","hydro","pop","gov","law","tech"];
            var _systems = {};
            
            var canvas = document.getElementById("canvas");
            canvas.setAttribute("width",SUBSECTOR_WIDTH*HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
            canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter + CANVAS_PADDING*2);
            var ctx = canvas.getContext('2d');
            
            var mapContent = [];
            document.getElementById("sizeSlider").value = HEX_SIZE;
            mapContent = generateHexes(SUBSECTOR_WIDTH,SUBSECTOR_HEIGHT);
            updateStyle();
            var fontSize = HEX_SIZE*1/3;
            ctx.font = ""+fontSize+"pt "+FONT;
            drawMap(mapContent);
            NameGenerator("names.jsonc",function(o){wordMaker = o; populateSubsector();});
            var lastHighlightedHex;
            attachEventListeners();
            

            function attachEventListeners(){
                canvas.addEventListener("mousemove",function(e){
                    var hexIdentified = false;
                    var x = e.clientX - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                    var y = e.clientY - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                    if(lastHighlightedHex){
                        if(coordsInHexagon(x,y,lastHighlightedHex)){
                            hexIdentified = true;
                        }else{
                            lastHighlightedHex.highlighted = false;
                        }
                    }
                    if(!hexIdentified){
                        for(var i = 0, len = mapContent.length; i < len; i++){
                            var hex = mapContent[i];
                            if(!hexIdentified){
                                if(coordsInHexagon(x,y, hex)){
                                    hex.highlighted = true;
                                    hexIdentified = true;
                                    if(lastHighlightedHex){
                                        lastHighlightedHex.highlighted = false;
                                    }
                                    lastHighlightedHex = hex;
                                    drawMap(mapContent);
                                    break;
                                }
                            }
                        }
                        
                    }
                });
                canvas.addEventListener("click",function(e){
                    var x = e.clientX - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                    var y = e.clientY - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(coordsInHexagon(x,y, hex)){
                            if(hex.selected){
                                hex.selected = false;
                                var detailBlock = document.getElementById("SystemDetailsContainer");
                                detailBlock.style.display = "none";
                            }
                            else{
                                hex.selected = true;
                                var detailBlock = document.getElementById("SystemDetailsContainer");
                                if(hex.system){
                                    renderSystem(hex.system);
                                    detailBlock.style.left = e.clientX + "px";// - canvas.getBoundingClientRect().left +"px";
                                    detailBlock.style.top = e.clientY + "px";//- canvas.getBoundingClientRect().top+"px";
                                    detailBlock.style.display = "inline-block";
                                }else{
                                    detailBlock.style.display = "none";
                                }                                
                            }
                        }else{
                            if(hex.selected){
                                hex.selected = false;
                            }
                        }
                    }
                    drawMap(mapContent);
                });
                canvas.addEventListener("mouseout",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(hex.highlighted){
                            hex.highlighted = false;
                        }
                    }
                    drawMap(mapContent);
                });
                var collapserHandles = document.querySelectorAll("fieldset legend");
                for(var i = 0, len = collapserHandles.length; i < len; i++){
                    var handle = collapserHandles[i];
                    handle.addEventListener("click",function(e){
                        var parent = e.target.parentElement;
                        if(parent.classList.contains("collapsed")){
                            parent.classList.remove("collapsed");
                        }else{
                            parent.classList.add("collapsed");
                        }
                    });
                }
                document.getElementById("slctMapSize").addEventListener("change",function(){
                    var choice = document.getElementById("slctMapSize").value;
                    switch(choice){
                        case "Subsector": SUBSECTOR_HEIGHT = 10; SUBSECTOR_WIDTH = 8; break;
                        case "Quadrant": SUBSECTOR_HEIGHT = 20; SUBSECTOR_WIDTH = 16; break;
                        case "Sector": SUBSECTOR_HEIGHT = 40; SUBSECTOR_WIDTH = 32; break;
                    }
                    //updateHexSize(+(document.getElementById("sizeSlider").value));
                    canvas.setAttribute("width",SUBSECTOR_WIDTH*HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
                    canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter + CANVAS_PADDING*2);
                    drawMap(mapContent);
                });
                document.getElementById("slctStyle").addEventListener("change",updateStyle);
                document.getElementById("sizeSlider").addEventListener("change",function(){
                    updateHexSize(+(document.getElementById("sizeSlider").value));
                    drawMap(mapContent);
                });
                document.getElementById("fontFamily").addEventListener("keyup",updateStyle);
                document.getElementById("hexBorderColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBorderColor").value;
                    updateHexBorderColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexfg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("textColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("textColor").value;
                    updateTextColor(newColor);
                    drawMap(mapContent);
                });
                document.getElementById("hexBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBackgroundColor").value;
                    updateHexBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("canvasBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("canvasBackgroundColor").value;
                    updateCanvasBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-canvasbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyData").addEventListener("click",function(){
                    var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, JSON.parse(document.getElementById("data").value));
                    drawMap(mapContent);
                });
                document.getElementById("btnPopulateSystems").addEventListener("click",populateSubsector);
                document.getElementById("btnClearSystems").addEventListener("click",function(){
                    //var mapContent = [];
                    //document.getElementById("sizeSlider").value = HEX_SIZE;
                    mapContent = generateHexes(SUBSECTOR_WIDTH,SUBSECTOR_HEIGHT);
                    //updateStyle();
                    //ctx.font = ""+fontSize+"pt "+FONT;
                    drawMap(mapContent);
                });
                document.getElementById("slcHeatMap").addEventListener("change",function(){
                    drawMap(mapContent);
                });
                document.getElementById("chkShowTravelCodes").addEventListener("change",function(){
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyTravelCodes").addEventListener("click",function(){
                    applyTravelCodes(mapContent);
                    drawMap(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = true;
                });
                document.getElementById("btnClearTravelCodes").addEventListener("click",function(){
                    clearTravelCodes(mapContent);
                    drawMap(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                });
                document.getElementById("btnResetTravelCodes").addEventListener("click",resetTravelCodes);
                document.getElementById("btnCETravelCodes").addEventListener("click",selectCETravelCodes);
                document.getElementById("btnT5TravelCodes").addEventListener("click",selectT5TravelCodes);
                var zonePickers = document.querySelectorAll("select[data-color]");
                for(var i = 0, len = zonePickers.length; i < len; i++){
                    zonePickers[i].addEventListener("change",function(e){
                        e.target.setAttribute("data-color",e.target.value);
                        document.getElementById("btnApplyTravelCodes").disabled = false;
                        document.getElementById("btnResetTravelCodes").disabled = false;
                    });
                }

                document.getElementById("slctAmberGovLawThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctDangerousAtmoThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctRedGovLawThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctMaxLawLevelThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctLawLevelThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
            }
            function populateSubsector(){
                var ggFrequency = document.getElementById("slctGGFrequency").value;
                var density = document.getElementById("slctStellarDensity").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked;
                var maxTechLevel = document.getElementById("slctMaxTechLevel").value;
                var d = 1, target = 3, systems = {};
                switch(density){
                    case "Extra Galactic": d = 3, target = 3; break;
                    case "Rift": d = 2, target = 2; break;
                    case "Sparse": d = 1, target = 1; break;
                    case "Scattered": d = 1, target = 2; break;
                    case "Standard": d = 1, target = 3; break;
                    case "Dense": d = 1, target = 4; break;
                    case "Cluster": d = 1, target = 5; break;
                    case "Core": d = 2, target = 11; break;
                    case "Clump": d = 1, target = 2; break;
                }
                var namesSoFar = {};
                mins = [-1,-1,-1,-1,-1,-1,-1,-1,-3], maxes = [0,0,0,0,0,0,0,0,5];
                var systemArray = [];
                for(var x = 0; x < SUBSECTOR_WIDTH; x++){
                    for(var y = 0; y < SUBSECTOR_HEIGHT; y++){
                        if(density === "Clump"){
                            if(x >= SUBSECTOR_WIDTH/3 && x <= SUBSECTOR_WIDTH*2/3 && y >= SUBSECTOR_HEIGHT/3 && y <= SUBSECTOR_HEIGHT*2/3){
                                target = 4;
                            }else if(x >= SUBSECTOR_WIDTH/4 && x <= SUBSECTOR_WIDTH*3/4 && y >= SUBSECTOR_HEIGHT/4 && y <= SUBSECTOR_HEIGHT*3/4){
                                target = 3;
                            }else if(x >= SUBSECTOR_WIDTH/8 && x <= SUBSECTOR_WIDTH*7/8 && y >= SUBSECTOR_HEIGHT/8 && y <= SUBSECTOR_HEIGHT*7/8){
                                target = 2;
                            }else{
                                target = 1;
                            }
                        }
                        if(d6(d) <= target){
                            var name = wordMaker.getRandomName("system");
                            while(Object.keys(namesSoFar).indexOf(name) >= 0){
                                name = wordMaker.getRandomName("system");
                            }
                            var tcoord = XYCoordToTCoord(x,y);
                            namesSoFar[name] = {hexlocation:tcoord,x:x,y:y};
                            var details = generateSystemDetails(addCaps(name), ggFrequency,permitDieback,maxTechLevel);
                            for(var i = 0, len = mins.length; i < len; i++){
                                var currValue;
                                if(i === 8){
                                    currValue = details.importance.extension;
                                    //if(currValue > currMax){ maxes[i] = currValue;}
                                }else{
                                    currValue = details.mainworld[labels[i]];
                                    var currMin = mins[i], currMax = maxes[i];
                                    if(currValue < currMin){ mins[i] = currValue;}
                                    if(currValue > currMax){ maxes[i] = currValue;}
                                }
                                
                            }
                            var system = {                                    
                                name: addCaps(name),
                                mainworld:details.mainworld,
                                uwp: details.uwp.toUpperCase(),
                                gg:details.gg,
                                isAsteroidBelt:details.mainworld.isAsteroidBelt,
                                planetoidBelts:details.planetoidBelts,
                                bases:details.bases,
                                stars:details.stars,
                                importance: details.importance,
                                tcoord: tcoord
                            };
                            systems[tcoord] = system;
                            systemArray.push(system);
                        }
                    }
                }
                
                analyzeMap(systemArray);
                document.getElementById("data").value = JSON.stringify(systems);
                var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, systems);
                applyTravelCodes(mapContent);
                drawMap(mapContent);                
            }
            function analyzeMap(systemArray){
                var capital, maxImportance = -4, tradeCodeCount = 0;
                var uwpSums = [0,0,0,0,0,0,0], 
                uwpMins = [null,null,null,null,null,null,null], 
                uwpMaxes = [null,null,null,null,null,null,null];
                var ixSum = 0, ixMin = 5, ixMax = -3;
                var labels = ["size","atmo","hydro","pop","gov","law","tech"];
                var tracker = {"size":{},"atmo":{},"hydro":{},"pop":{},"gov":{},"law":{},"tech":{}};
                for(var i = 0, len = systemArray.length; i < len; i++){
                    var system = systemArray[i];
                    var mainworld = system.mainworld;
                    for(var j = 0, jlen = labels.length; j < jlen; j++){
                        var label = labels[j];
                        var value = mainworld[label];
                        uwpSums[j] += value;
                        if(tracker[label][value]){
                            tracker[label][value] += 1;
                        }else{
                            tracker[label][value] = 1;
                        }
                        if(uwpMins[j] === null || value < uwpMins[j]){ uwpMins[j] = value; }
                        if(uwpMaxes[j] === null || value > uwpMaxes[j]){ uwpMaxes[j] = value; }
                    }
                    if(system.importance.isImportant){
                        var importance = system.importance.extension;
                        if(system.isRed){importance -= 3; }
                        if(system.isAmber){importance -= 1; }
                        if(mainworld.starport === "A"){ importance += 1; }
                        var xy = TCoordToXYCoord(system.tcoord);
                        var desiredXFromBorder = SUBSECTOR_WIDTH/8;
                        var desiredYFromBorder = SUBSECTOR_HEIGHT/8;
                        var withinDesiredXRange = (xy.x > desiredXFromBorder && xy.x < SUBSECTOR_WIDTH - desiredXFromBorder);
                        var withinDesiredYRange = (xy.y > desiredYFromBorder && xy.y < SUBSECTOR_HEIGHT - desiredYFromBorder);
                        if(withinDesiredXRange){
                            importance += 1;
                        }else{
                            importance -=1;
                        }
                        if(withinDesiredYRange){
                                importance += 1;
                        }else{
                            importance -= 1;
                        }
                        if(withinDesiredXRange && withinDesiredYRange){
                            importance += 1;
                        }
                        if(importance > maxImportance){
                            capital = system;
                            maxImportance = importance;
                            tradeCodeCount = capital.mainworld.tradecodes.length | 0;
                        }else if(importance === maxImportance){
                            if(system.tradecodes && system.tradecodes.length > tradeCodeCount){
                                capital = system;
                                maxImportance = importance;
                            }
                        }
                    }
                    // throw in the Mongoose tech codes for good measure
                    var tech = mainworld.tech;
                    if(tech >= 12){ system.mainworld.tradecodes.push("Ht");}
                    else if(tech <= 5 ){ system.mainworld.tradecodes.push("Lt");}    
                    if(mainworld.tradecodes.indexOf("Cy") > 0){
                        // figure out the colony owner here!
                    }              
                }
                if(capital){
                    capital.isCapital = true;
                    capital.mainworld.tradecodes.push("Cp");
                    capital.mainworld.tradecodes.sort();
                }
               
            }
            
            function generateHexes(x,y, systems){
                var systemsPredefined = true;
                if(typeof systems == "undefined"){
                    _systems = {};
                    systemsPredefined = false;
                }else{
                    _systems = systems;
                }
                mapContent = [];
                for(var iy = 0; iy < y; iy++){
                    for(var ix = 0; ix < x; ix++){
                        var hexLabel = XYCoordToTCoord(ix,iy);
                        var system = _systems[hexLabel];
                        addHex(ix,iy,system);
                    }
                }
                return mapContent;
            }
            function addHex(x,y,system){
                mapContent.push({
                    x:x,
                    y:y,
                    system:system
                });
            }
            function coordsInHexagon(x,y,hex){
                
                var numVertices = hex.vertx.length;
                var isInside = false;
                for(var i = 0, j = numVertices-1; i < numVertices; j = i++){
                    if(((hex.verty[i] > y) != (hex.verty[j] > y )) && 
                    ( x < (hex.vertx[j] - hex.vertx[i]) * (y - hex.verty[i])/(hex.verty[j] -hex.verty[i]) + hex.vertx[i])){
                        isInside = !isInside;
                    }
                }
                return isInside;
            }
            function drawMap(mapContent, options){
                if(typeof options === "undefined"){
                    options = { 
                        heatMap: +(document.getElementById("slcHeatMap").value),
                        travelCodes: document.getElementById("chkShowTravelCodes").checked
                    };
                }
                ctx.textAlign = "center";
                var fontSize = HEX_SIZE*1/3;
                ctx.font = ""+fontSize+"pt "+FONT;
                var w =canvas.width, h =canvas.height;
                ctx.clearRect(0,0,w,h);
                if(CANVAS_BACKGROUND_COLOR !== "transparent"){
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                    ctx.fillRect(0,0,w,h);
                }
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.translate(HEX_MATH.diameter + CANVAS_PADDING, HEX_MATH.diameter + CANVAS_PADDING);
                for(var i = 0, len = mapContent.length; i < len; i++){
                    mapContent[i] = drawHex(mapContent[i], options);
                }
                for(var i = 0, len = mapContent.length; i < len; i++){
                    drawFinal(mapContent[i], options);
                }
                ctx.restore();
                document.getElementById("data").value = JSON.stringify(_systems);
            }
            function selectT5TravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "Amber");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "Red");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                //document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "Red");
           
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "Red");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "N/A");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "N/A");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function selectCETravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "N/A");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "N/A");
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "Amber");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "Amber");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "Amber");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "Amber");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "Amber");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function resetTravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "Amber");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 12);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "Red");
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "Red");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "N/A");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = true;
            }
            function applyTravelCodes(mapContent, highestLawLevel){
                var RedGovLaw = document.getElementById("slctRedGovLaw").value;
                var AmberDieback = document.getElementById("slctAmberDieback").value;
                var AmberGovLaw = document.getElementById("slctAmberGovLaw").value;
                var RedGovLawThreshold = document.getElementById("slctRedGovLawThreshold").value;
                var DangerousAtmoThreshold = document.getElementById("slctDangerousAtmoThreshold").value;
                var AmberGovLawThreshold = document.getElementById("slctAmberGovLawThreshold").value;
                var RedZoneX = document.getElementById("slctRedZoneX").value;
                var AmberZoneBa = document.getElementById("slctAmberZoneBa").value;
                var AmberZoneBaX = document.getElementById("slctAmberZoneBaX").value;
                var AmberZoneAtmo = document.getElementById("slctAmberZoneAtmo").value;
                var AmberZoneLL = document.getElementById("slctAmberZoneLL").value;
                var AmberZone9LL = document.getElementById("slctAmberZone9LL").value;
                var LLThreshold = document.getElementById("slctLawLevelThreshold").value;
                var MaxLLThreshold = document.getElementById("slctMaxLawLevelThreshold").value;
                var AmberZone0LL = document.getElementById("slctAmberZone0LL").value;
                var AmberZoneGov0 = document.getElementById("slctAmberZoneGov0").value;
                var AmberZoneGov7 = document.getElementById("slctAmberZoneGov7").value;
                var AmberZoneGov10 = document.getElementById("slctAmberZoneGov10").value;
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null){
                        mapContent[i].system.isAmber = false;
                        mapContent[i].system.isRed = false;
                        mapContent[i].system.travelcodenotes = "";
                        if(mapContent[i].system.mainworld.pop > 0){
                            if(AmberZoneLL !== "N/A"){ // amber zone highest law level
                                if(mapContent[i].system.mainworld.law === maxes[6] && maxes[6] >= MaxLLThreshold) {
                                    if(AmberZoneLL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Among strictest law levels in the subsector.  ";
                                }
                            }
                            if(AmberZone9LL !== "N/A"){ // amber zone 9+ law level 
                                if(mapContent[i].system.mainworld.law >= LLThreshold) {
                                    if(AmberZone9LL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Law levels "+LLThreshold.toString()+"+.  ";
                                }
                            }
                            if(AmberZone0LL !== "N/A"){ // amber zone 0 law level
                                if(mapContent[i].system.mainworld.law === 0) {
                                    if(AmberZone0LL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "No law level enforced.  ";
                                }
                            }
                           
                            if(AmberZoneGov0 !== "N/A"){ // amber ungoverned
                                if(mapContent[i].system.mainworld.gov === 0) {
                                    if(AmberZoneGov0 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Anarchy.  ";
                                }
                            }
                            if(AmberZoneGov7 !== "N/A"){ // amber balkanized
                                if(mapContent[i].system.mainworld.gov === 7) {
                                    if(AmberZoneGov7 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Balkanized local governments.  ";
                                }
                            }
                            if(AmberZoneGov0 !== "N/A"){ // amber charismatic dictatorship
                                if(mapContent[i].system.mainworld.gov === 10) {
                                    if(AmberZoneGov0 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Ruled by charismatic dictatorship.  ";
                                }
                            }
                            if(RedZoneX !== "N/A" && mapContent[i].system.mainworld.starport.toUpperCase() === "X"){ // red no starport
                                if(RedZoneX === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelcodenotes += "Population under interdiction.  ";
                            }
                            if(RedGovLaw !== "N/A"){
                                if(mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law >= RedGovLawThreshold){
                                    if(RedGovLaw === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Oppressive government.  ";
                                }
                                
                            }
                            if(AmberGovLaw !== "N/A"){
                                if(mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law >= AmberGovLawThreshold){
                                    if(AmberGovLaw === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Oppressive government.  ";
                                }
                                
                            }
                        }else{
                            if(AmberZoneBa !== "N/A" && mapContent[i].system.mainworld.tech === 0){ // amber zone uninhabited
                                
                                if(AmberZoneBa === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelcodenotes += "Barren/Uninhabited.  ";
                                
                            }
                            if(AmberZoneBaX !== "N/A" && mapContent[i].system.starport === "X"){ // amber zone uninhabited
                                
                                if(AmberZoneBaX === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                if(mapContent[i].system.mainworld.tech <=5){
                                    mapContent[i].system.travelcodenotes += "Protected population. No starport facilities.  ";
                                }else{
                                    mapContent[i].system.travelcodenotes += "Under interdiction. No starport facilities.  ";
                                }
                                
                            }
                            if(AmberDieback !== "N/A" && mapContent[i].system.mainworld.tech > 0){
                                if(AmberDieback === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                if(mapContent[i].system.mainworld.starport === "E"){
                                    mapContent[i].system.travelcodenotes += "Archaeological site (dieback world).  ";
                                }else{
                                    mapContent[i].system.travelcodenotes += "Dieback world.  ";
                                }
                            }
                        }
                        if(AmberZoneAtmo !== "N/A"){ // amber 10+ atmo
                            if(mapContent[i].system.mainworld.atmo >= DangerousAtmoThreshold) {
                                if(AmberZoneAtmo === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelcodenotes += "Dangerous atmosphere.  ";
                            }
                        }
                        if(mapContent[i].system.isRed){
                            mapContent[i].system.travelcodenotes = "RED ZONE: "+mapContent[i].system.travelcodenotes;
                        }else if(mapContent[i].system.isAmber){
                            mapContent[i].system.travelcodenotes = "AMBER ZONE: "+mapContent[i].system.travelcodenotes;
                        }
                    }
                }
            }
            function clearTravelCodes(mapContent){
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null){
                        mapContent[i].system.isRed = false;
                        mapContent[i].system.isAmber = false;
                    }
                }
            }
            function TCoordToXYCoord(tcoord){
                if(tcoord.length && tcoord.length == 4){
                    var col = tcoord.substring(0,2);
                    var row = tcoord.substring(2,4);
                    if(row[0] == "0"){row = row[1];}
                    if(col[0] == "0"){col = col[1];}
                    return{x:+(col)-1,y:+(row)-1}
                }
            }
            function XYCoordToTCoord(x,y){
                var col = (+(x)+1).toString();
                if(+(x)+1 < 10){col = "0"+col;}
                var row = (+(y)+1).toString();
                if(+(y)+1 < 10){row = "0"+row;}
                return col+row;
            }
            function drawHex(hex, options){
                var drawMode = -1;
                if(typeof options.heatMap !== "undefined"){ drawMode = options.heatMap; }
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                var coords = {
                    x:hex.x*HEX_MATH.xOffset,
                    y:hex.x%2 == 0 ? hex.y*HEX_MATH.yOffset : hex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                };
                var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                    x2 = coords.x+HEX_MATH.radius; // top/bottom right vertex
                var x0 = x1 - HEX_MATH.radius, // center left vertex
                    x3 = x2 + HEX_MATH.radius, // center right vertex
                    x4 = x1 + (x2-x1)/2; // middle of the bottom edge
                var y0 = coords.y - HEX_MATH.diameter, 
                    y1 = coords.y,
                    y2 = y1 + HEX_MATH.diameter;
                ctx.strokeStyle = HEX_BORDER_COLOR;
                var oldLineWidth = ctx.lineWidth;
                
                ctx.beginPath();
                ctx.moveTo(x4,y2);
                hex.vertx = [x4,x2,x3,x2,x1,x0,x1,x4];
                hex.verty = [y2,y2,y1,y0,y0,y1,y2,y2];
                for(var i = 1; i < hex.vertx.length; i++){
                    ctx.lineTo(hex.vertx[i], hex.verty[i]);
                }
                ctx.stroke();
                ctx.fillStyle = HEX_BACKGROUND_COLOR;           
                ctx.fill();
                
                if(containsSystem){
                    if(drawMode >= 0){
                        var heatMapValue = 0;
                        var bgColor = "black";
                        var minValue = mins[drawMode], maxValue = maxes[drawMode];
                        switch(drawMode){
                            case 0: // starport
                                switch(hex.system.mainworld.starport){
                                    case "A": bgColor = "rgb(255,0,0)"; break; 
                                    case "B": bgColor = "rgb(200,0,50)"; break; 
                                    case "C": bgColor = "rgb(150,0,100)"; break; 
                                    case "D": bgColor = "rgb(100,0,150)"; break; 
                                    case "E": bgColor = "rgb(50,0,200)"; break; 
                                    case "X": bgColor = "rgb(0,0,205)";  break; 
                                }
                                
                            break;
                            case 1: heatMapValue = hex.system.mainworld.size; 
                            break;
                            case 2: heatMapValue = hex.system.mainworld.atmo; 
                            break;
                            case 3: heatMapValue = hex.system.mainworld.hydro; 
                            break;
                            case 4: heatMapValue = hex.system.mainworld.pop; break;
                            case 5: heatMapValue = hex.system.mainworld.gov; break;
                            case 6: heatMapValue = hex.system.mainworld.law; break;
                            case 7: heatMapValue = hex.system.mainworld.tech; break;
                            case 8: heatMapValue = hex.system.importance.extension; break;
                        }
                        if(drawMode > 0){
                            var bValue = 200 - 200*((heatMapValue - minValue) / (maxValue - minValue)) >>> 0; 
                            var rValue = 255*((heatMapValue - minValue) / (maxValue - minValue)) >>> 0; 
                            bgColor = "rgb("+rValue+",0,"+bValue+")";
                        }
                        ctx.fillStyle = bgColor;
                        ctx.fill();
                    }
                    
                    if(hex.selected || hex.highlighted){
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if(ctx.strokeStyle.length === 7){
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if(hex.selected){                    
                            ctx.lineWidth = inc;
                        }else if(hex.highlighted){
                            ctx.lineWidth = inc/2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2,tx3,tx2,];//tx1,tx0,tx1];
                        var verty = [ty2,y1,ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1,tx0,tx1];
                        var verty = [ty0,y1,ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                    var zoneRadius = fontSize*5;
                    if(options.travelCodes && (hex.system.isRed || hex.system.isAmber)){

                        if(hex.system.isRed){
                            ctx.strokeStyle = "red";
                        }else if(hex.system.isAmber){
                            ctx.strokeStyle = "yellow";
                        }
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(x4,y1,zoneRadius,-Math.PI/2,Math.PI/4);
                        ctx.stroke();
            
                        ctx.beginPath();
                        ctx.arc(x4,y1,zoneRadius,-5*Math.PI/4,-Math.PI/2);
                        ctx.stroke();
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        
                    }

                    
                    if(hex.system.gg > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x2,y1-(y1-y0)/2,fontSize/2,0,2*Math.PI);
                        ctx.fill();
                    }
                    for(var i = 0, len = hex.system.bases.length; i < len; i++){
                        var base = hex.system.bases[i];
                        drawBase(base, x4, y1);
                    }
                    
                    // draw planet
                    if(hex.system.isAsteroidBelt){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2.5,y1 - (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/9,y1,fontSize/6,0,2*Math.PI);
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/5,y1 - (y1-y0)/11,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/6,y1 + (y1-y0)/9,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/2.5,y1 + (y1-y0)/18,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2,y1 ,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/8,y1 - (y1-y0)/6,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/7,y1 + (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                    }else if(hex.system.mainworld.hydro > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.fill();
                    }else{
                        ctx.strokeStyle = TEXT_COLOR; 
                        ctx.lineWidth  = HEX_SIZE/10;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                    }                    

                    // write starport
                    var oldFont = ctx.font;
                    ctx.font = ""+(fontSize*1.2)+"pt "+FONT;
                    ctx.fillStyle = TEXT_COLOR; 
                    ctx.fillText(hex.system.uwp[0],x4,y0 + (y1-y0)/2);
                    ctx.font = oldFont;
                    
                    
                    
                }
                else{
                    if(hex.selected || hex.highlighted){
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if(ctx.strokeStyle.length === 7){
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if(hex.selected){                    
                            ctx.lineWidth = inc;
                        }else if(hex.highlighted){
                            ctx.lineWidth = inc/2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2,tx3,tx2,];//tx1,tx0,tx1];
                        var verty = [ty2,y1,ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1,tx0,tx1];
                        var verty = [ty0,y1,ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                }
                
                ctx.lineWidth = oldLineWidth;
                return hex;
            }
            function drawFinal(hex, options){
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                if(containsSystem){

                    var coords = {
                        x:hex.x*HEX_MATH.xOffset,
                        y:hex.x%2 == 0 ? hex.y*HEX_MATH.yOffset : hex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                    };
                    var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                    x2 = coords.x+HEX_MATH.radius; // top/bottom right vertex
                    var x0 = x1 - HEX_MATH.radius, // center left vertex
                    x3 = x2 + HEX_MATH.radius, // center right vertex
                    x4 = x1 + (x2-x1)/2; // middle of the bottom edge
                    var y0 = coords.y - HEX_MATH.diameter, 
                    y1 = coords.y,
                    y2 = y1 + HEX_MATH.diameter;
                    var maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                    var name = hex.system.name;
                    var oldFontStyle = ctx.font;
                    if(hex.system.importance.isImportant){ 
                        ctx.font = "bold "+ oldFontStyle;
                        name = name.toUpperCase();
                    }
                    if(hex.system.mainworld.pop >= 9){
                        //ctx.font = "small-caps "+ oldFontStyle;
                        name = name.toUpperCase();
                    }
                    var lines = [];
                    if(ctx.measureText(name).width > maxWidth){
                        var words = name.split(" ");
                        var lineSoFar = "";
                        for(var i = words.length-1; i >= 0; i--){
                            var proposal = lineSoFar.length > 0 ? words[i] + " " + lineSoFar : words[i];
                            if(ctx.measureText(proposal).width < maxWidth){
                                lineSoFar = proposal;
                            }else{
                                if(lineSoFar.length > 0){
                                    lines.push(lineSoFar);
                                }
                                lineSoFar = words[i];
                            }
                            maxWidth += fontSize;
                        }
                        if(lineSoFar.length > 0){lines.push(lineSoFar);}
                    }else{
                        lines = [name];
                    }
                    // write text
                    ctx.textAlign = "center";
                    if(hex.system.isCapital){
                        ctx.fillStyle = CAPITAL_TEXT_COLOR;                    
                        ctx.font = "bold "+ oldFontStyle;
                        ctx.strokeStyle = CAPITAL_BACKGROUND_COLOR;
                        ctx.lineWidth = fontSize/8;
                    }else{
                        ctx.fillStyle = TEXT_COLOR;
                    }
                    maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                    var height = y2 - lines.length*fontSize;
                    var oldLineWidth = ctx.lineWidth;
                    for(var i = lines.length-1; i >= 0; i--){    
                        if(hex.system.isCapital){
                            ctx.lineWidth = fontSize/8;
                            ctx.strokeText(lines[i], x4, height, maxWidth);
                            ctx.lineWidth = oldLineWidth;
                        }                 
                        ctx.fillText(lines[i], x4, height, maxWidth);
                        
                        height += fontSize+(fontSize/4);
                    }
                    ctx.font = oldFontStyle;
                    if(hex.selected || hex.highlighted){
                        ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                        var backStyle = ctx.fillStyle;
                        
                        ctx.fillStyle = TEXT_COLOR; 
                        // write UWP
                        ctx.beginPath();
                        var oldGlobalCompositeOperation = ctx.globalCompositeOperation;
                        ctx.globalCompositeOperation = 'source-over';
                        var uwp = hex.system.uwp.toUpperCase();
                        var uwpSize = ctx.measureText(uwp);
                        ctx.fillStyle = backStyle;
                        var fontHeight = uwpSize.fontBoundingBoxAscent + uwpSize.fontBoundingBoxDescent;
                        ctx.fillRect(x4-uwpSize.width/2,y1-fontHeight/2-2,uwpSize.width,fontSize+2);
                        ctx.fillStyle = TEXT_COLOR; 
                        ctx.fillText(uwp,x4,y1);
                        // write trade codes
                        maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                        var codes = hex.system.mainworld.tradecodes.join(" ");
                        var codesSize = ctx.measureText(codes);
                        lines = [codes];
                        if(codesSize.width > maxWidth){
                            var line1 = hex.system.mainworld.tradecodes.slice(0,hex.system.mainworld.tradecodes.length/2>>0).join(" ");
                            var line2 = hex.system.mainworld.tradecodes.slice(hex.system.mainworld.tradecodes.length/2>>0).join(" ");
                            lines = [line1, line2]
                        }
                        height = y1 + fontHeight;
                        var blockHeight = y1 + fontHeight/2 - 2;
                        for(var i = lines.length-1; i >= 0; i--){ 
                            var lineWidth = ctx.measureText(lines[i]).width;
                            ctx.fillStyle = backStyle;
                            ctx.fillRect(x4-lineWidth/2,blockHeight,lineWidth,fontSize+2);
                            ctx.fillStyle = TEXT_COLOR; 
                            ctx.fillText(lines[i], x4, height, maxWidth);
                            height += fontSize+(fontSize/3);
                            blockHeight += fontSize+(fontSize/3);
                        }
                        ctx.globalCompositeOperation = oldGlobalCompositeOperation;
                    }
                }
            }
            function drawBase(baseType, hexX, hexY){
                switch(baseType){
                    case "Scout":
                        var scale = fontSize/2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.moveTo(hexX - scale*8, hexY + scale*4);
                        ctx.lineTo(hexX - scale*6, hexY + scale*4);
                        ctx.lineTo(hexX - scale*7, hexY + scale*2);
                        ctx.lineTo(hexX - scale*8, hexY + scale*4);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case "Naval":
                        var scale = fontSize/2;
                        drawStar(hexX - scale*5, hexY - scale*5, 5, scale*0.7, scale*1.7);
                        break;
                    case "Naval Depot":
                        var scale = fontSize/2;
                        strokeStar(hexX - scale*5, hexY - scale*5, 5, scale*0.7, scale*1.7);
                        break;
                    case "Way Station":
                    var scale = fontSize/2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.moveTo(hexX - scale*8, hexY + scale*4);
                        ctx.lineTo(hexX - scale*6, hexY + scale*4);
                        ctx.lineTo(hexX - scale*7, hexY + scale*2);
                        ctx.lineTo(hexX - scale*8, hexY + scale*4);
                        ctx.closePath();
                        var oldLineWidth = ctx.lineWidth;
                        ctx.lineWidth = 1;
                        ctx.strokeStyle =TEXT_COLOR;
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                        break;
                }
            }
            function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    
                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)                    
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                ctx.fillStyle=TEXT_COLOR;
                ctx.fill();
            }
            function strokeStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    
                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)                    
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                var oldLineWidth = ctx.lineWidth;
                ctx.lineWidth = 1;
                ctx.strokeStyle =TEXT_COLOR;
                ctx.stroke();
                ctx.lineWidth = oldLineWidth;
            }
            function updateStyle(){
                var select = document.getElementById("slctStyle");
                var val = select.value;
                if(val === "custom"){
                    document.getElementById("hexBorderColor").value = select.getAttribute("data-hexfg");
                    document.getElementById("hexBackgroundColor").value = select.getAttribute("data-hexbg");
                    document.getElementById("canvasBackgroundColor").value = select.getAttribute("data-canvasbg");
                    document.getElementById("textColor").value = select.getAttribute("data-text");
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                   
                }else if(val === "light"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "white";
                    document.getElementById("textColor").value = "black";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "dark"){
                    document.getElementById("hexBorderColor").value = "white";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "black";
                    document.getElementById("textColor").value = "white";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "transparent"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "transparent";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                    document.getElementById("textColor").value = "black";
                }
                updateHexBorderColor(document.getElementById("hexBorderColor").value);
                updateHexBackgroundColor(document.getElementById("hexBackgroundColor").value);
                updateCanvasBackgroundColor(document.getElementById("canvasBackgroundColor").value);
                updateTextColor(document.getElementById("textColor").value);
                updateFont(document.getElementById("fontFamily").value);
                drawMap(mapContent);
            }
            function updateFont(newFont){
                FONT = newFont;
                ctx.font = ""+fontSize+"pt " + newFont;
            }
            function updateHexSize(newSize){
                HEX_SIZE = newSize;
                HEX_MATH.radius = HEX_SIZE;
                HEX_MATH.xOffset = HEX_SIZE*3;
                HEX_MATH.yOffset = HEX_SIZE*4;
                HEX_MATH.diameter = HEX_SIZE*2;
                canvas.setAttribute("width",SUBSECTOR_WIDTH * HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
                canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter+CANVAS_PADDING*2);
                fontSize = (newSize*1/3);
                ctx.font = ""+fontSize+"pt " + FONT;
                document.getElementById("sizeIndicator").innerHTML = newSize;
            }
            function updateHexBorderColor(newColor){
                HEX_BORDER_COLOR = newColor;
            }
            function updateHexBackgroundColor(newColor){
                HEX_BACKGROUND_COLOR = newColor;
            }
            function updateCanvasBackgroundColor(newColor){
                CANVAS_BACKGROUND_COLOR = newColor;
            }
            function updateTextColor(newColor){
                TEXT_COLOR = newColor;
            }
            function addCaps(text) {
                var capitalizedString = "";
                var lastCharacter = null, currCharacter = " ";
                for (var i = 0, len = text.length; i < len; i++) {
                    lastCharacter = currCharacter;
                    currCharacter = text[i];
                    if (lastCharacter === " " || lastCharacter === "-") {
                        capitalizedString += currCharacter.toUpperCase();
                    } else {
                        capitalizedString += currCharacter;
                    }
                }
                return capitalizedString;
            }
        
            function renderSystem(system){
                var lookups = {
                    tradecode:{
                        "As":"Asteroid Belt",
                        "De":"Desert",
                        "Fl":"Fluid Oceans",
                        "Ga":"Garden World",
                        "He":"Hellworld",
                        "Ic":"Ice-Capped",
                        "Oc":"Ocean World",
                        "Va":"Vacuum",
                        "Wa":"Water World",
                        "Sa":"Satellite (far satellite)",
                        "Lk":"Locked (close satellite)",
                        "Di":"Dieback",
                        "Ba":"Barren",
                        "Lo":"Low Population",
                        "Ni":"Non-Industrial",
                        "Ph":"Pre-High Population",
                        "Hi":"High Population",
                        "Pa":"Pre-Agricultural",
                        "Ag":"Agricultural",
                        "Na":"Non-Agricultural",
                        "Px":"Prison or Exile Camp",
                        "Pi":"Pre-Industrial",
                        "In":"Industrial",
                        "Po":"Poor",
                        "Pr":"Pre-Rich",
                        "Ri":"Rich",
                        "Fr":"Frozen",
                        "Ho":"Hot",
                        "Co":"Cold",
                        "Tr":"Tropic",
                        "Tu":"Tundra",
                        "Tz":"Twilight Zone",
                        "Cp":"Capital",
                        "Cy":"Colony",
                        "Lt":"Low Tech",
                        "Ht":"High Tech"
                    }
                };
            var systemTokens = document.querySelectorAll("[data-system]");
            for(var i = 0, len = systemTokens.length; i < len; i++){
                var el = systemTokens[i];
                var key = el.getAttribute("data-system");
                var val = {};
                if(typeof system[key] === "string"){
                    val = system[key];
                }else{
                    Object.assign(val,system[key]);
                    if(el.getAttribute("data-lookup")){
                        var keys = Object.keys(val);
                        for(var i = 0, len = keys.length; i < len; i++){
                            if(lookups[el.getAttribute("data-lookup")][val[keys[i]]]){
                                val[keys[i]] = lookups[el.getAttribute("data-lookup")][val[keys[i]]];
                            }
                        }
                    }
                    if(el.getAttribute("data-join")){
                        if(!val.join){
                            val = Object.values(val);
                        }
                        val = val.join(el.getAttribute("data-join"));
                    }
                }
                if(val.toString() === ""){
                    if(el.getAttribute("data-ifblank")){
                        val = el.getAttribute("data-ifblank");
                    }
                }
                el.innerHTML = val;
            }
            var mainworldTokens = document.querySelectorAll("[data-mainworld]");
            for(var i = 0, len = mainworldTokens.length; i < len; i++){
                var el = mainworldTokens[i];
                var key = el.getAttribute("data-mainworld");
                var val = {};
                if(typeof system.mainworld[key] === "string"){
                    val = system.mainworld[key];
                }else{
                    Object.assign(val,system.mainworld[key]);
                    if(el.getAttribute("data-lookup")){
                        var keys = Object.keys(val);
                        for(var i = 0, len = keys.length; i < len; i++){
                            if(lookups[el.getAttribute("data-lookup")][val[keys[i]]]){
                                val[keys[i]] = lookups[el.getAttribute("data-lookup")][val[keys[i]]];
                            }
                        }
                    }
                }
                if(el.getAttribute("data-join")){
                    if(!val.join){
                        val = Object.values(val);
                    }
                    val = val.join(el.getAttribute("data-join"));
                }
                el.innerHTML = val;
            }
            var importanceTokens = document.querySelectorAll("[data-importance]");
            for(var i = 0, len = importanceTokens.length; i < len; i++){
                var el = importanceTokens[i];
                var key = el.getAttribute("data-importance");
                el.innerHTML = system.importance[key];
                
            }
            var list = document.getElementById("maplist");
            clearElement(list);
            var description = system.stars.primary.type + (typeof system.stars.primary.decimal === "undefined" ? "" : system.stars.primary.decimal.toString()) + system.stars.primary.size;
            list.appendChild(document.createElement("li")).appendChild(document.createTextNode(
                "Primary Star: " + description
            ))
            for(var i = 0, len = system.stars.primary.satellites.length; i < len; i++){
                var slot = system.stars.primary.satellites[i];
                if(slot && typeof slot !== "undefined"){
                    var description = "";
                    var orbitingStar = false;
                    if(slot.worldtype.indexOf("star") >= 0){
                        orbitingStar = true;
                        if(slot.type === "BD"){
                            description = "Brown Dwarf";
                        }else{
                            description = slot.type + (typeof slot.decimal === "undefined" ? "" : slot.decimal.toString()) + slot.size ;
                        }
                    }else{
                        orbitingStar = false;
                        description = slot.uwp;
                        if(typeof description === "undefined"){ console.log(slot);}
                    }
                    var li = list.appendChild(document.createElement("li"));
                    li.appendChild(document.createTextNode(
                        "Orbit "+i+": "+addCaps(slot.worldtype) + " ("+ description + ")"+(slot.isMainworld?"**":"")
                    ));
                    if(slot.isMainworld){li.style.fontWeight = "bold";}
                    if(slot.satellites){
                        var subOrbitingStar = false;
                        var sublist = list.appendChild(document.createElement("ul"));
                        for(var j = 0, jlen = slot.satellites.length; j < jlen; j++){
                            if(typeof slot.satellites[j] !== "undefined"){
                                var subslot = slot.satellites[j];
                                var desc = "";
                                if(subslot.worldtype.indexOf("star") >= 0){
                                    subOrbitingStar = true;
                                    if(subslot.type === "BD"){
                                        desc = "Brown Dwarf";
                                    }else{
                                        desc = subslot.type + (typeof subslot.decimal === "undefined" ? "" : subslot.decimal.toString()) + subslot.size ;
                                    }
                                }else{
                                    subOrbitingStar = false;
                                    desc = subslot.uwp;
                                }
                                var text = "";
                                if(!orbitingStar){
                                    text = "Orbit " +sat(j)+": " + addCaps(subslot.worldtype) +" ("+desc+")" +(subslot.isMainworld?"**":"");
                                }else{
                                    text =  "Orbit " +j+": " + addCaps(subslot.worldtype) +" ("+desc+")" +(subslot.isMainworld?"**":"")
                                }
                                var li = sublist.appendChild(document.createElement("li"));
                                li.appendChild(document.createTextNode(text));
                                if(subslot.isMainworld){ li.style.fontWeight = "bold"; }
                                
                                if(subslot.satellites){
                                    subsublist = sublist.appendChild(document.createElement("ul"));
                                    for(var k = 0, klen = subslot.satellites.length; k < klen; k++){
                                        var subsub = subslot.satellites[k];
                                        if(typeof subsub !== "undefined"){
                                            desc = subsub.uwp;
                                            var text = "";
                                            if(subOrbitingStar){                                               
                                                text = "Orbit " + k + ": " +addCaps(subsub.worldtype) + " ("+desc+")"+(subsub.isMainworld?"**":"");
                                                
                                            }else{
                                                text = "Orbit " + sat(k) + ": " +addCaps(subsub.worldtype) + " ("+desc+")"+(subsub.isMainworld?"**":"");                                                
                                            }
                                            var li = subsublist.appendChild(document.createElement("li"))
                                            li.appendChild(document.createTextNode(text));
                                            if(subsub.isMainworld){li.style.fontWeight = "bold";}
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            console.log(system);
        }
        function sat(i){
            var orbits = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
            return orbits[i];
        }        
        function clearElement(el){
            while(el.children.length > 0){
                el.removeChild(el.children[el.children.length-1]);
            }
        }
        })();
    </script>
</body>
</html>