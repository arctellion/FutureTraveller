<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveller</title>
</head>
<body>
    <style>
        fieldset{
            font-family:'Consolas','Inconsolas','Courier New', Courier, monospace;
            display:inline-block;
            vertical-align: text-top;
        }
        fieldset legend{
            cursor:pointer;
            user-select: none;
        }
        fieldset legend:hover{
            color:red;
        }
        fieldset.collapsed *:not(legend){
            display:none;
        }
        fieldset > legend::before{
            content:"▼ ";
        }
        fieldset.collapsed > legend::before{
            content:"► ";
        }
        canvas{
            border:1px solid black;
            background-color:white;
        }
    </style>
    <fieldset>
        <legend>Controls</legend>
        <fieldset class="collapsed">
            <legend>Display</legend>
            <label for="slctStyle">Style: </label><select name="slctStyle" id="slctStyle" data-text="white" data-canvasbg="black" data-hexfg="cyan" data-hexbg="rgba(0,200,255,0.2)">
                <option value="light">light</option>
                <option value="dark">dark</option>
                <option value="transparent">transparent</option>
                <option selected="selected" value="custom">custom</option>
            </select>
            <label for="sizeSlider">Scale: <span id="sizeIndicator"></span></label><input type="range" min="4" max="50" id="sizeSlider" />
            <br/><br/><fieldset id="customSettings" class="collapsed">
                <legend>Custom Display Settings</legend>
                <label for="textColor">Text Color: <input type="text" name="textColor" id="textColor" /></label><br/>
                <label for="hexBorderColor">Border Color: <input type="text" name="hexBorderColor" id="hexBorderColor" /></label><br/>
                <label for="hexBackgroundColor">Hex Fill: <input type="text" id="hexBackgroundColor" name="hexBackgroundColor" /></label><br/>
                <label for="canvasBackgroundColor">Background Color: <input type="text" name="canvasBackgroundColor" id="canvasBackgroundColor" /></label><br/>
                <label for="fontFamily">Font: <input type="text" id="fontFamily" name="fontFamily" value="Segoe UI, sans-serif"/></label>
            </fieldset>
        </fieldset>
        <fieldset class="collapsed">
            <legend>Systems</legend>
            <label for="slctStellarDensity"><select name="slctStellarDensity" id="slctStellarDensity">
                <option value="Extra Galactic">Extra Galactic (1%)</option>
                <option value="Rift">Rift (3%)</option>
                <option value="Sparse">Sparse (17%)</option>
                <option value="Scattered">Scattered (33%)</option>
                <option value="Standard" selected="selected">Standard (50%)</option>
                <option value="Dense">Dense (66%)</option>
                <option value="Cluster">Cluster (83%)</option>
                <option value="Core">Core (91%)</option>
            </select></label>
            <label for="btnPopulateSystems"><input type="button" id="btnPopulateSystems" name="btnPopulateSystems" value="Populate Subsector"></label>
        </fieldset>
    </fieldset>
    <br/>
    <canvas id="canvas"></canvas>
    <br/>
    <fieldset>
        <legend>Data</legend>
        <textarea name="data" id="data" cols="30" rows="10"></textarea>
        <input type="button" value="Apply" id="btnApplyData">
    </fieldset>
    <script src="NameGenerator.js"></script>
    <script>
        (function(){
            //globals
            var wordMaker;
            var HEX_SIZE = 27,
                HEX_BORDER_COLOR = "white",
                HEX_BACKGROUND_COLOR = "rgba(0,0,0,0.7)",
                HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)",
                CANVAS_BACKGROUND_COLOR = "rgb(50,50,50)",
                TEXT_COLOR = "white",
                CANVAS_PADDING = 20,
                SUBSECTOR_WIDTH = 8,
                SUBSECTOR_HEIGHT = 10,
                FONT = "sans-serif";
            var HEX_MATH = {
                radius:HEX_SIZE,
                xOffset:HEX_SIZE*3,
                yOffset:HEX_SIZE*4,
                diameter:HEX_SIZE*2
            }
            var fontSize = HEX_SIZE*1/3;
            var _systems = {};
            NameGenerator("names.jsonc",function(o){wordMaker = o;});
            var canvas = document.getElementById("canvas");
            canvas.setAttribute("width",SUBSECTOR_WIDTH*HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
            canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter + CANVAS_PADDING*2);
            var ctx = canvas.getContext('2d');
            
            var mapContent = [];
            document.getElementById("sizeSlider").value = HEX_SIZE;
            mapContent = generateHexes(SUBSECTOR_WIDTH,SUBSECTOR_HEIGHT);
            updateStyle();
            ctx.font = ""+fontSize+"pt "+FONT;
            drawMap(mapContent);
            attachEventListeners();

            function attachEventListeners(){
                canvas.addEventListener("mousemove",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(coordsInHexagon(e.clientX,e.clientY, hex)){
                            hex.highlighted = true;
                        }else{
                            if(hex.highlighted){
                                hex.highlighted = false;
                            }
                        }
                    }
                    drawMap(mapContent);
                });
                canvas.addEventListener("click",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(coordsInHexagon(e.clientX,e.clientY, hex)){
                            if(hex.selected){
                                hex.selected = false;}
                            else{
                                hex.selected = true;
                            }
                        }else{
                            if(hex.selected){
                                hex.selected = false;
                            }
                        }
                    }
                    drawMap(mapContent);
                });
                canvas.addEventListener("mouseout",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(hex.highlighted){
                            hex.highlighted = false;
                        }
                    }
                    drawMap(mapContent);
                });
                var collapserHandles = document.querySelectorAll("fieldset legend");
                for(var i = 0, len = collapserHandles.length; i < len; i++){
                    var handle = collapserHandles[i];
                    handle.addEventListener("click",function(e){
                        var parent = e.target.parentElement;
                        if(parent.classList.contains("collapsed")){
                            parent.classList.remove("collapsed");
                        }else{
                            parent.classList.add("collapsed");
                        }
                    });
                }
                document.getElementById("slctStyle").addEventListener("change",updateStyle);
                document.getElementById("sizeSlider").addEventListener("change",function(){
                    updateHexSize(+(document.getElementById("sizeSlider").value));
                    drawMap(mapContent);
                });
                document.getElementById("fontFamily").addEventListener("keyup",updateStyle);
                document.getElementById("hexBorderColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBorderColor").value;
                    updateHexBorderColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexfg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("textColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("textColor").value;
                    updateTextColor(newColor);
                    drawMap(mapContent);
                });
                document.getElementById("hexBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBackgroundColor").value;
                    updateHexBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("canvasBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("canvasBackgroundColor").value;
                    updateCanvasBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-canvasbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyData").addEventListener("click",function(){
                    var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, JSON.parse(document.getElementById("data").value));
                    drawMap(mapContent);
                });
                document.getElementById("btnPopulateSystems").addEventListener("click",function(){
                    var density = document.getElementById("slctStellarDensity").value;
                    var d = 1, target = 3, systems = {};
                    switch(density){
                        case "Extra Galactic": d = 3, target = 3; break;
                        case "Rift": d = 2, target = 2; break;
                        case "Sparse": d = 1, target = 1; break;
                        case "Scattered": d = 1, target = 2; break;
                        case "Standard": d = 1, target = 3; break;
                        case "Dense": d = 1, target = 4; break;
                        case "Cluster": d = 1, target = 5; break;
                        case "Core": d = 2, target = 11; break;
                    }
                    var namesSoFar = {};
                    for(var x = 0; x < SUBSECTOR_WIDTH; x++){
                        for(var y = 0; y < SUBSECTOR_HEIGHT; y++){
                            if(d6(d) <= target){
                                var name = wordMaker.getRandomName("system");
                                while(Object.keys(namesSoFar).indexOf(name) >= 0){
                                    name = wordMaker.getRandomName("system");
                                }
                                var tcoord = XYCoordToTCoord(x,y);
                                namesSoFar[name] = {hexlocation:tcoord,x:x,y:y};
                                var details = generateSystemDetails();
                                systems[tcoord] = {                                    
                                    name: addCaps(name),
                                    mainworld:details.mainworld,
                                    uwp: details.uwp,
                                    gg:details.gg,
                                    isAsteroidBelt:details.mainworld.isAsteroidBelt,
                                    planetoidBelts:details.planetoidBelts,
                                    bases:details.bases,
                                    stars:details.stars
                                };
                            }
                        }
                    }
                    document.getElementById("data").value = JSON.stringify(systems);
                    var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, systems);
                    drawMap(mapContent);
                })
            }
            function generateSystemDetails(){
                var isAsteroidBelt = d6(2) == 2;
                var planetoidBelts = Math.max(d6()-3,0);
                var gg = d6(2)>=8 ? Math.max(d6(2)/2>>0-2,1) : 0;
                var roll;
                var uwp = "";
                var tradeCodes = [];
                var stars = {primary:{},primary_companion:false,close:false,near:false, near_companion:false,close_companion:false,far:false, far_companion:false};
                var primaryType = d6()-d6(),
                    primaryDecimal = d09(),
                    primarySize = d6()-d6();
                stars.primary = getStar(primaryType,primaryDecimal,primarySize);
                if(d6()-d6()>=3){ 
                    stars.primary_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    
                }
                if(d6()-d6()>=3){ 
                    stars.close = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    stars.close.orbit = d6()-1;
                    if(d6()-d6()>=3){ 
                        stars.close_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    }
                }
                if(d6()-d6()>=3){ 
                    stars.near = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    stars.near.orbit = 5 + d6();
                    if(d6()-d6()>=3){ 
                        stars.near_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    }
                }
                if(d6()-d6()>=3){ 
                    stars.far = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    stars.far.orbit = 11 + d6();
                    if(d6()-d6()>=3){ 
                        stars.far_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    }
                }
                roll = d6()-d6(); // roll for mainworld orbit
                
                var MWOrbit = stars.primary.HZOrbit; var climate = "";
                
                if(stars.primary.type === "M"){roll += 2;}
                else if(stars.primary.type === "O" || stars.primary.type === "B"){ roll -= 2;}

                if(roll<=-6){ MWOrbit -= 2; tradeCodes.push("Tr"); climate = "Hot. Tropic.";}
                else if(roll <= -3){ MWOrbit -=1; tradeCodes.push("Tr"); climate = "Hot. Tropic.";}
                else if(roll <= 2){ MWOrbit = stars.primary.HZOrbit; climate = "Temperate."; }
                else if(roll <= 5){ MWOrbit += 1; tradeCodes.push("Tu"); climate = "Cold. Tundra.";}
                else if(roll >= 6){ MWOrbit += 2; tradeCodes.push("Fr"); climate = "Frozen.";}
                var bases = [];
                roll = d6(2); // roll for starport
                var starport;
                if(roll <= 4){
                    uwp = starport = "A";
                    if(d6(2)<=6){ bases.push("Naval");}
                    if(d6(2)<=4){ bases.push("Scout");}
                }
                else if(roll <= 6){
                    uwp = starport = "B";
                    if(d6(2)<=5){ bases.push("Naval");}
                    if(d6(2)<=5){ bases.push("Scout");}
                }
                else if(roll <= 8){
                    uwp = starport = "C";
                    if(d6(2)<=6){bases.push("Scout");}
                }
                else if(roll == 9){
                    uwp = starport = "D";
                    if(d6(2)<=7){bases.push("Scout");}
                }
                else if(roll <= 11){
                    uwp = starport = "E";
                }
                else if(roll == 12){
                    uwp = starport = "X";
                }
                // roll for size
                var size = d6(2)-2; 
                if(size === 10){ size = d6()+9; }
                uwp += size.toString(16);
                //roll for atmosphere
                var atmo = d6()-d6()+size;
                if(atmo < 0 || size === 0){ atmo = 0;}
                if(atmo > 15){atmo = 15;}
                uwp += atmo.toString(16);
                //roll for hydro
                var hydroMods = 0;
                if(atmo < 2 || atmo > 9){hydroMods = 4;}
                var hydro = d6()-d6()+atmo+hydroMods;
                if(size < 2 || hydro < 0){hydro = 0;}
                if(hydro > 10){hydro = 10;}
                uwp += hydro.toString(16);
                // roll for pop
                var pop = d6(2)-2;
                if(pop === 10){ pop = d6(2)+3;}
                uwp += pop.toString(16);
                // roll for gov
                var gov = d6()-d6()+pop;
                if(gov > 15){gov = 15;}
                if(gov < 0){gov = 0;}
                if(pop === 0){gov = 0;}
                uwp += gov.toString(16);
                // roll for law
                var law = d6()-d6()+gov;
                if(law < 0){law = 0;}
                if(law > 18){law = 18;}
                if(law === 0){gov = 0;}
                uwp += law.toString(16);
                // roll for TL
                var tech = d6();
                if(starport === "A"){tech+=6;}
                else if(starport === "B"){tech+=4;}
                else if(starport === "C"){tech+=2;}

                if(size <= 1){tech += 2;}
                else if(size <= 4){tech += 1;}

                if(atmo <= 3){tech += 1;}
                else if(atmo >= 10){tech += 1;}

                if(hydro === 9){tech += 1;}
                else if(hydro === 10){tech += 2;}
                
                if(pop <= 5){ tech += 1; }
                else if(pop === 9){ tech += 2;}
                else if(pop >= 10){ tech += 4;}

                if(gov === 0 || gov === 5){ tech += 1;}
                else if(gov === 13){ tech -= 2;}
                if(pop === 0 || tech < 0){tech = 0;}
                
                uwp += "-"+tech.toString(16);
                // roll to see if the world is a satellite
                roll = d6()-d6();
                var MWType, MWPrimary, MWOrbitAroundPrimary;
                if(roll <=4){ 
                    MWType = "Far Satellite";
                    roll = d6() - d6();
                    if(roll === -5){ MWOrbitAroundPrimary = "Oh"; }
                    else if(roll === -4){ MWOrbitAroundPrimary = "Pee"; }
                    else if(roll === -3){ MWOrbitAroundPrimary = "Que"; }
                    else if(roll === -2){ MWOrbitAroundPrimary = "Arr"; }
                    else if(roll === -1){ MWOrbitAroundPrimary = "Ess"; }
                    else if(roll === 0){ MWOrbitAroundPrimary = "Tee"; }
                    else if(roll === 1){ MWOrbitAroundPrimary = "Yu"; }
                    else if(roll === 2){ MWOrbitAroundPrimary = "Vee"; }
                    else if(roll === 3){ MWOrbitAroundPrimary = "Dub"; }
                    else if(roll === 4){ MWOrbitAroundPrimary = "Ex"; }
                    else if(roll === 5){ MWOrbitAroundPrimary = "Wye"; }
                }
                else if(roll <= 3){ 
                    MWType = "Close Satellite";
                    if(roll === -5){ MWOrbitAroundPrimary = "Bee"; }
                    else if(roll === -4){ MWOrbitAroundPrimary = "Cee"; }
                    else if(roll === -3){ MWOrbitAroundPrimary = "Dee"; }
                    else if(roll === -2){ MWOrbitAroundPrimary = "Ee"; }
                    else if(roll === -1){ MWOrbitAroundPrimary = "Eff"; }
                    else if(roll === 0){ MWOrbitAroundPrimary = "Gee"; }
                    else if(roll === 1){ MWOrbitAroundPrimary = "Aitch"; }
                    else if(roll === 2){ MWOrbitAroundPrimary = "Eye"; }
                    else if(roll === 3){ MWOrbitAroundPrimary = "Jay"; }
                    else if(roll === 4){ MWOrbitAroundPrimary = "Kay"; }
                    else if(roll === 5){ MWOrbitAroundPrimary = "Ell"; }
                }
                else{ MWType = "Planet"; MWPrimary = "Star"; MWOrbitAroundPrimary = MWOrbit; }
                if(MWType !== "Planet"){
                    if(gg >= 1 && d6()-d6() <= 0){
                            MWPrimary = "Gas Giant";
                    }else{
                        MWPrimary = "Planet";
                    }
                }
                return {uwp:uwp,bases:bases,stars:stars,gg:gg,planetoidBelts:planetoidBelts, mainworld:{size:size, atmo:atmo, hydro:hydro, pop:pop, gov:gov, law:law, tech:tech, primary:MWPrimary,climate:climate,orbitAroundPrimary:MWOrbitAroundPrimary, isAsteroidBelt:isAsteroidBelt,orbit:MWOrbit,starport:starport},tradeCodes:tradeCodes};
            }
            function getStar(type, decimal, size){
                var star = {};
                if(type == -6){ 
                    if(d6() == 1){
                        star.type =  "O";
                        if(size <= -5){ star.size = "Ia"; star.HZOrbit = 15;}
                        else if(size <= -4){ star.size = "Ib"; star.HZOrbit = 15;}
                        else if(size <= -3){ star.size = "II"; star.HZorbit = 14; }
                        else if(size <= 0){ star.size = "III"; star.HZOrbit = 13;}
                        else if(size <= 3){ star.size = "V"; star.HZOrbit = 11;}
                        else if(size <= 4){ star.size = "IV"; star.HZOrbit = 12;}
                        else if(size <= 5){ star.size = "D"; star.HZOrbit = 1;}
                        else{ star.size = "IV"; star.HZOrbit = 12;}
                    }else{
                        star.type = "B";
                        if(size <= -5){ star.size = "Ia"; star.HZOrbit = 13;}
                        else if(size <= -4){ star.size = "Ib"; star.HZOrbit = 13;}
                        else if(size <= -3){ star.size = "II"; star.HZOrbit = 12; }
                        else if(size <= 1){ star.size = "III"; star.HZOrbit = 11; }
                        else if(size <= 3){ star.size = "V"; star.HZOrbit = 9;}
                        else if(size <= 4){ star.size = "IV"; star.HZOrbit = 10;}
                        else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                        else{ star.size = "IV";star.HZOrbit = 10;}
                    }
                }
                else if(type <= -4){ 
                        star.type = "A"; 
                        if(size <= -5){ star.size = "Ia"; star.HZOrbit = 12; }
                        else if(size <= -4){ star.size = "Ib"; star.HZOrbit = 11;}
                        else if(size <= -3){ star.size = "II";star.HZOrbit = 9; }
                        else if(size <= -2){ star.size = "III"; star.HZOrbit = 7;}
                        else if(size <= -1){ star.size = "IV"; star.HZOrbit = 7;}
                        else if(size <= 4){ star.size = "V";star.HZOrbit = 7;}
                        else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                        else{ star.size = "V";star.HZOrbit = 7;}
                }
                else if(type <= -2){ 
                    star.type = "F"; 
                    if(size <= -5){ star.size = "II"; star.HZOrbit = 9;}
                    else if(size <= -4){ star.size = "III";star.HZOrbit = 6; }
                    else if(size <= -3){ star.size = "IV"; star.HZOrbit = 6;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 5;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 3;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 3;}
                }
                else if(type <= 0){ 
                    star.type = "G"; 
                    if(size <= -5){ star.size = "II"; star.HZOrbit = 9;}
                    else if(size <= -4){ star.size = "III"; star.HZOrbit = 7;}
                    else if(size <= -3){ star.size = "IV"; star.HZOrbit = 5;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 3;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 2;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 3;}
                }
                else if(type <= 2){ 
                    star.type = "K"; 
                    if(size <= -5){ star.size = "II"; star.HZOrbit = 9;}
                    else if(size <= -4){ star.size = "III"; star.HZOrbit = 8;}
                    else if(size <= -3){ star.size = "IV"; star.HZOrbit = 5;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 2;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 1;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 1;}
                }
                else if(type <= 5){ 
                    star.type = "M"; 
                    if(size <= -3){ star.size = "II"; star.HZOrbit = 10;}
                    else if(size <= -2){ star.size = "III"; star.HZOrbit = 9;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 0;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 0;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 0;}
                }
                else{ star.type = "BD"; }
                if(star.size !== "D"){star.decimal = decimal;}
                return star;
            }
            function d6(num){
                if(!num){ num = 1;}
                var sum = 0;
                for(var i = 0; i < num; i++){
                    sum += (Math.random()*6 >>> 0) + 1;
                }
                return sum;
            }
            function d09(){
                //returns 0-9 even distribution
                var r1=d6(),r2=d6(),x;
                while(r1==6){r1=d6();}
                x = (r1-1) * 2;
                if(r2 >= 4){x+=1;}
                return x;
            }
            function generateHexes(x,y, systems){
                var systemsPredefined = true;
                if(typeof systems == "undefined"){
                    _systems = {};
                    systemsPredefined = false;
                }else{
                    _systems = systems;
                }
                mapContent = [];
                for(var iy = 0; iy < y; iy++){
                    for(var ix = 0; ix < x; ix++){
                        var hexLabel = XYCoordToTCoord(ix,iy);
                        var system = _systems[hexLabel];
                        addHex(ix,iy,system);
                    }
                }
                return mapContent;
            }
            function addHex(x,y,system){
                mapContent.push({
                    x:x,
                    y:y,
                    system:system
                });
            }
            function coordsInHexagon(x,y,hex){
                x = x - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                y = y - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                var numVertices = hex.vertx.length;
                var isInside = false;
                for(var i = 0, j = numVertices-1; i < numVertices; j = i++){
                    if(((hex.verty[i] > y) != (hex.verty[j] > y )) && 
                    ( x < (hex.vertx[j] - hex.vertx[i]) * (y - hex.verty[i])/(hex.verty[j] -hex.verty[i]) + hex.vertx[i])){
                        isInside = !isInside;
                    }
                }
                return isInside;
            }
            function drawMap(mapContent){
                var w =canvas.width, h =canvas.height;
                ctx.clearRect(0,0,w,h);
                if(CANVAS_BACKGROUND_COLOR !== "transparent"){
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                    ctx.fillRect(0,0,w,h);
                }
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.translate(HEX_MATH.diameter + CANVAS_PADDING, HEX_MATH.diameter + CANVAS_PADDING);
                for(var i = 0, len = mapContent.length; i < len; i++){
                    mapContent[i] = drawHex(mapContent[i]);
                }
                ctx.restore();
                document.getElementById("data").value = JSON.stringify(_systems);
            }
            function TCoordToXYCoord(tcoord){
                if(tcoord.length && tcoord.length == 4){
                    var col = tcoord.substring(0,2);
                    var row = tcoord.substring(2,4);
                    if(row[0] == "0"){row = row[1];}
                    if(col[0] == "0"){col = col[1];}
                    return{x:+(col)-1,y:+(row)-1}
                }
            }
            function XYCoordToTCoord(x,y){
                var col = (x+1).toString();
                if(x < 10){col = "0"+col;}
                var row = (y+1).toString();
                if(y < 10){row = "0"+row;}
                return col+row;
            }
            function drawHex(hex){
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                var coords = {
                    x:hex.x*HEX_MATH.xOffset,
                    y:hex.x%2 == 0 ? hex.y*HEX_MATH.yOffset : hex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                };
                var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                    x2 = coords.x+HEX_MATH.radius; // top/bottom right vertex
                var x0 = x1 - HEX_MATH.radius, // center left vertex
                    x3 = x2 + HEX_MATH.radius, // center right vertex
                    x4 = x1 + (x2-x1)/2; // middle of the bottom edge
                var y0 = coords.y - HEX_MATH.diameter, 
                    y1 = coords.y,
                    y2 = y1 + HEX_MATH.diameter;
                ctx.strokeStyle = HEX_BORDER_COLOR;
                var oldLineWidth = ctx.lineWidth;
                if(hex.selected){                    
                    ctx.lineWidth = 10;
                }else if(hex.highlighted){
                    ctx.lineWidth = 5;
                }
                ctx.beginPath();
                ctx.moveTo(x4,y2);
                hex.vertx = [x4,x2,x3,x2,x1,x0,x1,x4];
                hex.verty = [y2,y2,y1,y0,y0,y1,y2,y2];
                for(var i = 1; i < hex.vertx.length; i++){
                    ctx.lineTo(hex.vertx[i], hex.verty[i]);
                }
                ctx.stroke();
                //if(hex.highlighted){
                //    ctx.fillStyle = HEX_HIGHLIGHT_BACKGROUND_COLOR;
                //}else{
                    ctx.fillStyle = HEX_BACKGROUND_COLOR;
                //}              
                ctx.fill();

                if(containsSystem){
                    var maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                    var name = hex.system.name;
                    var maxChars = 10;
                    var lines = [];
                    if(ctx.measureText(name).width > maxWidth){
                        var words = name.split(" ");
                        var lineSoFar = "";
                        for(var i = words.length-1; i >= 0; i--){
                            var proposal = lineSoFar.length > 0 ? words[i] + " " + lineSoFar : words[i];
                            if(ctx.measureText(proposal).width < maxWidth){
                                lineSoFar = proposal;
                            }else{
                                if(lineSoFar.length > 0){lines.push(lineSoFar);}
                                if(ctx.measureText(words[i]).width > maxWidth){
                                    var mid = words[i].length/2>>0
                                    lines.push(words[i].substring(mid))
                                    lineSoFar = words[i].substring(0,mid)+"-";
                                }else{
                                    lineSoFar = words[i];
                                }
                            }
                            maxWidth += fontSize;
                        }
                        if(lineSoFar.length > 0){lines.push(lineSoFar);}
                    }else{
                        lines = [name];
                    }
                    if(hex.system.gg > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x2,y1-(y1-y0)/2,fontSize/2,0,2*Math.PI);
                        ctx.fill();
                    }

                    // draw planet
                    if(hex.system.isAsteroidBelt){
                        ctx.fillStyle = TEXT_COLOR; //"orange"; 
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2.5,y1 - (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();

                        //ctx.fillStyle = "yellow";
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/9,y1,fontSize/6,0,2*Math.PI);
                        ctx.fill();

                        //ctx.fillStyle = "magenta";
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/5,y1 - (y1-y0)/11,fontSize/6,0,2*Math.PI);
                        ctx.fill();

                        //ctx.fillStyle = "cyan";
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/6,y1 + (y1-y0)/9,fontSize/6,0,2*Math.PI);
                        ctx.fill();

                        //ctx.fillStyle = "yellow";
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/2.5,y1 + (y1-y0)/18,fontSize/6,0,2*Math.PI);
                        ctx.fill();

                        //ctx.fillStyle = "black";
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2,y1 ,fontSize/6,0,2*Math.PI);
                        ctx.fill();

                        //ctx.fillStyle = "orange";
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/8,y1 - (y1-y0)/6,fontSize/6,0,2*Math.PI);
                        ctx.fill();

                        //ctx.fillStyle = "red";
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/7,y1 + (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                    }else if(hex.system.mainworld.hydro > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.fill();
                    }else{
                        ctx.strokeStyle = TEXT_COLOR; 
                        ctx.lineWidth  = HEX_SIZE/10;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                    }
                    

                    // write text
                    ctx.textAlign = "center";
                    ctx.fillStyle = TEXT_COLOR;                    
                    var maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                    var height = y2 - lines.length*fontSize;
                    for(var i = lines.length-1; i >= 0; i--){
                        var altMaxWidth = lines[i].length * fontSize;
                        ctx.fillText(lines[i], x4, height, maxWidth);
                        height += fontSize+(fontSize/4);
                        maxWidth -= fontSize;
                    }
                    
                    // write starport
                    var oldFont = ctx.font;
                    ctx.font = ""+(fontSize*1.2)+"pt "+FONT;
                    ctx.fillText(hex.system.uwp[0],x4,y0 + (y1-y0)/2);
                    ctx.font = oldFont;

                    if(hex.selected || hex.highlighted){
                        // write UWP
                        ctx.beginPath();
                        var oldGlobalCompositeOperation = ctx.globalCompositeOperation;
                        ctx.globalCompositeOperation = 'source-over';
                        var uwp = hex.system.uwp.toUpperCase();
                        var uwpSize = ctx.measureText(uwp);
                        ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                        var fontHeight = uwpSize.fontBoundingBoxAscent + uwpSize.fontBoundingBoxDescent;
                        ctx.fillRect(x4-uwpSize.width/2,y1-fontHeight/2-2,uwpSize.width,fontSize+2);
                        ctx.fillStyle = TEXT_COLOR; 
                        ctx.fillText(uwp,x4,y1);
                        ctx.globalCompositeOperation = oldGlobalCompositeOperation;
                    }
                    
                }

                ctx.lineWidth = oldLineWidth;
                return hex;
            }
            function updateStyle(){
                var select = document.getElementById("slctStyle");
                var val = select.value;
                if(val === "custom"){
                    document.getElementById("hexBorderColor").value = select.getAttribute("data-hexfg");
                    document.getElementById("hexBackgroundColor").value = select.getAttribute("data-hexbg");
                    document.getElementById("canvasBackgroundColor").value = select.getAttribute("data-canvasbg");
                    document.getElementById("textColor").value = select.getAttribute("data-text");
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                   
                }else if(val === "light"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "white";
                    document.getElementById("textColor").value = "black";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "dark"){
                    document.getElementById("hexBorderColor").value = "white";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "black";
                    document.getElementById("textColor").value = "white";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "transparent"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "transparent";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                    document.getElementById("textColor").value = "black";
                }
                updateHexBorderColor(document.getElementById("hexBorderColor").value);
                updateHexBackgroundColor(document.getElementById("hexBackgroundColor").value);
                updateCanvasBackgroundColor(document.getElementById("canvasBackgroundColor").value);
                updateTextColor(document.getElementById("textColor").value);
                updateFont(document.getElementById("fontFamily").value);
                drawMap(mapContent);
            }
            function updateFont(newFont){
                FONT = newFont;
                ctx.font = ""+fontSize+"pt " + newFont;
            }
            function updateHexSize(newSize){
                HEX_SIZE = newSize;
                HEX_MATH.radius = HEX_SIZE;
                HEX_MATH.xOffset = HEX_SIZE*3;
                HEX_MATH.yOffset = HEX_SIZE*4;
                HEX_MATH.diameter = HEX_SIZE*2;
                canvas.setAttribute("width",SUBSECTOR_WIDTH * HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
                canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter+CANVAS_PADDING*2);
                fontSize = (newSize*1/3);
                ctx.font = ""+fontSize+"pt " + FONT;
                document.getElementById("sizeIndicator").innerHTML = newSize;
            }
            function updateHexBorderColor(newColor){
                HEX_BORDER_COLOR = newColor;
            }
            function updateHexBackgroundColor(newColor){
                HEX_BACKGROUND_COLOR = newColor;
            }
            function updateCanvasBackgroundColor(newColor){
                CANVAS_BACKGROUND_COLOR = newColor;
            }
            function updateTextColor(newColor){
                TEXT_COLOR = newColor;
            }
            function addCaps(text) {
                var capitalizedString = "";
                var lastCharacter = null, currCharacter = " ";
                for (var i = 0, len = text.length; i < len; i++) {
                    lastCharacter = currCharacter;
                    currCharacter = text[i];
                    if (lastCharacter === " " || lastCharacter === "-") {
                        capitalizedString += currCharacter.toUpperCase();
                    } else {
                        capitalizedString += currCharacter;
                    }
                }
                return capitalizedString;
            }
        })();
    </script>
</body>
</html>