<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveller</title>
</head>
<body>
    <style>
        fieldset{
            font-family:'Consolas','Inconsolas','Courier New', Courier, monospace;
            display:inline-block;
            vertical-align: text-top;
        }
        fieldset legend{
            cursor:pointer;
            user-select: none;
        }
        fieldset legend:hover{
            color:red;
        }
        label{
            user-select: none;
        }
        fieldset > fieldset{
            background-color:rgba(0,0,0,0.05);
        }
        fieldset *{
            line-height:1.5em;
        }
        fieldset.collapsed *:not(legend){
            display:none;
        }
        fieldset > legend::before{
            content:"▼ ";
        }
        fieldset.collapsed > legend::before{
            content:"► ";
        }
        canvas{
            border:1px solid black;
            background-color:white;
        }
        .travelcodepickers select option[value="Amber"] {
            background: rgb(255, 255, 127);
        }
        .travelcodepickers select[data-color="Amber"]{
            background-color: rgb(255, 255, 127);;
        }
        .travelcodepickers select option[value="Red"] {
            background: pink;
        }
        .travelcodepickers select[data-color="Red"]{
            background-color: pink;
        }
    </style>
    <fieldset>
        <legend>Controls</legend>
        <fieldset class="collapsed">
            <legend>Appearance</legend>                
            <label for="sizeSlider">Scale: <span id="sizeIndicator"></span></label><input type="range" min="4" max="50" id="sizeSlider" />
            <label for="slctStyle">Theme: </label><select name="slctStyle" id="slctStyle" data-text="white" data-canvasbg="black" data-hexfg="cyan" data-hexbg="rgba(0,200,255,0.2)">
                <option value="light">light</option>
                <option value="dark">dark</option>
                <option value="transparent">transparent</option>
                <option selected="selected" value="custom">custom</option>
            </select>
            <br/>                
            <fieldset id="customSettings" class="collapsed">
                <legend>Advanced</legend>
                <label for="textColor">Text Color: <input type="text" name="textColor" id="textColor" /></label><br/>
                <label for="hexBorderColor">Border Color: <input type="text" name="hexBorderColor" id="hexBorderColor" /></label><br/>
                <label for="hexBackgroundColor">Hex Fill: <input type="text" id="hexBackgroundColor" name="hexBackgroundColor" /></label><br/>
                <label for="canvasBackgroundColor">Background Color: <input type="text" name="canvasBackgroundColor" id="canvasBackgroundColor" /></label><br/>
                <label for="fontFamily">Font: <input type="text" id="fontFamily" name="fontFamily" value="Segoe UI, sans-serif"/></label>
            </fieldset>
        </fieldset>
        <fieldset class="collapsed">
            <legend>Overlays</legend>
            <label for="slcHeatMap">Heat Map: <select name="slcHeatMap" id="slcHeatMap">
                <option value="-1" selected=selected>No Heatmap</option>
                <option value="0">Starport</option>
                <option value="1">Size</option>
                <option value="2">Atmosphere</option>
                <option value="3">Hydrography</option>
                <option value="4">Population</option>
                <option value="5">Government Type</option>
                <option value="6">Law Level</option>
                <option value="7">Tech Level</option>
                <option value="8">Importance</option>
            </select>
        </label><br/>
        <label for="chkShowTravelCodes"><input type="checkbox" name="chkShowTravelCodes" id="chkShowTravelCodes" checked="checked"/> Show Travel Codes</label>
        </fieldset>        
        <fieldset class="collapsed">
            <legend>Systems</legend>          
            <label for="btnPopulateSystems"><input type="button" id="btnPopulateSystems" name="btnPopulateSystems" value="Populate Subsector"></label>
            <label for="btnClearSystems"><input type="button" id="btnClearSystems" name="btnClearSystems" value="Clear Subsector"></label>
            <br/><fieldset class="collapsed">
                <legend>Configuration</legend>
                <fieldset class="collapsed">
                    <legend>Astrographics</legend>
                    <label for="slctMainworldRules">System Gen Ruleset: 
                        <select name="slctMainworldRules" id="slctMainworldRules">
                            <option value="T5">T5</option>
                        </select></label><br/>
                    <label for="slctStellarDensity">Stellar Density: <select name="slctStellarDensity" id="slctStellarDensity">
                        <option value="Extra Galactic">Extra Galactic (1%)</option>
                        <option value="Rift">Rift (3%)</option>
                        <option value="Sparse">Sparse (17%)</option>
                        <option value="Scattered">Scattered (33%)</option>
                        <option value="Standard" selected="selected">Standard (50%)</option>
                        <option value="Dense">Dense (66%)</option>
                        <option value="Cluster">Cluster (83%)</option>
                        <option value="Core">Core (91%)</option>
                    </select></label><br/>
                    <label for="slctGGFrequency">Gas Giant Occurrence: <select name="slctGGFrequency" id="slctGGFrequency">
                        <option selected=selected value=8>8- on 2D (T5) 72%</option>
                        <option value=9>9- on 2D (CE) 83%</option>
                    </select></label><br/>
                    <label for="chkPermitDieback" title="Dieback worlds have 0 population but TL>0"><input checked="checked" type="checkbox" name="chkPermitDieback" id="chkPermitDieback" /> Permit Dieback Worlds</label>
                    <br/><label for="slctDiebackTLPenalty">Uninhabited world TL -<select name="slctDiebackTLPenalty" id="slctDiebackTLPenalty">
                        <option value=5>5</option>
                        <option value=4>4</option>
                        <option value=3>3</option>
                        <option selected="selected" value=2>2</option>
                        <option value=1>1</option>
                        <option value=0>0</option>
                    </select></label>
                </fieldset>
                <fieldset class="collapsed travelcodepickers">
                    <legend>Travel Zones</legend>
                    <input type="button" value="Remove travel codes" id="btnClearTravelCodes" />
                    <fieldset>
                        <legend>Automatic Assignment</legend>
                        <input type="button" disabled=true value="Apply travel zones" id="btnApplyTravelCodes" />
                        <input type="button" disabled=true value="Thriggle Defaults" id="btnResetTravelCodes">
                        <input type="button" value="CE Defaults" id="btnCETravelCodes">
                        <input type="button" value="T5 Defaults" id="btnT5TravelCodes">
                        <br/>
                        <fieldset class="collapsed">
                            <legend>Habitation</legend>
                            <label for="slctRedZoneX" title="Pop>0 but Starport=X"><select data-color="Red" name="slctRedZoneX"  id="slctRedZoneX">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option selected="selected" value="Red">Red</option>
                            </select> Inhabited w/out Starport</label><br/>
                            <label for="slctAmberZoneBa" title="Barren worlds have 0 population and TL=0"><select data-color="Amber" name="slctAmberZoneBa"  id="slctAmberZoneBa">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Barren Worlds </label><br/>
                            <label for="slctAmberZoneBaX" title="Pop=0 and Starport=X"><select data-color="N/A" name="slctAmberZoneBaX"  id="slctAmberZoneBaX">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Uninhabited w/out Starport</label><br/>
                            <label for="slctAmberDieback" title="Dieback worlds have 0 population but TL>0"><select data-color="Red" name="slctAmberDieback" id="slctAmberDieback">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option selected="selected" value="Red">Red</option>
                            </select> Dieback Worlds </label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Atmosphere</legend>
                            <label for="slctAmberZoneAtmo"><select data-color="Amber" name="slctAmberZoneAtmo" id="slctAmberZoneAtmo">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Dangerous Atmospheres (<select id="slctDangerousAtmoThreshold">
                                <option value=10>10</option>
                                <option value=11>11</option>
                                <option selected="selected" value=12>12</option>
                            </select>+)</label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Law Level</legend>
                            <label for="slctRedGovLaw"><select name="slctRedGovLaw" data-color="Amber" id="slctRedGovLaw">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Law + Government >= <select id="slctRedGovLawThreshold">
                                <option value=30>30</option>
                                <option value=29>29</option>
                                <option value=28>28</option>
                                <option value=27>27</option>
                                <option value=26>26</option>
                                <option value=25>25</option>
                                <option value=24>24</option>
                                <option value=23>23</option>
                                <option selected=selected value=22>22</option>
                                <option value=21>21</option>
                                <option value=20>20</option>
                                <option value=19>19</option>
                            </select></label><br/>
                            <label for="slctAmberGovLaw"><select name="slctAmberGovLaw" data-color="N/A" id="slctAmberGovLaw">
                                <option selected="selected" value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Law + Government >= <select id="slctAmberGovLawThreshold">
                                <option value=30>30</option>
                                <option value=29>29</option>
                                <option value=28>28</option>
                                <option value=27>27</option>
                                <option value=26>26</option>
                                <option value=25>25</option>
                                <option value=24>24</option>
                                <option value=23>23</option>
                                <option value=22>22</option>
                                <option value=21>21</option>
                                <option selected=selected value=20>20</option>
                                <option value=19>19</option>
                            </select></label><br/>
                            <label for="slctAmberZoneLL"><select name="slctAmberZoneLL" data-color="N/A" id="slctAmberZoneLL">
                                <option selected="selected" value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Highest LL World(s) (min <select id="slctMaxLawLevelThreshold">
                                <option value=15>15</option>
                                <option value=14>14</option>
                                <option value=13>13</option>
                                <option value=12>12</option>
                                <option value=11>11</option>
                                <option value=10>10</option>
                                <option selected=selected value=9>9</option>
                                <option value=8>8</option>
                            </select>+)</label><br/>
                            <label for="slctAmberZone9LL"><select data-color="N/A" name="slctAmberZone9LL" id="slctAmberZone9LL">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> High Law (<select id="slctLawLevelThreshold">
                                <option value=15>15</option>
                                <option value=14>14</option>
                                <option value=13>13</option>
                                <option value=12>12</option>
                                <option value=11>11</option>
                                <option value=10>10</option>
                                <option selected=selected value=9>9</option>
                                <option value=8>8</option>
                            </select>+) Worlds </label><br/>
                            <label for="slctAmberZone0LL"><select data-color="N/A" name="slctAmberZone0LL" id="slctAmberZone0LL">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Lawless Worlds</label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Government</legend>
                            <label for="slctAmberZoneGov0"><select data-color="N/A" name="slctAmberZoneGov0" id="slctAmberZoneGov0">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Ungoverned Worlds</label><br/>
                            <label for="slctAmberZoneGov7"><select data-color="N/A" name="slctAmberZoneGov7" id="slctAmberZoneGov7">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Balkanized Worlds</label><br/>
                            <label for="slctAmberZoneGov10"><select data-color="N/A" name="slctAmberZoneGov10" id="slctAmberZoneGov10">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Charismatic Dictatorships</label><br/>
                        </fieldset>
                        
                    </fieldset>
                   
                </fieldset>
            </fieldset>
            
        </fieldset>
    </fieldset>
    <br/>
    <canvas id="canvas"></canvas>
    <br/>
    <fieldset>
        <legend>Data</legend>
        <textarea name="data" id="data" cols="30" rows="10"></textarea>
        <input type="button" value="Apply" id="btnApplyData">
    </fieldset>
    <script src="NameGenerator.js"></script>
    <script>
        (function(){
            //globals
            var wordMaker;
            var HEX_SIZE = 27,
                HEX_BORDER_COLOR = "white",
                HEX_BACKGROUND_COLOR = "rgba(0,0,0,0.7)",
                HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)",
                CANVAS_BACKGROUND_COLOR = "rgb(50,50,50)",
                TEXT_COLOR = "white",
                CANVAS_PADDING = 20,
                SUBSECTOR_WIDTH = 8,
                SUBSECTOR_HEIGHT = 10,
                FONT = "sans-serif";
            var HEX_MATH = {
                radius:HEX_SIZE,
                xOffset:HEX_SIZE*3,
                yOffset:HEX_SIZE*4,
                diameter:HEX_SIZE*2
            }
            var fontSize = HEX_SIZE*1/3;
            var mins = [-1,-1,-1,-1,-1,-1,-1,-1,-3], 
            maxes = [0,0,0,0,0,0,0,0,5], 
            labels = ["starport","size","atmo","hydro","pop","gov","law","tech"];
            var _systems = {};
            
            var canvas = document.getElementById("canvas");
            canvas.setAttribute("width",SUBSECTOR_WIDTH*HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
            canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter + CANVAS_PADDING*2);
            var ctx = canvas.getContext('2d');
            
            var mapContent = [];
            document.getElementById("sizeSlider").value = HEX_SIZE;
            mapContent = generateHexes(SUBSECTOR_WIDTH,SUBSECTOR_HEIGHT);
            updateStyle();
            ctx.font = ""+fontSize+"pt "+FONT;
            drawMap(mapContent);
            NameGenerator("names.jsonc",function(o){wordMaker = o; populateSubsector();});
            attachEventListeners();

            function attachEventListeners(){
                canvas.addEventListener("mousemove",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(coordsInHexagon(e.clientX,e.clientY, hex)){
                            hex.highlighted = true;
                        }else{
                            if(hex.highlighted){
                                hex.highlighted = false;
                            }
                        }
                    }
                    drawMap(mapContent);
                });
                canvas.addEventListener("click",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(coordsInHexagon(e.clientX,e.clientY, hex)){
                            if(hex.selected){
                                hex.selected = false;}
                            else{
                                hex.selected = true;
                            }
                        }else{
                            if(hex.selected){
                                hex.selected = false;
                            }
                        }
                    }
                    drawMap(mapContent);
                });
                canvas.addEventListener("mouseout",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(hex.highlighted){
                            hex.highlighted = false;
                        }
                    }
                    drawMap(mapContent);
                });
                var collapserHandles = document.querySelectorAll("fieldset legend");
                for(var i = 0, len = collapserHandles.length; i < len; i++){
                    var handle = collapserHandles[i];
                    handle.addEventListener("click",function(e){
                        var parent = e.target.parentElement;
                        if(parent.classList.contains("collapsed")){
                            parent.classList.remove("collapsed");
                        }else{
                            parent.classList.add("collapsed");
                        }
                    });
                }
                document.getElementById("slctStyle").addEventListener("change",updateStyle);
                document.getElementById("sizeSlider").addEventListener("change",function(){
                    updateHexSize(+(document.getElementById("sizeSlider").value));
                    drawMap(mapContent);
                });
                document.getElementById("fontFamily").addEventListener("keyup",updateStyle);
                document.getElementById("hexBorderColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBorderColor").value;
                    updateHexBorderColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexfg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("textColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("textColor").value;
                    updateTextColor(newColor);
                    drawMap(mapContent);
                });
                document.getElementById("hexBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBackgroundColor").value;
                    updateHexBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("canvasBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("canvasBackgroundColor").value;
                    updateCanvasBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-canvasbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyData").addEventListener("click",function(){
                    var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, JSON.parse(document.getElementById("data").value));
                    drawMap(mapContent);
                });
                document.getElementById("btnPopulateSystems").addEventListener("click",populateSubsector);
                document.getElementById("btnClearSystems").addEventListener("click",function(){
                    //var mapContent = [];
                    //document.getElementById("sizeSlider").value = HEX_SIZE;
                    mapContent = generateHexes(SUBSECTOR_WIDTH,SUBSECTOR_HEIGHT);
                    //updateStyle();
                    //ctx.font = ""+fontSize+"pt "+FONT;
                    drawMap(mapContent);
                });
                document.getElementById("slcHeatMap").addEventListener("change",function(){
                    drawMap(mapContent);
                });
                document.getElementById("chkShowTravelCodes").addEventListener("change",function(){
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyTravelCodes").addEventListener("click",function(){
                    applyTravelCodes(mapContent);
                    drawMap(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = true;
                });
                document.getElementById("btnClearTravelCodes").addEventListener("click",function(){
                    clearTravelCodes(mapContent);
                    drawMap(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                });
                document.getElementById("btnResetTravelCodes").addEventListener("click",resetTravelCodes);
                document.getElementById("btnCETravelCodes").addEventListener("click",selectCETravelCodes);
                document.getElementById("btnT5TravelCodes").addEventListener("click",selectT5TravelCodes);
                var zonePickers = document.querySelectorAll("select[data-color]");
                for(var i = 0, len = zonePickers.length; i < len; i++){
                    zonePickers[i].addEventListener("change",function(e){
                        e.target.setAttribute("data-color",e.target.value);
                        document.getElementById("btnApplyTravelCodes").disabled = false;
                        document.getElementById("btnResetTravelCodes").disabled = false;
                    });
                }

                document.getElementById("slctAmberGovLawThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctDangerousAtmoThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctRedGovLawThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctMaxLawLevelThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctLawLevelThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
            }
            function populateSubsector(){
                var ggFrequency = document.getElementById("slctGGFrequency").value;
                var density = document.getElementById("slctStellarDensity").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked;
                var d = 1, target = 3, systems = {};
                switch(density){
                    case "Extra Galactic": d = 3, target = 3; break;
                    case "Rift": d = 2, target = 2; break;
                    case "Sparse": d = 1, target = 1; break;
                    case "Scattered": d = 1, target = 2; break;
                    case "Standard": d = 1, target = 3; break;
                    case "Dense": d = 1, target = 4; break;
                    case "Cluster": d = 1, target = 5; break;
                    case "Core": d = 2, target = 11; break;
                }
                var namesSoFar = {};
                mins = [-1,-1,-1,-1,-1,-1,-1,-1,-3], maxes = [0,0,0,0,0,0,0,0,5];
                for(var x = 0; x < SUBSECTOR_WIDTH; x++){
                    for(var y = 0; y < SUBSECTOR_HEIGHT; y++){
                        if(d6(d) <= target){
                            var name = wordMaker.getRandomName("system");
                            while(Object.keys(namesSoFar).indexOf(name) >= 0){
                                name = wordMaker.getRandomName("system");
                            }
                            var tcoord = XYCoordToTCoord(x,y);
                            namesSoFar[name] = {hexlocation:tcoord,x:x,y:y};
                            var details = generateSystemDetails(addCaps(name),ggFrequency,permitDieback);
                            for(var i = 0, len = mins.length; i < len; i++){
                                var currValue;
                                if(i === 8){
                                    currValue = details.importance.extension;
                                    //if(currValue > currMax){ maxes[i] = currValue;}
                                }else{
                                    currValue = details.mainworld[labels[i]];
                                    var currMin = mins[i], currMax = maxes[i];
                                    if(currValue < currMin){ mins[i] = currValue;}
                                    if(currValue > currMax){ maxes[i] = currValue;}
                                }
                                
                            }
                            systems[tcoord] = {                                    
                                name: addCaps(name),
                                mainworld:details.mainworld,
                                uwp: details.uwp.toUpperCase(),
                                gg:details.gg,
                                isAsteroidBelt:details.mainworld.isAsteroidBelt,
                                planetoidBelts:details.planetoidBelts,
                                bases:details.bases,
                                stars:details.stars,
                                importance: details.importance
                            };
                        }
                    }
                }
                document.getElementById("data").value = JSON.stringify(systems);
                var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, systems);
                applyTravelCodes(mapContent);
                drawMap(mapContent);                
            }
            function generateSystemDetails(name, gasGiantFrequency, permitDieback){
                var isAsteroidBelt = d6(2) == 2;
                var planetoidBelts = Math.max(d6()-3,0);
                var gg = d6(2) <= gasGiantFrequency ? Math.max(d6(2)/2>>0-2,1) : 0;
                var roll;
                var uwp = "";
                var tradeCodes = [];
                var stars = {primary:{},primary_companion:false,close:false,near:false, near_companion:false,close_companion:false,far:false, far_companion:false};
                var primaryType = d6()-d6(),
                    primaryDecimal = d09(),
                    primarySize = d6()-d6();
                stars.primary = getStar(primaryType,primaryDecimal,primarySize);
                if(d6()-d6()>=3){ 
                    stars.primary_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    
                }
                if(d6()-d6()>=3){ 
                    stars.close = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    stars.close.orbit = d6()-1;
                    if(d6()-d6()>=3){ 
                        stars.close_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    }
                }
                if(d6()-d6()>=3){ 
                    stars.near = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    stars.near.orbit = 5 + d6();
                    if(d6()-d6()>=3){ 
                        stars.near_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    }
                }
                if(d6()-d6()>=3){ 
                    stars.far = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    stars.far.orbit = 11 + d6();
                    if(d6()-d6()>=3){ 
                        stars.far_companion = getStar(primaryType+d6()-1,d09(),primarySize+d6()+2);
                    }
                }
                
                var bases = [];
                roll = d6(2); // roll for starport
                var starport;
                if(roll <= 4){
                    uwp = starport = "A";
                    if(d6(2)<=6){ bases.push("Naval Depot");}
                    if(d6(2)<=4){ bases.push("Way Station");}
                }
                else if(roll <= 6){
                    uwp = starport = "B";
                    if(d6(2)<=5){ bases.push("Naval");}
                    if(d6(2)<=5){ bases.push("Scout");}
                }
                else if(roll <= 8){
                    uwp = starport = "C";
                    if(d6(2)<=6){bases.push("Scout");}
                }
                else if(roll == 9){
                    uwp = starport = "D";
                    if(d6(2)<=7){bases.push("Scout");}
                }
                else if(roll <= 11){
                    uwp = starport = "E";
                }
                else if(roll == 12){
                    uwp = starport = "X";
                }
                // roll for size
                var size = d6(2)-2; 
                if(size === 10){ size = d6()+9; }
                uwp += size.toString(36);
                //roll for atmosphere
                var atmo = d6()-d6()+size;
                if(atmo < 0 || size === 0){ atmo = 0;}
                if(atmo > 15){atmo = 15;}
                uwp += atmo.toString(36);
                //roll for hydro
                var hydroMods = 0;
                if(atmo < 2 || atmo > 9){hydroMods = 4;}
                var hydro = d6()-d6()+atmo+hydroMods;
                if(size < 2 || hydro < 0){hydro = 0;}
                if(hydro > 10){hydro = 10;}
                uwp += hydro.toString(36);
                // roll for pop
                var pop = d6(2)-2;
                if(pop===0){
                    //uwp = "X"+uwp.substring(1); 
                    //starport = "X"; 
                    bases = [];
                }
                if(pop === 10){ pop = d6(2)+3;}
                uwp += pop.toString(36);
                // roll for gov
                var gov = d6()-d6()+pop;
                if(gov > 15){gov = 15;}
                if(gov < 0){gov = 0;}
                if(pop === 0){gov = 0;}
                uwp += gov.toString(36);
                // roll for law
                var law = d6()-d6()+gov;
                if(law < 0){law = 0;}
                if(law > 18){law = 18;}
                if(pop === 0){ law = 0;}
                uwp += law.toString(36);
                // roll for TL
                var tech = d6();
                if(starport === "A"){tech+=6;}
                else if(starport === "B"){tech+=4;}
                else if(starport === "C"){tech+=2;}
                else if(starport === "X"){if(tech>=5){tech -= 4;}}

                if(pop > 0){
                    if(size <= 1 ){tech += 2;}
                    else if(size <= 4 ){tech += 1;}

                    if(atmo <= 3 ){tech += 1;}
                    else if(atmo >= 10 ){tech += 1;}

                    if(hydro === 9 ){tech += 1;}
                    else if(hydro === 10 ){tech += 2;}
                    
                    if(pop <= 5 ){ tech += 1; }
                    else if(pop === 9){ tech += 2;}
                    else if(pop >= 10){ tech += 4;}
                }
                if((pop > 0 && gov === 0) || gov === 5){ tech += 1;}
                else if(gov === 13){ tech -= 2;}
                if(pop === 0){ // reduce tech level on dieback worlds
                    var reduction = document.getElementById("slctDiebackTLPenalty").value;
                    tech -= reduction;
                    if(reduction > 0){
                        if(tech <= 8 && starport === "A"){ starport = "B"; uwp = "B"+uwp.substring(1);}
                        else if(tech <= 7 && starport === "B"){ starport = "C"; uwp = "C"+uwp.substring(1);}
                        else if(tech <= 3 && starport === "C"){ starport = "D"; uwp = "D"+uwp.substring(1);}
                        else if(tech === 1 && starport === "D"){ starport = "E"; uwp = "E"+uwp.substring(1);}
                    }
                    if(tech > 0){
                        // This will be a dieback world. Give them the tech bonuses for planet features.
                        if(size <= 1 ){tech += 2;}
                        else if(size <= 4 ){tech += 1;}

                        if(atmo <= 3 ){tech += 1;}
                        else if(atmo >= 10 ){tech += 1;}

                        if(hydro === 9 ){tech += 1;}
                        else if(hydro === 10 ){tech += 2;}
                    }
                } 
                if(tech < 0){tech = 0;}
                if(pop === 0){ 
                    if(!permitDieback){ 
                        tech = 0;
                    }
                    if(tech===0){ // barren worlds require starport E or X
                        if(starport !== "E"){
                            starport = "X";
                            uwp = "X" + uwp.substring(1);
                        }
                    }
                }

                uwp += "-"+tech.toString(36);
                // roll to see if the world is a satellite
                roll = d6()-d6();
                var MWType, MWPrimary, MWOrbitAroundPrimary;
                if(roll <=-4){ 
                    MWType = "Far Satellite";
                    roll = d6() - d6();
                    if(roll === -5){ MWOrbitAroundPrimary = "Oh"; }
                    else if(roll === -4){ MWOrbitAroundPrimary = "Pee"; }
                    else if(roll === -3){ MWOrbitAroundPrimary = "Que"; }
                    else if(roll === -2){ MWOrbitAroundPrimary = "Arr"; }
                    else if(roll === -1){ MWOrbitAroundPrimary = "Ess"; }
                    else if(roll === 0){ MWOrbitAroundPrimary = "Tee"; }
                    else if(roll === 1){ MWOrbitAroundPrimary = "Yu"; }
                    else if(roll === 2){ MWOrbitAroundPrimary = "Vee"; }
                    else if(roll === 3){ MWOrbitAroundPrimary = "Dub"; }
                    else if(roll === 4){ MWOrbitAroundPrimary = "Ex"; }
                    else if(roll === 5){ MWOrbitAroundPrimary = "Wye"; }
                }
                else if(roll <= -3){ 
                    MWType = "Close Satellite";
                    if(roll === -5){ MWOrbitAroundPrimary = "Bee"; }
                    else if(roll === -4){ MWOrbitAroundPrimary = "Cee"; }
                    else if(roll === -3){ MWOrbitAroundPrimary = "Dee"; }
                    else if(roll === -2){ MWOrbitAroundPrimary = "Ee"; }
                    else if(roll === -1){ MWOrbitAroundPrimary = "Eff"; }
                    else if(roll === 0){ MWOrbitAroundPrimary = "Gee"; }
                    else if(roll === 1){ MWOrbitAroundPrimary = "Aitch"; }
                    else if(roll === 2){ MWOrbitAroundPrimary = "Eye"; }
                    else if(roll === 3){ MWOrbitAroundPrimary = "Jay"; }
                    else if(roll === 4){ MWOrbitAroundPrimary = "Kay"; }
                    else if(roll === 5){ MWOrbitAroundPrimary = "Ell"; }
                }
                else{ MWType = "Planet"; MWPrimary = "Star"; MWOrbitAroundPrimary = MWOrbit; }
                if(MWType !== "Planet"){
                    if(gg >= 1 && d6()-d6() <= 0){
                            MWPrimary = "Gas Giant";
                    }else{
                        MWPrimary = "Planet";
                    }
                }

                
                roll = d6()-d6(); // roll for mainworld orbit
                
                var MWOrbit = stars.primary.HZOrbit; var climate = "";
                if(stars.primary.type === "M"){roll += 2;}
                else if(stars.primary.type === "O" || stars.primary.type === "B"){ roll -= 2;}

                if(roll<=-6){ 
                    MWOrbit -= 2; tradeCodes.push("Tr"); climate = "Hot. Tropic.";
                }
                else if(roll <= -3){ 
                    MWOrbit -=1; 
                    if(size >= 6 && size <= 9 && atmo >= 4 && atmo <= 9 && hydro >= 3 && hydro <= 7){
                        tradeCodes.push("Tr"); climate = "Tropic.";
                    }else{
                        tradeCodes.push("Ho"); climate = "Hot.";
                    }
                }
                else if(roll <= 2){ MWOrbit = stars.primary.HZOrbit; climate = "Temperate."; }
                else if(roll <= 5){ 
                    MWOrbit += 1; 
                    if(size >= 6 && size <= 9 && atmo >= 4 && atmo <= 9 && hydro >= 3 && hydro <= 7){
                        tradeCodes.push("Tu"); climate = "Tundra.";
                    }else{
                        tradeCodes.push("Co"); climate = "Cold.";
                    }
                }
                else if(roll >= 6){ 
                    MWOrbit += 2; 
                    if(size >= 2 && size <= 9){
                        tradeCodes.push("Fr"); 
                        climate = "Frozen.";
                    }
                }
                if(MWOrbit <= 1){ tradeCodes.push("Tz"); }
                // trade codes
                if(size === 0 && atmo === 0 && hydro === 0){ tradeCodes.push("As"); }
                if(atmo >= 2 && atmo <= 9 && hydro === 0){ tradeCodes.push("De"); }
                if(atmo >= 10 && atmo <= 12 && hydro >= 1){ tradeCodes.push("Fl"); }
                if(size >= 6 && size <= 8 && 
                    (atmo === 5 || atmo === 6 || atmo === 8) &&
                    (hydro >= 5 && hydro <= 7)
                ){ 
                    tradeCodes.push("Ga"); 
                }
                if(size >= 3 && 
                    (atmo === 2 || atmo === 4 || atmo === 7 || atmo === 9 || atmo === 10 || atmo === 11 || atmo === 12) &&
                    (hydro <= 2)
                ){
                    tradeCodes.push("He");
                }
                if( atmo <= 1 && hydro >= 1){ tradeCodes.push("Ic"); }
                if(size >= 10 && hydro === 10 && (
                    (atmo >= 3 && atmo <=9) || (atmo >= 13)
                )){ tradeCodes.push("Oc");}
                if(size <= 9 && hydro === 10 && (
                    (atmo >= 3 && atmo <=9) || (atmo >= 13)
                )){ tradeCodes.push("Wa");}
                if(atmo === 0){tradeCodes.push("Va");}
                if(MWType === "Far Satellite"){ tradeCodes.push("Sa"); }
                else if(MWType === "Close Satellite"){ tradeCodes.push("Lk"); }
                if(pop === 0){
                    tradeCodes.push("Ba");
                    if(tech > 0){ tradeCodes.push("Di");}
                }
                else if(pop <= 3){
                    tradeCodes.push("Lo");
                }else if(pop <= 6){
                    tradeCodes.push("Ni");
                }else if(pop === 8){
                    tradeCodes.push("Ph");
                }else if(pop >= 9){
                    tradeCodes.push("Hi");
                }
                if(atmo >= 4 && atmo <= 9 && hydro >= 4 && hydro <= 8 && (pop === 4 || pop === 8)){ tradeCodes.push("Pa"); }
                if(atmo >= 4 && atmo <= 9 && hydro >= 4 && hydro <= 8 && (pop >= 5 && pop <= 7)){ tradeCodes.push("Ag"); }
                if(atmo <= 3 && hydro <= 3 && pop >= 6){ tradeCodes.push("Na"); }
                if( (atmo === 2 || atmo === 3 || atmo === 10 || atmo === 11) &&
                    hydro <= 5 && pop >=3 && pop <= 6 && law >= 6 && law <= 9
                ){
                    tradeCodes.push("Px");
                }
                if((atmo <=2 || atmo === 4 || atmo ===7 || atmo === 9) && (pop === 7 || pop === 8)){ tradeCodes.push("Pi");}
                if((atmo <=2 || atmo === 4 || atmo ===7 || atmo === 9 || atmo === 10 || atmo === 11 || atmo === 12) 
                    && (pop >= 9)){ tradeCodes.push("In");
                }
                if(atmo >= 2 && atmo <= 5 && hydro <= 3){
                    tradeCodes.push("Po");
                }
                if(atmo === 6 || atmo === 8){
                    if(pop === 5 || pop === 9){ tradeCodes.push("Pr"); }
                    else if(pop >= 6 && pop <= 8){ tradeCodes.push("Ri"); }
                }

                // throw in the Mongoose tech codes for good measure
                if(tech >= 12){ tradeCodes.push("Ht");}
                else if(tech <= 5 ){ tradeCodes.push("Lt");}

                var importance = 0, importanceDesc = "";
                if(starport === "A" || starport === "B"){ importance +=1; }
                else if(starport === "D" || starport === "E" || starport === "X"){ importance -= 1;}
                if(tech >= 16){importance += 1;}
                if(tech >= 10){importance += 1;}
                if(tech <= 8){importance -= 1;}
                if(tradeCodes.indexOf("Ag")>=0){ importance += 1;}
                if(tradeCodes.indexOf("Hi")>=0){ importance += 1;}
                if(tradeCodes.indexOf("In")>=0){ importance += 1;}
                if(tradeCodes.indexOf("Ri")>=0){ importance += 1;}
                if(pop <= 6){ importance -=1;}
                if(bases.indexOf("Naval") >= 0 && bases.indexOf("Scout") >= 0){ importance += 1;}
                if(bases.indexOf("Naval Depot") >= 0 && bases.indexOf("Way Station") >= 0){ importance += 1;}
                if(bases.indexOf("Way Station") >= 0){ importance += 1;}
                var isImportant = importance >= 4;
                var isUnimportant = importance <= 0;
                if(importance <= -2){ importanceDesc = "Very Unimportant"; }
                else if(importance <= 0){ importanceDesc = "Unimportant"; }
                else if(importance <= 3){ importanceDesc = "Ordinary"; }
                else if(importance <= 4){ importanceDesc = "Important"; }
                else if(importance >= 5){ importanceDesc = "Very Important";}
                tradeCodes.sort();
                return {uwp:uwp,bases:bases,stars:stars,gg:gg,planetoidBelts:planetoidBelts,  importance:{isImportant:isImportant, isUnimportant:isUnimportant, extension:importance,description:importanceDesc}, mainworld:{tradeCodes:tradeCodes, size:size, atmo:atmo, hydro:hydro, pop:pop, gov:gov, law:law, tech:tech, primary:MWPrimary,climate:climate,orbitAroundPrimary:MWOrbitAroundPrimary, isAsteroidBelt:size===0,orbit:MWOrbit,starport:starport},tradeCodes:tradeCodes};
            }
            function getStar(type, decimal, size){
                var star = {};
                if(type == -6){ 
                    if(d6() == 1){
                        star.type =  "O";
                        if(size <= -5){ star.size = "Ia"; star.HZOrbit = 15;}
                        else if(size <= -4){ star.size = "Ib"; star.HZOrbit = 15;}
                        else if(size <= -3){ star.size = "II"; star.HZorbit = 14; }
                        else if(size <= 0){ star.size = "III"; star.HZOrbit = 13;}
                        else if(size <= 3){ star.size = "V"; star.HZOrbit = 11;}
                        else if(size <= 4){ star.size = "IV"; star.HZOrbit = 12;}
                        else if(size <= 5){ star.size = "D"; star.HZOrbit = 1;}
                        else{ star.size = "IV"; star.HZOrbit = 12;}
                    }else{
                        star.type = "B";
                        if(size <= -5){ star.size = "Ia"; star.HZOrbit = 13;}
                        else if(size <= -4){ star.size = "Ib"; star.HZOrbit = 13;}
                        else if(size <= -3){ star.size = "II"; star.HZOrbit = 12; }
                        else if(size <= 1){ star.size = "III"; star.HZOrbit = 11; }
                        else if(size <= 3){ star.size = "V"; star.HZOrbit = 9;}
                        else if(size <= 4){ star.size = "IV"; star.HZOrbit = 10;}
                        else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                        else{ star.size = "IV";star.HZOrbit = 10;}
                    }
                }
                else if(type <= -4){ 
                        star.type = "A"; 
                        if(size <= -5){ star.size = "Ia"; star.HZOrbit = 12; }
                        else if(size <= -4){ star.size = "Ib"; star.HZOrbit = 11;}
                        else if(size <= -3){ star.size = "II";star.HZOrbit = 9; }
                        else if(size <= -2){ star.size = "III"; star.HZOrbit = 7;}
                        else if(size <= -1){ star.size = "IV"; star.HZOrbit = 7;}
                        else if(size <= 4){ star.size = "V";star.HZOrbit = 7;}
                        else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                        else{ star.size = "V";star.HZOrbit = 7;}
                }
                else if(type <= -2){ 
                    star.type = "F"; 
                    if(size <= -5){ star.size = "II"; star.HZOrbit = 9;}
                    else if(size <= -4){ star.size = "III";star.HZOrbit = 6; }
                    else if(size <= -3){ star.size = "IV"; star.HZOrbit = 6;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 5;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 3;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 3;}
                }
                else if(type <= 0){ 
                    star.type = "G"; 
                    if(size <= -5){ star.size = "II"; star.HZOrbit = 9;}
                    else if(size <= -4){ star.size = "III"; star.HZOrbit = 7;}
                    else if(size <= -3){ star.size = "IV"; star.HZOrbit = 5;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 3;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 2;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 3;}
                }
                else if(type <= 2){ 
                    star.type = "K"; 
                    if(size <= -5){ star.size = "II"; star.HZOrbit = 9;}
                    else if(size <= -4){ star.size = "III"; star.HZOrbit = 8;}
                    else if(size <= -3){ star.size = "IV"; star.HZOrbit = 5;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 2;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 1;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 1;}
                }
                else if(type <= 5){ 
                    star.type = "M"; 
                    if(size <= -3){ star.size = "II"; star.HZOrbit = 10;}
                    else if(size <= -2){ star.size = "III"; star.HZOrbit = 9;}
                    else if(size <= 3){ star.size = "V"; star.HZOrbit = 0;}
                    else if(size <= 4){ star.size = "VI";star.HZOrbit = 0;}
                    else if(size <= 5){ star.size = "D";star.HZOrbit = 0;}
                    else{ star.size = "VI";star.HZOrbit = 0;}
                }
                else{ star.type = "BD"; }
                if(star.size !== "D"){star.decimal = decimal;}
                return star;
            }
            function d6(num){
                if(!num){ num = 1;}
                var sum = 0;
                for(var i = 0; i < num; i++){
                    sum += (Math.random()*6 >>> 0) + 1;
                }
                return sum;
            }
            function d09(){
                //returns 0-9 even distribution
                var r1=d6(),r2=d6(),x;
                while(r1==6){r1=d6();}
                x = (r1-1) * 2;
                if(r2 >= 4){x+=1;}
                return x;
            }
            function generateHexes(x,y, systems){
                var systemsPredefined = true;
                if(typeof systems == "undefined"){
                    _systems = {};
                    systemsPredefined = false;
                }else{
                    _systems = systems;
                }
                mapContent = [];
                for(var iy = 0; iy < y; iy++){
                    for(var ix = 0; ix < x; ix++){
                        var hexLabel = XYCoordToTCoord(ix,iy);
                        var system = _systems[hexLabel];
                        addHex(ix,iy,system);
                    }
                }
                return mapContent;
            }
            function addHex(x,y,system){
                mapContent.push({
                    x:x,
                    y:y,
                    system:system
                });
            }
            function coordsInHexagon(x,y,hex){
                x = x - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                y = y - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                var numVertices = hex.vertx.length;
                var isInside = false;
                for(var i = 0, j = numVertices-1; i < numVertices; j = i++){
                    if(((hex.verty[i] > y) != (hex.verty[j] > y )) && 
                    ( x < (hex.vertx[j] - hex.vertx[i]) * (y - hex.verty[i])/(hex.verty[j] -hex.verty[i]) + hex.vertx[i])){
                        isInside = !isInside;
                    }
                }
                return isInside;
            }
            function drawMap(mapContent, options){
                if(typeof options === "undefined"){
                    options = { 
                        heatMap: +(document.getElementById("slcHeatMap").value),
                        travelCodes: document.getElementById("chkShowTravelCodes").checked
                    };
                }
                var w =canvas.width, h =canvas.height;
                ctx.clearRect(0,0,w,h);
                if(CANVAS_BACKGROUND_COLOR !== "transparent"){
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                    ctx.fillRect(0,0,w,h);
                }
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.translate(HEX_MATH.diameter + CANVAS_PADDING, HEX_MATH.diameter + CANVAS_PADDING);
                for(var i = 0, len = mapContent.length; i < len; i++){
                    mapContent[i] = drawHex(mapContent[i], options);
                }
                ctx.restore();
                document.getElementById("data").value = JSON.stringify(_systems);
            }
            function selectT5TravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "Amber");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "Red");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                //document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "Red");
           
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "Red");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "N/A");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "N/A");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function selectCETravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "N/A");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "N/A");
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "Amber");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "Amber");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "Amber");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "Amber");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "Amber");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function resetTravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "Amber");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 12);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "Red");
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "Red");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "N/A");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = true;
            }
            function applyTravelCodes(mapContent, highestLawLevel){
                var RedGovLaw = document.getElementById("slctRedGovLaw").value;
                var AmberDieback = document.getElementById("slctAmberDieback").value;
                var AmberGovLaw = document.getElementById("slctAmberGovLaw").value;
                var RedGovLawThreshold = document.getElementById("slctRedGovLawThreshold").value;
                var DangerousAtmoThreshold = document.getElementById("slctDangerousAtmoThreshold").value;
                var AmberGovLawThreshold = document.getElementById("slctAmberGovLawThreshold").value;
                var RedZoneX = document.getElementById("slctRedZoneX").value;
                var AmberZoneBa = document.getElementById("slctAmberZoneBa").value;
                var AmberZoneBaX = document.getElementById("slctAmberZoneBaX").value;
                var AmberZoneAtmo = document.getElementById("slctAmberZoneAtmo").value;
                var AmberZoneLL = document.getElementById("slctAmberZoneLL").value;
                var AmberZone9LL = document.getElementById("slctAmberZone9LL").value;
                var LLThreshold = document.getElementById("slctLawLevelThreshold").value;
                var MaxLLThreshold = document.getElementById("slctMaxLawLevelThreshold").value;
                var AmberZone0LL = document.getElementById("slctAmberZone0LL").value;
                var AmberZoneGov0 = document.getElementById("slctAmberZoneGov0").value;
                var AmberZoneGov7 = document.getElementById("slctAmberZoneGov7").value;
                var AmberZoneGov10 = document.getElementById("slctAmberZoneGov10").value;
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null){
                        mapContent[i].system.isAmber = false;
                        mapContent[i].system.isRed = false;
                        mapContent[i].system.travelCodeNotes = "";
                        if(mapContent[i].system.mainworld.pop > 0){
                            if(AmberZoneLL !== "N/A"){ // amber zone highest law level
                                if(mapContent[i].system.mainworld.law === maxes[6] && maxes[6] >= MaxLLThreshold) {
                                    if(AmberZoneLL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "Among strictest law levels in the subsector.  ";
                                }
                            }
                            if(AmberZone9LL !== "N/A"){ // amber zone 9+ law level 
                                if(mapContent[i].system.mainworld.law >= LLThreshold) {
                                    if(AmberZone9LL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "Law levels "+LLThreshold.toString()+"+.  ";
                                }
                            }
                            if(AmberZone0LL !== "N/A"){ // amber zone 0 law level
                                if(mapContent[i].system.mainworld.law === 0) {
                                    if(AmberZone0LL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "No law level enforced.  ";
                                }
                            }
                           
                            if(AmberZoneGov0 !== "N/A"){ // amber ungoverned
                                if(mapContent[i].system.mainworld.gov === 0) {
                                    if(AmberZoneGov0 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "Anarchy.  ";
                                }
                            }
                            if(AmberZoneGov7 !== "N/A"){ // amber balkanized
                                if(mapContent[i].system.mainworld.gov === 7) {
                                    if(AmberZoneGov7 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "Balkanized local governments.  ";
                                }
                            }
                            if(AmberZoneGov0 !== "N/A"){ // amber charismatic dictatorship
                                if(mapContent[i].system.mainworld.gov === 10) {
                                    if(AmberZoneGov0 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "Ruled by charismatic dictatorship.  ";
                                }
                            }
                            if(RedZoneX !== "N/A" && mapContent[i].system.mainworld.starport.toUpperCase() === "X"){ // red no starport
                                if(RedZoneX === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelCodeNotes += "Population under interdiction.  ";
                            }
                            if(RedGovLaw !== "N/A"){
                                if(mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law > RedGovLawThreshold){
                                    if(RedGovLaw === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "Oppressive government.  ";
                                }
                                
                            }
                            if(AmberGovLaw !== "N/A"){
                                if(mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law > AmberGovLawThreshold){
                                    if(AmberGovLaw === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelCodeNotes += "Oppressive government.  ";
                                }
                                
                            }
                        }else{
                            if(AmberZoneBa !== "N/A" && mapContent[i].system.mainworld.tech === 0){ // amber zone uninhabited
                                
                                if(AmberZoneBa === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelCodeNotes += "Barren/Uninhabited.  ";
                                
                            }
                            if(AmberZoneBaX !== "N/A" && mapContent[i].system.starport === "X"){ // amber zone uninhabited
                                
                                if(AmberZoneBaX === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelCodeNotes += "No starport facilities.  ";
                                
                            }
                            if(AmberDieback !== "N/A" && mapContent[i].system.mainworld.tech > 0){
                                if(AmberDieback === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelCodeNotes += "Dieback world.  ";
                            }
                        }
                        if(AmberZoneAtmo !== "N/A"){ // amber 10+ atmo
                            if(mapContent[i].system.mainworld.atmo >= DangerousAtmoThreshold) {
                                if(AmberZoneAtmo === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelCodeNotes += "Dangerous atmosphere.  ";
                            }
                        }
                    }
                }
            }
            function clearTravelCodes(mapContent){
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null){
                        mapContent[i].system.isRed = false;
                        mapContent[i].system.isAmber = false;
                    }
                }
            }
            function TCoordToXYCoord(tcoord){
                if(tcoord.length && tcoord.length == 4){
                    var col = tcoord.substring(0,2);
                    var row = tcoord.substring(2,4);
                    if(row[0] == "0"){row = row[1];}
                    if(col[0] == "0"){col = col[1];}
                    return{x:+(col)-1,y:+(row)-1}
                }
            }
            function XYCoordToTCoord(x,y){
                var col = (x+1).toString();
                if(x < 10){col = "0"+col;}
                var row = (y+1).toString();
                if(y < 10){row = "0"+row;}
                return col+row;
            }
            function drawHex(hex, options){
                var drawMode = -1;
                if(typeof options.heatMap !== "undefined"){ drawMode = options.heatMap; }
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                var coords = {
                    x:hex.x*HEX_MATH.xOffset,
                    y:hex.x%2 == 0 ? hex.y*HEX_MATH.yOffset : hex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                };
                var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                    x2 = coords.x+HEX_MATH.radius; // top/bottom right vertex
                var x0 = x1 - HEX_MATH.radius, // center left vertex
                    x3 = x2 + HEX_MATH.radius, // center right vertex
                    x4 = x1 + (x2-x1)/2; // middle of the bottom edge
                var y0 = coords.y - HEX_MATH.diameter, 
                    y1 = coords.y,
                    y2 = y1 + HEX_MATH.diameter;
                ctx.strokeStyle = HEX_BORDER_COLOR;
                var oldLineWidth = ctx.lineWidth;
                
                ctx.beginPath();
                ctx.moveTo(x4,y2);
                hex.vertx = [x4,x2,x3,x2,x1,x0,x1,x4];
                hex.verty = [y2,y2,y1,y0,y0,y1,y2,y2];
                for(var i = 1; i < hex.vertx.length; i++){
                    ctx.lineTo(hex.vertx[i], hex.verty[i]);
                }
                ctx.stroke();
                ctx.fillStyle = HEX_BACKGROUND_COLOR;           
                ctx.fill();
                
                if(containsSystem){
                    if(drawMode >= 0){
                        var heatMapValue = 0;
                        var bgColor = "black";
                        var minValue = mins[drawMode], maxValue = maxes[drawMode];
                        switch(drawMode){
                            case 0: // starport
                                switch(hex.system.mainworld.starport){
                                    case "A": bgColor = "rgb(255,0,0)"; break; 
                                    case "B": bgColor = "rgb(200,0,50)"; break; 
                                    case "C": bgColor = "rgb(150,0,100)"; break; 
                                    case "D": bgColor = "rgb(100,0,150)"; break; 
                                    case "E": bgColor = "rgb(50,0,200)"; break; 
                                    case "X": bgColor = "rgb(0,0,205)";  break; 
                                }
                                
                            break;
                            case 1: heatMapValue = hex.system.mainworld.size; 
                            break;
                            case 2: heatMapValue = hex.system.mainworld.atmo; 
                            break;
                            case 3: heatMapValue = hex.system.mainworld.hydro; 
                            break;
                            case 4: heatMapValue = hex.system.mainworld.pop; break;
                            case 5: heatMapValue = hex.system.mainworld.gov; break;
                            case 6: heatMapValue = hex.system.mainworld.law; break;
                            case 7: heatMapValue = hex.system.mainworld.tech; break;
                            case 8: heatMapValue = hex.system.importance.extension; break;
                        }
                        if(drawMode > 0){
                            var bValue = 200 - 200*((heatMapValue - minValue) / (maxValue - minValue)) >>> 0; 
                            var rValue = 255*((heatMapValue - minValue) / (maxValue - minValue)) >>> 0; 
                            bgColor = "rgb("+rValue+",0,"+bValue+")";
                        }
                        ctx.fillStyle = bgColor;
                        ctx.fill();
                    }
                    
                    if(hex.selected || hex.highlighted){
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if(ctx.strokeStyle.length === 7){
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if(hex.selected){                    
                            ctx.lineWidth = inc;
                        }else if(hex.highlighted){
                            ctx.lineWidth = inc/2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2,tx3,tx2,];//tx1,tx0,tx1];
                        var verty = [ty2,y1,ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1,tx0,tx1];
                        var verty = [ty0,y1,ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                    var zoneRadius = fontSize*5;
                    if(options.travelCodes && (hex.system.isRed || hex.system.isAmber)){

                        if(hex.system.isRed){
                            ctx.strokeStyle = "red";
                        }else if(hex.system.isAmber){
                            ctx.strokeStyle = "yellow";
                        }
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(x4,y1,zoneRadius,-Math.PI/2,Math.PI/4);
                        ctx.stroke();
            
                        ctx.beginPath();
                        ctx.arc(x4,y1,zoneRadius,-5*Math.PI/4,-Math.PI/2);
                        ctx.stroke();
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        
                    }

                    var maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize;
                    var name = hex.system.name;
                    if(hex.system.importance.isImportant){ name = name.toUpperCase();}

                    var lines = [];
                    if(ctx.measureText(name).width > maxWidth){
                        var words = name.split(" ");
                        var lineSoFar = "";
                        for(var i = words.length-1; i >= 0; i--){
                            var proposal = lineSoFar.length > 0 ? words[i] + " " + lineSoFar : words[i];
                            if(ctx.measureText(proposal).width < maxWidth){
                                lineSoFar = proposal;
                            }else{
                                if(lineSoFar.length > 0){lines.push(lineSoFar);}
                                if(ctx.measureText(words[i]).width > maxWidth){
                                    var mid = words[i].length/2 >> 0
                                    lines.push(words[i].substring(mid))
                                    lineSoFar = words[i].substring(0,mid)+"-";
                                }else{
                                    lineSoFar = words[i];
                                }
                            }
                            maxWidth += fontSize;
                        }
                        if(lineSoFar.length > 0){lines.push(lineSoFar);}
                    }else{
                        lines = [name];
                    }
                    if(hex.system.gg > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x2,y1-(y1-y0)/2,fontSize/2,0,2*Math.PI);
                        ctx.fill();
                    }
                    for(var i = 0, len = hex.system.bases.length; i < len; i++){
                        var base = hex.system.bases[i];
                        drawBase(base, x4, y1);
                    }
                    
                    // draw planet
                    if(hex.system.isAsteroidBelt){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2.5,y1 - (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/9,y1,fontSize/6,0,2*Math.PI);
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/5,y1 - (y1-y0)/11,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/6,y1 + (y1-y0)/9,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/2.5,y1 + (y1-y0)/18,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2,y1 ,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/8,y1 - (y1-y0)/6,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/7,y1 + (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                    }else if(hex.system.mainworld.hydro > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.fill();
                    }else{
                        ctx.strokeStyle = TEXT_COLOR; 
                        ctx.lineWidth  = HEX_SIZE/10;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                    }                    

                    // write text
                    ctx.textAlign = "center";
                    ctx.fillStyle = TEXT_COLOR;                    
                    maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                    var height = y2 - lines.length*fontSize;
                    for(var i = lines.length-1; i >= 0; i--){
                        
                        ctx.fillText(lines[i], x4, height, maxWidth);
                        height += fontSize+(fontSize/4);
                        maxWidth -= fontSize;
                    }
                    
                    // write starport
                    var oldFont = ctx.font;
                    ctx.font = ""+(fontSize*1.2)+"pt "+FONT;
                    ctx.fillText(hex.system.uwp[0],x4,y0 + (y1-y0)/2);
                    ctx.font = oldFont;

                    if(hex.selected || hex.highlighted){
                        // write UWP
                        ctx.beginPath();
                        var oldGlobalCompositeOperation = ctx.globalCompositeOperation;
                        ctx.globalCompositeOperation = 'source-over';
                        var uwp = hex.system.uwp.toUpperCase();
                        var uwpSize = ctx.measureText(uwp);
                        ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                        var fontHeight = uwpSize.fontBoundingBoxAscent + uwpSize.fontBoundingBoxDescent;
                        ctx.fillRect(x4-uwpSize.width/2,y1-fontHeight/2-2,uwpSize.width,fontSize+2);
                        ctx.fillStyle = TEXT_COLOR; 
                        ctx.fillText(uwp,x4,y1);
                        // write trade codes
                        maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                        var codes = hex.system.mainworld.tradeCodes.join(" ");
                        var codesSize = ctx.measureText(codes);
                        lines = [codes];
                        if(codesSize.width > maxWidth){
                            var line1 = hex.system.mainworld.tradeCodes.slice(0,hex.system.mainworld.tradeCodes.length/2>>0).join(" ");
                            var line2 = hex.system.mainworld.tradeCodes.slice(hex.system.mainworld.tradeCodes.length/2>>0).join(" ");
                            lines = [line1, line2]
                        }
                        height = y1 + fontHeight;
                        var blockHeight = y1 + fontHeight/2 - 2;
                        for(var i = lines.length-1; i >= 0; i--){ 
                            var lineWidth = ctx.measureText(lines[i]).width;
                            ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                            ctx.fillRect(x4-lineWidth/2,blockHeight,lineWidth,fontSize+2);
                            ctx.fillStyle = TEXT_COLOR; 
                            ctx.fillText(lines[i], x4, height, maxWidth);
                            height += fontSize+(fontSize/3);
                            blockHeight += fontSize+(fontSize/3);
                        }
                        ctx.globalCompositeOperation = oldGlobalCompositeOperation;
                    }
                    
                }
                else{
                    if(hex.selected || hex.highlighted){
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if(ctx.strokeStyle.length === 7){
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if(hex.selected){                    
                            ctx.lineWidth = inc;
                        }else if(hex.highlighted){
                            ctx.lineWidth = inc/2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2,tx3,tx2,];//tx1,tx0,tx1];
                        var verty = [ty2,y1,ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1,tx0,tx1];
                        var verty = [ty0,y1,ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                }
                
                ctx.lineWidth = oldLineWidth;
                return hex;
            }
            function drawBase(baseType, hexX, hexY){
                switch(baseType){
                    case "Scout":
                        var scale = fontSize/2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.moveTo(hexX - scale*8, hexY + scale*4);
                        ctx.lineTo(hexX - scale*6, hexY + scale*4);
                        ctx.lineTo(hexX - scale*7, hexY + scale*2);
                        ctx.lineTo(hexX - scale*8, hexY + scale*4);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case "Naval":
                        var scale = fontSize/2;
                        drawStar(hexX - scale*5, hexY - scale*5, 5, scale*0.7, scale*1.7);
                        break;
                    case "Naval Depot":
                        var scale = fontSize/2;
                        strokeStar(hexX - scale*5, hexY - scale*5, 5, scale*0.7, scale*1.7);
                        break;
                    case "Way Station":
                    var scale = fontSize/2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.moveTo(hexX - scale*8, hexY + scale*4);
                        ctx.lineTo(hexX - scale*6, hexY + scale*4);
                        ctx.lineTo(hexX - scale*7, hexY + scale*2);
                        ctx.lineTo(hexX - scale*8, hexY + scale*4);
                        ctx.closePath();
                        var oldLineWidth = ctx.lineWidth;
                        ctx.lineWidth = 1;
                        ctx.strokeStyle =TEXT_COLOR;
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                        break;
                }
            }
            function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    
                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)                    
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                ctx.fillStyle=TEXT_COLOR;
                ctx.fill();
            }
            function strokeStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    
                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)                    
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                var oldLineWidth = ctx.lineWidth;
                ctx.lineWidth = 1;
                ctx.strokeStyle =TEXT_COLOR;
                ctx.stroke();
                ctx.lineWidth = oldLineWidth;
            }
            function updateStyle(){
                var select = document.getElementById("slctStyle");
                var val = select.value;
                if(val === "custom"){
                    document.getElementById("hexBorderColor").value = select.getAttribute("data-hexfg");
                    document.getElementById("hexBackgroundColor").value = select.getAttribute("data-hexbg");
                    document.getElementById("canvasBackgroundColor").value = select.getAttribute("data-canvasbg");
                    document.getElementById("textColor").value = select.getAttribute("data-text");
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                   
                }else if(val === "light"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "white";
                    document.getElementById("textColor").value = "black";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "dark"){
                    document.getElementById("hexBorderColor").value = "white";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "black";
                    document.getElementById("textColor").value = "white";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "transparent"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "transparent";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                    document.getElementById("textColor").value = "black";
                }
                updateHexBorderColor(document.getElementById("hexBorderColor").value);
                updateHexBackgroundColor(document.getElementById("hexBackgroundColor").value);
                updateCanvasBackgroundColor(document.getElementById("canvasBackgroundColor").value);
                updateTextColor(document.getElementById("textColor").value);
                updateFont(document.getElementById("fontFamily").value);
                drawMap(mapContent);
            }
            function updateFont(newFont){
                FONT = newFont;
                ctx.font = ""+fontSize+"pt " + newFont;
            }
            function updateHexSize(newSize){
                HEX_SIZE = newSize;
                HEX_MATH.radius = HEX_SIZE;
                HEX_MATH.xOffset = HEX_SIZE*3;
                HEX_MATH.yOffset = HEX_SIZE*4;
                HEX_MATH.diameter = HEX_SIZE*2;
                canvas.setAttribute("width",SUBSECTOR_WIDTH * HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
                canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter+CANVAS_PADDING*2);
                fontSize = (newSize*1/3);
                ctx.font = ""+fontSize+"pt " + FONT;
                document.getElementById("sizeIndicator").innerHTML = newSize;
            }
            function updateHexBorderColor(newColor){
                HEX_BORDER_COLOR = newColor;
            }
            function updateHexBackgroundColor(newColor){
                HEX_BACKGROUND_COLOR = newColor;
            }
            function updateCanvasBackgroundColor(newColor){
                CANVAS_BACKGROUND_COLOR = newColor;
            }
            function updateTextColor(newColor){
                TEXT_COLOR = newColor;
            }
            function addCaps(text) {
                var capitalizedString = "";
                var lastCharacter = null, currCharacter = " ";
                for (var i = 0, len = text.length; i < len; i++) {
                    lastCharacter = currCharacter;
                    currCharacter = text[i];
                    if (lastCharacter === " " || lastCharacter === "-") {
                        capitalizedString += currCharacter.toUpperCase();
                    } else {
                        capitalizedString += currCharacter;
                    }
                }
                return capitalizedString;
            }
        })();
    </script>
</body>
</html>