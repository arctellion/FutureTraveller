<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traveller</title>
</head>
<body>
    <script src="js/SystemGenerator.js"></script>
    <script src="js/SophontGenerator.js"></script>
    <style>
        @font-face {
            font-family:Bahnschrift;
            src:url(/Traveller/fonts/BAHNSCHRIFT.TTF);
        }   
        fieldset{
            font-family:'Consolas','Inconsolas','Courier New', Courier, monospace;
            display:inline-block;
            vertical-align: text-top;
        }
        fieldset legend{
            cursor:pointer;       
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        fieldset legend:hover{
            color:red;
        }
        label{
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        fieldset > fieldset{
            background-color:rgba(0,0,0,0.05);
        }
        fieldset *{
            line-height:1.5em;
        }
        fieldset.collapsed *:not(legend){
            display:none;
        }
        fieldset > legend::before{
            content:"▼ ";
        }
        fieldset.collapsed > legend::before{
            content:"► ";
        }
        #SystemDetailsContainer fieldset{
            font-family:'Bahnschrift Light','Bahnschrift',sans-serif;
            padding-left:20px;
            padding-right:20px;
            padding-top:5px;
            padding-bottom:5px;
            border-radius:20px;
            box-shadow:1px 1px 4px rgba(50,50,100,1);
            display:block;
            margin-bottom:4px;
        }
        
        #SystemDetailsContainer fieldset > legend::before{
            content:"- ";
        }
        #SystemDetailsContainer  fieldset.collapsed > legend::before{
            content:"+ ";
        }
        #SystemDetailsContainer fieldset legend{
            background-color: white;
            font-weight:bold;
        }
        canvas{
            border:1px solid black;
            background-color:white;
        }
        .travelcodepickers select option[value="Amber"] {
            background: rgb(255, 255, 127);
        }
        .travelcodepickers select[data-color="Amber"]{
            background-color: rgb(255, 255, 127);;
        }
        .travelcodepickers select option[value="Red"] {
            background: pink;
        }
        .travelcodepickers select[data-color="Red"]{
            background-color: pink;
        }
        #SystemDetailsContainer{
            display:inline-block;
                        position:absolute;
            border:1px solid gray;
            background-color:white;
            color:black;
            box-shadow:2px 2px 4px black;
            font-family:'Bahnschrift Light','Bahnschrift',sans-serif;
            min-width:30rem;
            text-align:center;
            padding-top:1rem;
            padding-bottom:1rem;
            padding-left:0.5rem;
            padding-right:0.5rem;
        }
       
        #SystemDetailsContainer fieldset h4 .subtitle{
            font-weight:bold;
        }
        #SystemDetailsContainer fieldset .subnormal{
            font-weight:normal;
        }
        #SystemDetails{
            position:relative;
            display:inline-block;
            text-align:left;
        }
        #SystemDetails h1, #SystemDetails h2, #SystemDetails h3,  #SystemDetails h4{
            font-family:'Bahnschrift',sans-serif;
            margin-top:0; margin-bottom:0;
        }
        #SystemDetails ul{
            margin-top:0px;
        }
        fieldset label{
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #maplist{
            list-style-image: url(images/world.png);
            border-radius:20px;
            padding-top:10px;
            padding-bottom:10px;
            padding-right:10px;
            box-shadow:1px 1px 4px rgba(50,50,100,1);
        }
        #maplist .star{
            list-style-image: url(images/star.png);
        }
        #maplist .Mainworld, #maplist .mainworld{
            color:black;
            list-style-image: url(images/hospitable.png);
            font-weight:800;
        }
        #maplist .populated{
            color:black;
        }
        #maplist .Large.Gas.Giant{
            list-style-image: url(images/giant.png);
        }
        #maplist .Small.Gas.Giant{
            list-style-image: url(images/sgiant.png);
        }
        #maplist .Ice.Giant{
            list-style-image: url(images/igiant.png);
        }
        #maplist .Belt{
            list-style-image: url(images/belt.png);
        }
        #maplist .Asteroid.Belt{
            list-style-image: url(images/asteroidbelt.png);
            font-weight:800;
        }
        #maplist .BigWorld{
            list-style-image: url(images/bworld.png);
        }
        #maplist .Ring{
            list-style-image: url(images/ring.png);
        }
        #maplist .Inner{
            list-style-image: url(images/inner.png);
        }        
        #maplist .Inner{
            list-style-image: url(images/outer.png);
        }
        #maplist .Inferno{
            list-style-image: url(images/inferno.png);
        }
        #maplist .Iceworld{
            list-style-image: url(images/ice.png);
        }
        #maplist .RadWorld{
            list-style-image: url(images/rad.png);
        }
        #maplist .Hospitable{
            list-style-image: url(images/hospitable.png);
        }
        #maplist .StormWorld{
            list-style-image: url(images/storm.png);
        }
        #maplist .Occupied{
            list-style-image: url(images/occupied.png);
        }
        #maplist .Solar.Surface{
            list-style-image: url(images/surface.png);
        }
        #maplist .Worldlet{
            list-style-image: url(images/worldlet.png);
        }
        #maplist ul{
            margin-bottom:8px;
            background-color:rgba(150,150,200,0.1);
            border-radius:20px;
            box-shadow:1px 1px 4px rgba(50,50,100,1);
            padding-left:30px;
        }
        #maplist ul:empty{
            margin:0px; display:none;
        }
        #dialog_close{
            float:right; font-weight:normal; cursor:pointer; 
            font-size: 1rem; font-family:sans-serif; border:1px solid black; padding:4px;
            width:2rem; text-align: center;
            border-radius:4px;
        }
        #dialog_close:hover{
            background-color: darkred;
            color:white;
        }
        #nativedetails table, #nativedetails tr, #nativedetails td{vertical-align: top;}
        #nativedetails .table{ box-shadow:1px 1px 3px #555; border-radius:0.3rem; border-collapse:collapse; overflow:hidden; border:0.1rem solid black; display:inline-block; vertical-align: text-top;}
        #nativedetails .table tr:first-child{ border-bottom:1px solid black; background-color:#dfdfdf;}
        #nativedetails .table tr:nth-child(even){ background-color:#f0f0f0;}
        #nativedetails .table th, #nativedetails .table th td{text-align:left; font-weight:bold; vertical-align:text-top; }
        #nativedetails .table td + td, #nativedetails .table th + th{border-left:0.01rem solid black;}
        #nativedetails .table td:empty, #nativedetails .table th:empty{border:0px solid transparent !important; }
        .traitlist ul{list-style:none; padding:0px; margin:0px;}
        #nativedetails .collapsed .table{display:none;}
        .traitlist li{padding-left:2rem;}
        #nativedetails .roller{display:inline-block;}
        #nativedetails .collapsed .roller{display:none;}
    </style>
    <fieldset>
        <legend>Controls</legend>
        <label for="chkUseRandom"><input id="chkUseRandom" type="checkbox" checked="checked"> Use Random Seed</label>
        <label for="txtSeed"><input title="random seed" id="txtSeed" type="text"></label>
        <select name="slctMapSize" id="slctMapSize">
            <option value="Subsector">Subsector (8x10)</option>
            <option value="Quadrant">Quadrant (16x20)</option>
            <option value="Sector">Sector (32x40)</option>
        </select>   
        <select name="slctStellarDensity" id="slctStellarDensity">
            <option value="Extra Galactic">Extra Galactic (1%)</option>
            <option value="Rift">Rift (3%)</option>
            <option value="Sparse">Sparse (17%)</option>
            <option value="Scattered">Scattered (33%)</option>
            <option value="Standard" selected="selected">Standard (50%)</option>
            <option value="Dense">Dense (66%)</option>
            <option value="Cluster">Cluster (83%)</option>
            <option value="Core">Core (97%)</option>
            <option value="Clump">Dense in middle</option>
        </select>
        <label for="btnPopulateSystems"><input type="button" id="btnPopulateSystems" name="btnPopulateSystems" value="Populate Map"></label>
            <label for="btnClearSystems"><input type="button" id="btnClearSystems" name="btnClearSystems" value="Clear Map"></label>
            <label for="btnSaveImg"><input type="button" id="btnSaveImg" name="btnSaveImage" value="Export to .png"/></label>
            <br/>
        <fieldset class="collapsed">
            <legend>Appearance</legend>                
            <label for="sizeSlider">Scale: <span id="sizeIndicator"></span></label><input type="range" min="4" max="50" id="sizeSlider" />
            <label for="slctStyle">Theme: </label><select name="slctStyle" id="slctStyle" data-text="white" data-canvasbg="black" data-hexfg="cyan" data-hexbg="rgba(0,200,255,0.2)">
                <option value="light">light</option>
                <option value="dark">dark</option>
                <option value="transparent">transparent</option>
                <option selected="selected" value="custom">custom</option>
            </select>
            <br/>                
            <fieldset id="customSettings" class="collapsed">
                <legend>Advanced</legend>
                <label for="textColor">Text Color: <input type="text" name="textColor" id="textColor" /></label><br/>
                <label for="hexBorderColor">Border Color: <input type="text" name="hexBorderColor" id="hexBorderColor" /></label><br/>
                <label for="hexBackgroundColor">Hex Fill: <input type="text" id="hexBackgroundColor" name="hexBackgroundColor" /></label><br/>
                <label for="canvasBackgroundColor">Background Color: <input type="text" name="canvasBackgroundColor" id="canvasBackgroundColor" /></label><br/>
                <label for="fontFamily">Font: <input type="text" id="fontFamily" name="fontFamily" value="Segoe UI, sans-serif"/></label>
            </fieldset>
        </fieldset>
        <fieldset class="collapsed">
            <legend>Overlays</legend>
            <label for="slcHeatMap">Heat Map: <select name="slcHeatMap" id="slcHeatMap">
                <option value="-1" selected=selected>No Heatmap</option>
                <option value="0">Starport</option>
                <option value="1">Size</option>
                <option value="2">Atmosphere</option>
                <option value="3">Hydrography</option>
                <option value="4">Mainworld Population</option>
                <option value="5">Government Type</option>
                <option value="6">Law Level</option>
                <option value="7">Tech Level</option>
                <option value="8">Importance</option>
                <option value="9">Total System Pop</option>
                <option value="10">Economy</option>
                <option value="11">Native Intelligent Life</option>
            </select>
        </label><br/>
        <label for="chkShowTravelCodes"><input type="checkbox" name="chkShowTravelCodes" id="chkShowTravelCodes" checked="checked"/> Show Travel Codes</label>
        </fieldset>        
        <fieldset class="collapsed">
                <legend>Configuration</legend>
                <fieldset class="collapsed">
                    <legend>Astrographics</legend>
                    <label for="slctMainworldRules">System Gen Ruleset: 
                        <select name="slctMainworldRules" id="slctMainworldRules">
                            <option value="T5">T5</option>
                        </select></label><br/>
                    
                    <label for="slctGGFrequency">Gas Giant Occurrence: <select name="slctGGFrequency" id="slctGGFrequency">
                        <option selected=selected value=8>8- on 2D (T5) 72%</option>
                        <option value=9>9- on 2D (CE) 83%</option>
                    </select></label>
                </fieldset>
                <fieldset class="collapsed">
                    <legend>Demographics</legend>
                    <label for="slctMaxTechLevel">Maximum Tech Level: 
                        <select name="slctMaxTechLevel" id="slctMaxTechLevel">
                            <option value=22 >22 (N)</option>
                            <option value=21>21 (M)</option>
                            <option value=20>20 (L)</option>
                            <option value=19>19 (K)</option>
                            <option value=18>18 (J)</option>
                            <option value=17>17 (H)</option>
                            <option value=16 selected="selected">16 (G)</option>
                            <option value=15>15 (F)</option>
                            <option value=14>14 (E)</option>
                            <option value=13>13 (D)</option>
                            <option value=12>12 (C)</option>
                            <option value=11>11 (B)</option>
                            <option value=10>10 (A)</option>
                            <option value=9>9</option>
                            <option value=8>8</option>
                            <option value=7>7</option>
                            <option value=6>6</option>
                            <option value=5>5</option>
                            <option value=4>4</option>
                            <option value=3>3</option>
                            <option value=2>2</option>
                            <option value=1>1</option>
                            <option value=0>0</option>
                        </select>
                    </label>
                    <br/>
                    <label for="chkPermitDieback" title="Dieback worlds have 0 population but TL>0"><input checked="checked" type="checkbox" name="chkPermitDieback" id="chkPermitDieback" /> Permit Dieback Worlds</label>
                    <br/>
                    <label for="chkPopulateNonMainworlds" title="Check to allow population on worlds other than the system's mainworld"><input checked="checked" type="checkbox" name="chkPopulateNonMainworlds" id="chkPopulateNonMainworlds" /> Allow Non-Mainworld Pops</label>
                    <br/><fieldset>
                        <legend>Native Life</legend>
                        <label for="chkGenerateNatives"><input type="checkbox" id="chkGenerateNatives" title="chkGenerateNatives" checked="checked"> Generate Native Sophonts </label><br/>
                        <label for="slctNativeLikelihood">Likelihood <select id="slctNativeLikelihood">
                            <option value="really">All Candidate Worlds</option>
                            <option value="everywhere">Pervasive</option>
                            <option value="common" selected="selected">Common</option>
                            <option value="reasonable">Reasonable</option>
                            <option value="rare">Rare</option>
                        </select></label>
                        <br/><span style="font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Candidate homeworlds have Atmo 2+ and Pop 7+.
                            <br/>Unless "All Candidate Worlds" selected, natives less likely in exotic atmo.</span>
                    </fieldset>
                </fieldset>
                <fieldset class="collapsed travelcodepickers">
                    <legend>Travel Zones</legend>
                    <input type="button" value="Remove travel codes" id="btnClearTravelCodes" /><br/>
                    <fieldset class="collapsed">
                        <legend>Automatic Assignment</legend>
                        <input type="button" disabled=true value="Apply travel zones" id="btnApplyTravelCodes" />
                        <input type="button" disabled=true value="Thriggle Defaults" id="btnResetTravelCodes">
                        <input type="button" value="CE Defaults" id="btnCETravelCodes">
                        <input type="button" value="T5 Defaults" id="btnT5TravelCodes">
                        <br/>
                        <fieldset class="collapsed">
                            <legend>Habitation</legend>
                            <label for="slctRedZoneX" title="Pop>0 but Starport=X"><select data-color="Red" name="slctRedZoneX"  id="slctRedZoneX">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option selected="selected" value="Red">Red</option>
                            </select> Inhabited w/out Starport</label><br/>
                            <label for="slctAmberZoneBa" title="Barren worlds have 0 population and TL=0"><select data-color="Amber" name="slctAmberZoneBa"  id="slctAmberZoneBa">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Barren Worlds </label><br/>
                            <label for="slctAmberZoneBaX" title="Pop=0 and Starport=X"><select data-color="N/A" name="slctAmberZoneBaX"  id="slctAmberZoneBaX">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Uninhabited w/out Starport</label><br/>
                            <label for="slctAmberDieback" title="Dieback worlds have 0 population but TL>0"><select data-color="Red" name="slctAmberDieback" id="slctAmberDieback">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option selected="selected" value="Red">Red</option>
                            </select> Dieback Worlds </label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Atmosphere</legend>
                            <label for="slctAmberZoneAtmo"><select data-color="Amber" name="slctAmberZoneAtmo" id="slctAmberZoneAtmo">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Dangerous Atmospheres (<select id="slctDangerousAtmoThreshold">
                                <option value=10>10</option>
                                <option value=11>11</option>
                                <option selected="selected" value=12>12</option>
                                <option value=13>13</option>
                                <option value=14>14</option>
                                <option value=15>15</option>
                            </select>+, <select id="slctDangerousAtmoThresholdMax">
                                <option value=10>10</option>
                                <option value=11>11</option>
                                <option selected="selected" value=12>12</option>
                                <option value=13>13</option>
                                <option value=14>14</option>
                                <option value=15>15</option>
                            </select>-)</label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Law Level</legend>
                            <label for="slctRedGovLaw"><select name="slctRedGovLaw" data-color="Amber" id="slctRedGovLaw">
                                <option value="N/A">N/A</option>
                                <option selected="selected" value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Law + Government >= <select id="slctRedGovLawThreshold">
                                <option value=30>30</option>
                                <option value=29>29</option>
                                <option value=28>28</option>
                                <option value=27>27</option>
                                <option value=26>26</option>
                                <option value=25>25</option>
                                <option value=24>24</option>
                                <option value=23>23</option>
                                <option selected=selected value=22>22</option>
                                <option value=21>21</option>
                                <option value=20>20</option>
                                <option value=19>19</option>
                            </select></label><br/>
                            <label for="slctAmberGovLaw"><select name="slctAmberGovLaw" data-color="N/A" id="slctAmberGovLaw">
                                <option selected="selected" value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Law + Government >= <select id="slctAmberGovLawThreshold">
                                <option value=30>30</option>
                                <option value=29>29</option>
                                <option value=28>28</option>
                                <option value=27>27</option>
                                <option value=26>26</option>
                                <option value=25>25</option>
                                <option value=24>24</option>
                                <option value=23>23</option>
                                <option value=22>22</option>
                                <option value=21>21</option>
                                <option selected=selected value=20>20</option>
                                <option value=19>19</option>
                            </select></label><br/>
                            <label for="slctAmberZoneLL"><select name="slctAmberZoneLL" data-color="N/A" id="slctAmberZoneLL">
                                <option selected="selected" value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Highest LL World(s) (min <select id="slctMaxLawLevelThreshold">
                                <option value=15>15</option>
                                <option value=14>14</option>
                                <option value=13>13</option>
                                <option value=12>12</option>
                                <option value=11>11</option>
                                <option value=10>10</option>
                                <option selected=selected value=9>9</option>
                                <option value=8>8</option>
                            </select>+)</label><br/>
                            <label for="slctAmberZone9LL"><select data-color="N/A" name="slctAmberZone9LL" id="slctAmberZone9LL">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> High Law (<select id="slctLawLevelThreshold">
                                <option value=15>15</option>
                                <option value=14>14</option>
                                <option value=13>13</option>
                                <option value=12>12</option>
                                <option value=11>11</option>
                                <option value=10>10</option>
                                <option selected=selected value=9>9</option>
                                <option value=8>8</option>
                            </select>+) Worlds </label><br/>
                            <label for="slctAmberZone0LL"><select data-color="N/A" name="slctAmberZone0LL" id="slctAmberZone0LL">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Lawless Worlds</label><br/>
                        </fieldset>
                        <fieldset class="collapsed">
                            <legend>Government</legend>
                            <label for="slctAmberZoneGov0"><select data-color="N/A" name="slctAmberZoneGov0" id="slctAmberZoneGov0">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Ungoverned Worlds</label><br/>
                            <label for="slctAmberZoneGov7"><select data-color="N/A" name="slctAmberZoneGov7" id="slctAmberZoneGov7">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Balkanized Worlds</label><br/>
                            <label for="slctAmberZoneGov10"><select data-color="N/A" name="slctAmberZoneGov10" id="slctAmberZoneGov10">
                                <option value="N/A">N/A</option>
                                <option value="Amber">Amber</option>
                                <option value="Red">Red</option>
                            </select> Charismatic Dictatorships</label><br/>
                        </fieldset>
                        
                    </fieldset>
                   
                </fieldset>
                
        </fieldset>
        
        <fieldset class="collapsed">
            <legend>Export/Import</legend>            
            <fieldset class="collapsed">
                <legend>T5 Tab Delimited Format</legend>
                <label for="sectordata"><textarea placeholder="sectordata" title="sectordata" name="sectordata" id="sectordata" cols="150" rows="10"></textarea></label>
                <br/>
                <input type="button" value="Export to .tsv" id="btnExportCsv"/>
                <input type="button" value="Export to .txt" id="btnExportTxt"/>
                <input type="button" value="Export to .png Poster from TravellerMap.com" id="btnTravellerMapPoster" />
            </fieldset>
            <fieldset class="collapsed">
                <legend>JSON</legend>
                <label for="data"><textarea title="data" placeholder="data" name="data" id="data" cols="30" rows="10"></textarea></label>
                <br/>
                <input type="button" value="Export to .json" id="btnExportJSON"/> 
                <input type="button" value="Apply above JSON" id="btnApplyData"><br/>
                <label for="btnImportJSON">Load .json from file: </label><input type="file" Text="Import JSON" id="btnImportJSON" accept="text/*,.json"/>
            </fieldset>
            
        </fieldset>
    </fieldset>
    <br/>
    <canvas id="canvas"></canvas>
    
    <div id="SystemDetailsContainer" style="display:none;">
        <div id="SystemDetails">
            <h1><span data-system="tcoord"></span>: <span data-system="name">System Name</span><span id="dialog_close">X</span></h1>
            <h2><span title="Universal World Profile" data-system="uwp"></span> <span title="Trade Codes" data-mainworld="tradecodes" data-join=" "></span></h2>
            <h3 style="font-weight:normal; font-size:medium;" data-mainworld="tradecodes" data-lookup="tradecode" data-join=", " ></h3>
            <h3 style="font-weight: normal; font-family:'Consolas','Inconsolas','Courier New', Courier, monospace; font-size:small;"><span title="Universal World Profile" data-system="uwp"></span> <span title="Trade Codes" data-mainworld="tradecodes" data-join=" "></span> {<span data-importance="extension" title="Importance Extension" data-showsign="true">Importance</span>} (<span title="Economic Extension: Resources, Labor, Infrastructure, +Efficiency" data-economics="extension">Economics</span>) [<span title="Cultural Extension: Heterogeneity, Acceptance, Strangness, Symbols" data-culture="extension">Culture</span>]</h3>
            <h3 style="color:darkred"><span data-system="travelcodenotes"></span></h3>
            <fieldset>
                <legend>Importance and Economy</legend>
                <h4><span data-importance="description">System Importance</span> system (<span class="subnormal" data-importance="weeklytraffic"></span> ships/week)</h3>
                <h4><span class="subtitle">Available Resource Units:</span> <span class="subnormal" data-economics="RU" ></span></h3>
                <h4>
                    <span class="subtitle">Bases:</span> <span class="subnormal" data-system="bases" data-join=", " data-ifblank="None" >None</span> 
                    <span class="subtitle">Gas Giants:</span> <span class="subnormal" data-system="gg" data-ifblank="None" >None</span> 
                    <span class="subtitle">Planetoid Belts:</span> <span class="subnormal" data-system="planetoidBelts" data-ifblank="None" >None</span> 
                </h4>
            </fieldset>
            
            <fieldset>
                <legend>Mainworld Details</legend>
            
            <ul class="mainworlddetails">
                <li><strong>Starport</strong> <span data-mainworld="starport" data-lookup="port"></span> <span data-mainworld="highport" data-iftrue="(Has Highport)" data-iffalse="(No Highport)"></span></li>
                <li><strong>Size:</strong> <span data-mainworld="size" data-lookup="size"></span></li>
                <li><strong>Atmosphere:</strong> <span data-mainworld="atmo" data-lookup="atmo"></span></li>
                <li><strong>Hydrographics:</strong> <span data-mainworld="hydro" data-lookup="hydro"></span></li>
                <li><strong>Population:</strong> ~<span data-format="number" data-mainworld="roughpop"></span> (<span data-mainworld="popdigit"></span><span data-mainworld="pop" data-lookup="pop"></span>)</span></li>
                <li><strong>Government:</strong> <span data-mainworld="gov" data-lookup="gov"></span></li>
                <li><strong>Law:</strong> <span data-mainworld="law" data-lookup="law"></span></li>
                <li><strong>Tech Level:</strong> <span data-mainworld="tech" data-lookup="tech"></span></li>
                <li><strong>Climate:</strong> <span data-mainworld="climate" data-ifblank="N/A"></span></li>
                <li ><span style="display:inline-block; vertical-align:text-top;"><strong>Culture:</strong></span>
                    <span style="display:inline-block; vertical-align:text-top; max-width:400px">
                        <span data-culture="heterogeneity" data-lookup="heterogeneity"></span><span data-culture="acceptance" data-lookup="acceptance"></span><span data-culture="strangeness" data-lookup="strangeness"></span><span data-culture="symbols" data-lookup="symbols"></span>
                    </span>
                </li>
            </ul>
        </fieldset>
        <fieldset class="collapsed">
            <legend >System Map</legend>
            <ul id="maplist"></ul>
        </fieldset>
        <fieldset id="nativedetailscontainer" class="collapsed">
            <legend>Native Sophonts</legend>
            <div id="nativedetails">
                <h1>The <span data-detail="name" data-source="species"></span> of <span data-system="name"></span></h1>
                <fieldset>
                    <legend>Habitat</legend>
                    <div><strong>Breathes:</strong> <span data-detail="breathes" data-source="species"></span></div> 
                    <div><strong>Native Terrain:</strong> <span data-detail="nativeTerrain" data-source="species"></span></div>
                    <div><strong>Climate:</strong> <span data-detail="climate" data-source="species"></span></div>
                    <div><strong>Niche:</strong> <span data-detail="class" data-source="species"></span> (<span data-detail="niche" data-source="species"></span>)</div>
                </fieldset>
                <fieldset>
                    <legend>Physical Appearance</legend>
                    <div><strong>Locomotion:</strong> <span data-detail="locomotion" data-source="species"></span></div>
                    <div><strong>Symmetry: </strong><span data-detail="symmetry" data-source="species"></span></div>
                    <div><strong>Stance: </strong></strong><span data-detail="stance" data-source="species"></span></div>
                    <div><strong>Manipulators: </strong><span data-detail="allmanipulators" data-source="species"></span></div>
                    <div><strong>Natural Weapon: </strong><span data-detail="naturalweapon" data-source="species"></span></div>
                    <div><strong>Body Covering: </strong><span data-detail="skin" data-source="species"></span></div>
                    <div><strong>Skeletal Structure: </strong><span data-detail="skeleton" data-source="species"></span> <strong>Body Fluids: </strong><span data-detail="fluids" data-source="species"></span> </div>
                    <div><strong>Size:</strong> <span data-detail="sizeclass" data-source="species"></span> (<span data-detail="size" data-source="species"></span> kg, <span data-detail="height" data-source="species"></span>) <strong>Profile:</strong> <span data-detail="bfp" data-source="species"></span> (<span data-detail="bfpdesc" data-source="species"></span>)</div>
                    <div><strong>Body Plan: </strong><span data-detail="bodystructure" data-source="species"></span></div>
                    <table class="table">
                        <tr>
                            <th>Segment</th>
                            <th>Value</th>
                            <th>Limbs</th>
                            <th>Description</th>
                        </tr>
                        <tr>
                            <td>Head</td>
                            <td><span data-detail="head" data-source="species"></span></td>
                            <td> </td>
                            <td><span data-detail="headdesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Torso</td>
                            <td><span data-detail="torso" data-source="species"></span></td>
                            <td> </td>
                            <td><span data-detail="torsodesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Front Limbs</td>
                            <td><span data-detail="frontlimbs" data-source="species"></span></td>
                            <td><span data-detail="frontlimbs1" data-source="species"></span> <span data-detail="frontlimbs2" data-source="species"></span></td>
                            <td><span data-detail="frontlimbsdesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Rear Limbs</td>
                            <td><span data-detail="rearlimbs" data-source="species"></span></td>
                            <td><span data-detail="rearlimbs1" data-source="species"></span> <span data-detail="rearlimbs2" data-source="species"></span></td>
                            <td><span data-detail="rearlimbsdesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Other</td>
                            <td><span data-detail="tail" data-source="species"></span></td>
                            <td><span data-detail="taillimbs" data-source="species"></span></span></td>
                            <td><span data-detail="taildesc" data-source="species"></span></td>
                        </tr>
                    </table>
                    
                </fieldset>
                <fieldset>
                    <legend>Senses</legend>
                    <table class="table">
                        <tr>
                            <th>Sense</th>
                            <th>Capability</th>
                            <th>Notes</th>
                        </tr>
                        <tr>
                            <td>Vision</td>
                            <td><span data-detail="vision" data-source="species"></span></td>
                            <td>
                                <span data-detail="visiondesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Hearing</td>
                            <td><span data-detail="hearing" data-source="species"></span></td>
                            <td><span data-detail="hearingdesc" data-source="species"></span><br/>
                                <span data-detail="hearingrangedesc" data-source="species"></span>
                                <br/><span data-detail="voicedesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Smell</td>
                            <td><span data-detail="smell" data-source="species"></span></td>
                            <td><span data-detail="smelldesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Touch</td>
                            <td><span data-detail="touch" data-source="species"></span></td>
                            <td><span data-detail="touchdesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Aware</td>
                            <td><span data-detail="aware" data-source="species"></span></td>
                            <td><span data-detail="awaredesc" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td>Percept</td>
                            <td><span data-detail="percep" data-source="species"></span></td>
                            <td><span data-detail="percepdesc" data-source="species"></span></td>
                        </tr>
                    </table>
                    <div><strong>Note:</strong> Human senses are V-16-RGB, H-16-9382, S-10-02, and T-06-02</div>
                </fieldset>
                <fieldset>
                    <legend>Life and Society</legend>
                    <div><strong>Language: </strong><span data-detail="language" data-source="species"></span></div>
                    <div><strong>Life Expectancy:</strong> <span data-detail="lifeexpectancy" data-source="species"></span> years</div>
                    <div><strong>Genders:</strong> <span data-detail="genderstructure" data-source="species"></span> <strong>Assignment:</strong> <span data-detail="genderassignment" data-source="species"></span> (<span data-detail="gendershift" data-source="species"></span>)</div>
                    <div><strong>Caste:</strong> <span data-detail="castestructure" data-source="species">No</span> caste structure <strong>Assignment:</strong> <span data-detail="casteassignment" data-source="species"></span> (<span data-detail="casteshift" data-source="species"></span>)</div>
                    <div><strong>Caste-Gender Relation:</strong> <span data-detail="castegenderrelation" data-source="species"></span></div>  
                    <div><strong>Other Features: </strong><span class="traitlist" data-detail="uniqueTraitDesc" data-html="true" data-source="species"></span></div>
                    <table class="table">
                        <tr>
                            <th>#</th>
                            <th>Life Stage</th>
                            <th>Duration</th>
                            <th>Ages</th>
                            <th>Notes</th>
                        </tr>
                        <tr>
                            <td>0</td>
                            <td>Infant</td>
                            <td><span data-detail="lifestages" data-index="0" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="0" data-source="species"></span>-<span data-detail="lifestageupper" data-index="0" data-source="species"></span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>Child</td>
                            <td><span data-detail="lifestages" data-index="1" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="1" data-source="species"></span>-<span data-detail="lifestageupper" data-index="1" data-source="species"></span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Teen</td>
                            <td><span data-detail="lifestages" data-index="2" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="2" data-source="species"></span>-<span data-detail="lifestageupper" data-index="2" data-source="species"></span></td>
                            <td>Gender/Caste maturity.</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>Young Adult</td>
                            <td><span data-detail="lifestages" data-index="3" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="3" data-source="species"></span>-<span data-detail="lifestageupper" data-index="3" data-source="species"></span></td>
                            <td>Career resolution begins.</td>
                        </tr>
                        <tr>
                            <td>4</td>
                            <td>Adult</td>
                            <td><span data-detail="lifestages" data-index="4" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="4" data-source="species"></span>-<span data-detail="lifestageupper" data-index="4" data-source="species"></span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>5</td>
                            <td>Peak</td>
                            <td><span data-detail="lifestages" data-index="5" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="5" data-source="species"></span>-<span data-detail="lifestageupper" data-index="5" data-source="species"></span></td>
                            <td>Physical aging begins.</td>
                        </tr>
                        <tr>
                            <td>6</td>
                            <td>Mid-Life</td>
                            <td><span data-detail="lifestages" data-index="6" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="6" data-source="species"></span>-<span data-detail="lifestageupper" data-index="6" data-source="species"></span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>7</td>
                            <td>Senior</td>
                            <td><span data-detail="lifestages" data-index="7" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="7" data-source="species"></span>-<span data-detail="lifestageupper" data-index="7" data-source="species"></span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>8</td>
                            <td>Elder</td>
                            <td><span data-detail="lifestages" data-index="8" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="8" data-source="species"></span>-<span data-detail="lifestageupper" data-index="8" data-source="species"></span></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td>9</td>
                            <td>Retirement</td>
                            <td><span data-detail="lifestages" data-index="9" data-source="species"></span> years</td>
                            <td><span data-detail="lifestagelower" data-index="9" data-source="species"></span>-<span data-detail="lifestageupper" data-index="9" data-source="species"></span></td>
                            <td>Mental aging begins.</td>
                        </tr>
                    </table> 
                </fieldset>
                <fieldset>
                    <legend>Genetics and Abilities</legend>
                    <div><strong>Genetic Profile:</strong> <span data-detail="geneticprofile" data-source="species"></span>  <strong>DNA:</strong> <span data-detail="dna" data-source="species"></span> </div>
                    <table class="table">
                        <tr>
                            <th colspan="2"></th>
                            <th colspan="7">Genders</th>
                            <th colspan="11" data-hideifzero="castes" data-source="species">Castes</th>
                        </tr>
                        <tr>
                            <th></th>
                            <th>Baseline</th>
                            <th data-detail="genderdesc" data-index="0" data-source="species"></th>
                            <th data-detail="genderdesc" data-index="1" data-source="species"></th>
                            <th data-detail="genderdesc" data-index="2" data-source="species"></th>
                            <th data-detail="genderdesc" data-index="3" data-source="species"></th>
                            <th data-detail="genderdesc" data-index="4" data-source="species"></th>
                            <th data-detail="genderdesc" data-index="5" data-source="species"></th>
                            <th data-detail="genderdesc" data-index="6" data-source="species"></th>
                            <th data-detail="castedesc" data-index="0" data-source="species"></th>
                            <th data-detail="castedesc" data-index="1" data-source="species"></th>
                            <th data-detail="castedesc" data-index="2" data-source="species"></th>
                            <th data-detail="castedesc" data-index="3" data-source="species"></th>
                            <th data-detail="castedesc" data-index="4" data-source="species"></th>
                            <th data-detail="castedesc" data-index="5" data-source="species"></th>
                            <th data-detail="castedesc" data-index="6" data-source="species"></th>
                            <th data-detail="castedesc" data-index="7" data-source="species"></th>
                            <th data-detail="castedesc" data-index="8" data-source="species"></th>
                            <th data-detail="castedesc" data-index="9" data-source="species"></th>
                            <th data-detail="castedesc" data-index="10" data-source="species"></th>
                        </tr>
                        <tr>
                            <td><span data-detail="c1" data-source="species"></span></td>
                            <td><span data-detail="c1val" data-source="species"></span></td>
                            <td data-detail="genderc1s" data-index="0" data-source="species"></td>
                            <td data-detail="genderc1s" data-index="1" data-source="species"></td>
                            <td data-detail="genderc1s" data-index="2" data-source="species"></td>
                            <td data-detail="genderc1s" data-index="3" data-source="species"></td>
                            <td data-detail="genderc1s" data-index="4" data-source="species"></td>
                            <td data-detail="genderc1s" data-index="5" data-source="species"></td>
                            <td data-detail="genderc1s" data-index="6" data-source="species"></td>
                            <td data-detail="castec1s" data-index="0" data-source="species"></td>
                            <td data-detail="castec1s" data-index="1" data-source="species"></td>
                            <td data-detail="castec1s" data-index="2" data-source="species"></td>
                            <td data-detail="castec1s" data-index="3" data-source="species"></td>
                            <td data-detail="castec1s" data-index="4" data-source="species"></td>
                            <td data-detail="castec1s" data-index="5" data-source="species"></td>
                            <td data-detail="castec1s" data-index="6" data-source="species"></td>
                            <td data-detail="castec1s" data-index="7" data-source="species"></td>
                            <td data-detail="castec1s" data-index="8" data-source="species"></td>
                            <td data-detail="castec1s" data-index="9" data-source="species"></td>
                            <td data-detail="castec1s" data-index="10" data-source="species"></td>
                        </tr>
                        <tr>
                            <td><span data-detail="c2" data-source="species"></span></td>
                            <td><span data-detail="c2val" data-source="species"></span></td>
                            <td data-detail="genderc2s" data-index="0" data-source="species"></td>
                            <td data-detail="genderc2s" data-index="1" data-source="species"></td>
                            <td data-detail="genderc2s" data-index="2" data-source="species"></td>
                            <td data-detail="genderc2s" data-index="3" data-source="species"></td>
                            <td data-detail="genderc2s" data-index="4" data-source="species"></td>
                            <td data-detail="genderc2s" data-index="5" data-source="species"></td>
                            <td data-detail="genderc2s" data-index="6" data-source="species"></td>
                            <td data-detail="castec2s" data-index="0" data-source="species"></td>
                            <td data-detail="castec2s" data-index="1" data-source="species"></td>
                            <td data-detail="castec2s" data-index="2" data-source="species"></td>
                            <td data-detail="castec2s" data-index="3" data-source="species"></td>
                            <td data-detail="castec2s" data-index="4" data-source="species"></td>
                            <td data-detail="castec2s" data-index="5" data-source="species"></td>
                            <td data-detail="castec2s" data-index="6" data-source="species"></td>
                            <td data-detail="castec2s" data-index="7" data-source="species"></td>
                            <td data-detail="castec2s" data-index="8" data-source="species"></td>
                            <td data-detail="castec2s" data-index="9" data-source="species"></td>
                            <td data-detail="castec2s" data-index="10" data-source="species"></td>
                        </tr>
                        <tr>
                            <td><span data-detail="c3" data-source="species"></span></td>
                            <td><span data-detail="c3val" data-source="species"></span></td>
                            <td data-detail="genderc3s" data-index="0" data-source="species"></td>
                            <td data-detail="genderc3s" data-index="1" data-source="species"></td>
                            <td data-detail="genderc3s" data-index="2" data-source="species"></td>
                            <td data-detail="genderc3s" data-index="3" data-source="species"></td>
                            <td data-detail="genderc3s" data-index="4" data-source="species"></td>
                            <td data-detail="genderc3s" data-index="5" data-source="species"></td>
                            <td data-detail="genderc3s" data-index="6" data-source="species"></td>
                            <td data-detail="castec3s" data-index="0" data-source="species"></td>
                            <td data-detail="castec3s" data-index="1" data-source="species"></td>
                            <td data-detail="castec3s" data-index="2" data-source="species"></td>
                            <td data-detail="castec3s" data-index="3" data-source="species"></td>
                            <td data-detail="castec3s" data-index="4" data-source="species"></td>
                            <td data-detail="castec3s" data-index="5" data-source="species"></td>
                            <td data-detail="castec3s" data-index="6" data-source="species"></td>
                            <td data-detail="castec3s" data-index="7" data-source="species"></td>
                            <td data-detail="castec3s" data-index="8" data-source="species"></td>
                            <td data-detail="castec3s" data-index="9" data-source="species"></td>
                            <td data-detail="castec3s" data-index="10" data-source="species"></td>
                        </tr>
                    <tr>
                        <td><span data-detail="c4" data-source="species"></span></td>
                        <td><span data-detail="c4val" data-source="species"></span></td>
                        <td data-detail="genderc4s" data-index="0" data-source="species"></td>
                        <td data-detail="genderc4s" data-index="1" data-source="species"></td>
                        <td data-detail="genderc4s" data-index="2" data-source="species"></td>
                        <td data-detail="genderc4s" data-index="3" data-source="species"></td>
                        <td data-detail="genderc4s" data-index="4" data-source="species"></td>
                        <td data-detail="genderc4s" data-index="5" data-source="species"></td>
                        <td data-detail="genderc4s" data-index="6" data-source="species"></td>
                        <td data-detail="castec4s" data-index="0" data-source="species"></td>
                        <td data-detail="castec4s" data-index="1" data-source="species"></td>
                        <td data-detail="castec4s" data-index="2" data-source="species"></td>
                        <td data-detail="castec4s" data-index="3" data-source="species"></td>
                        <td data-detail="castec4s" data-index="4" data-source="species"></td>
                        <td data-detail="castec4s" data-index="5" data-source="species"></td>
                        <td data-detail="castec4s" data-index="6" data-source="species"></td>
                        <td data-detail="castec4s" data-index="7" data-source="species"></td>
                        <td data-detail="castec4s" data-index="8" data-source="species"></td>
                        <td data-detail="castec4s" data-index="9" data-source="species"></td>
                        <td data-detail="castec4s" data-index="10" data-source="species"></td>
                    </tr>
                    <tr>
                        <td><span data-detail="c5" data-source="species"></span></td>
                        <td><span data-detail="c5val" data-source="species"></span></td>
                        <td data-detail="genderc5s" data-index="0" data-source="species"></td>
                        <td data-detail="genderc5s" data-index="1" data-source="species"></td>
                        <td data-detail="genderc5s" data-index="2" data-source="species"></td>
                        <td data-detail="genderc5s" data-index="3" data-source="species"></td>
                        <td data-detail="genderc5s" data-index="4" data-source="species"></td>
                        <td data-detail="genderc5s" data-index="5" data-source="species"></td>
                        <td data-detail="genderc5s" data-index="6" data-source="species"></td>
                        <td data-detail="castec5s" data-index="0" data-source="species"></td>
                        <td data-detail="castec5s" data-index="1" data-source="species"></td>
                        <td data-detail="castec5s" data-index="2" data-source="species"></td>
                        <td data-detail="castec5s" data-index="3" data-source="species"></td>
                        <td data-detail="castec5s" data-index="4" data-source="species"></td>
                        <td data-detail="castec5s" data-index="5" data-source="species"></td>
                        <td data-detail="castec5s" data-index="6" data-source="species"></td>
                        <td data-detail="castec5s" data-index="7" data-source="species"></td>
                        <td data-detail="castec5s" data-index="8" data-source="species"></td>
                        <td data-detail="castec5s" data-index="9" data-source="species"></td>
                        <td data-detail="castec5s" data-index="10" data-source="species"></td>
                    </tr>
                    <tr>
                        <td><span data-detail="c6" data-source="species"></span></td>
                        <td><span data-detail="c6val" data-source="species"></span></td>
                        <td data-detail="genderc6s" data-index="0" data-source="species"></td>
                        <td data-detail="genderc6s" data-index="1" data-source="species"></td>
                        <td data-detail="genderc6s" data-index="2" data-source="species"></td>
                        <td data-detail="genderc6s" data-index="3" data-source="species"></td>
                        <td data-detail="genderc6s" data-index="4" data-source="species"></td>
                        <td data-detail="genderc6s" data-index="5" data-source="species"></td>
                        <td data-detail="genderc6s" data-index="6" data-source="species"></td>
                        <td data-detail="castec6s" data-index="0" data-source="species"></td>
                        <td data-detail="castec6s" data-index="1" data-source="species"></td>
                        <td data-detail="castec6s" data-index="2" data-source="species"></td>
                        <td data-detail="castec6s" data-index="3" data-source="species"></td>
                        <td data-detail="castec6s" data-index="4" data-source="species"></td>
                        <td data-detail="castec6s" data-index="5" data-source="species"></td>
                        <td data-detail="castec6s" data-index="6" data-source="species"></td>
                        <td data-detail="castec6s" data-index="7" data-source="species"></td>
                        <td data-detail="castec6s" data-index="8" data-source="species"></td>
                        <td data-detail="castec6s" data-index="9" data-source="species"></td>
                        <td data-detail="castec6s" data-index="10" data-source="species"></td>
                    </tr>
                    <tr>
                        <td>Odor</td>
                        <td><span data-detail="scent" data-source="species"></span></td>
                        <td data-detail="genderscents" data-index="0" data-source="species"></td>
                        <td data-detail="genderscents" data-index="1" data-source="species"></td>
                        <td data-detail="genderscents" data-index="2" data-source="species"></td>
                        <td data-detail="genderscents" data-index="3" data-source="species"></td>
                        <td data-detail="genderscents" data-index="4" data-source="species"></td>
                        <td data-detail="genderscents" data-index="5" data-source="species"></td>
                        <td data-detail="genderscents" data-index="6" data-source="species"></td>
                        <td data-detail="castescents" data-index="0" data-source="species"></td>
                        <td data-detail="castescents" data-index="1" data-source="species"></td>
                        <td data-detail="castescents" data-index="2" data-source="species"></td>
                        <td data-detail="castescents" data-index="3" data-source="species"></td>
                        <td data-detail="castescents" data-index="4" data-source="species"></td>
                        <td data-detail="castescents" data-index="5" data-source="species"></td>
                        <td data-detail="castescents" data-index="6" data-source="species"></td>
                        <td data-detail="castescents" data-index="7" data-source="species"></td>
                        <td data-detail="castescents" data-index="8" data-source="species"></td>
                        <td data-detail="castescents" data-index="9" data-source="species"></td>
                        <td data-detail="castescents" data-index="10" data-source="species"></td>
                    </tr>
                    <tr>
                        <td colspan="2">Special Abilities</td>
                        <td data-detail="genderabilities" data-index="0" data-source="species"></td>
                        <td data-detail="genderabilities" data-index="1" data-source="species"></td>
                        <td data-detail="genderabilities" data-index="2" data-source="species"></td>
                        <td data-detail="genderabilities" data-index="3" data-source="species"></td>
                        <td data-detail="genderabilities" data-index="4" data-source="species"></td>
                        <td data-detail="genderabilities" data-index="5" data-source="species"></td>
                        <td data-detail="genderabilities" data-index="6" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="0" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="1" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="2" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="3" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="4" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="5" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="6" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="7" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="8" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="9" data-source="species"></td>
                        <td data-detail="casteabilities" data-index="10" data-source="species"></td>
                    </tr>
                    </table>
                    <table class="table">
                        <tr>
                            <th>Gender</th>
                            <th>2D</th>
                            <th>Caste</th>
                        </tr>
                        <tr>
                            <td><span data-detail="gender2" data-source="species"></span></td>
                            <td>2</td>
                            <td><span data-detail="caste2" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender3" data-source="species"></span></td>
                            <td>3</td>
                            <td><span data-detail="caste3" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender4" data-source="species"></span></td>
                            <td>4</td>
                            <td><span data-detail="caste4" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender5" data-source="species"></span></td>
                            <td>5</td>
                            <td><span data-detail="caste5" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender6" data-source="species"></span></td>
                            <td>6</td>
                            <td><span data-detail="caste6" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender7" data-source="species"></span></td>
                            <td>7</td>
                            <td><span data-detail="caste7" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender8" data-source="species"></span></td>
                            <td>8</td>
                            <td><span data-detail="caste8" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender9" data-source="species"></span></td>
                            <td>9</td>
                            <td><span data-detail="caste9" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender10" data-source="species"></span></td>
                            <td>10</td>
                            <td><span data-detail="caste10" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender11" data-source="species"></span></td>
                            <td>11</td>
                            <td><span data-detail="caste11" data-source="species"></span></td>
                        </tr>
                        <tr>
                            <td><span data-detail="gender12" data-source="species"></span></td>
                            <td>12</td>
                            <td><span data-detail="caste12" data-source="species"></span></td>
                        </tr>
                    </table>
                    <fieldset class="roller">
                        <legend>Roll for Special</legend>
                        <input type="button" value="Roll for Special Ability" id="btnGetSpecialAbility"/>
                        <br/><span id="specialAbility"></span>
                        <div>
                            <input type="button" value="Roll for Skilled Caste" id="btnGetCasteSkill"/>
                            <br/><span id="casteSkill"></span>
                        </div>
                    </fieldset>
                    <ul class="statnotes"></ul>
                </fieldset>
            </div>
        </fieldset>
        </div>
    </div>
    <script src="js/NameGenerator.js"></script>
    <script>
        (function(){
            //globals
            var wordMaker;
            var HEX_SIZE = 27,
                HEX_BORDER_COLOR = "white",
                HEX_BACKGROUND_COLOR = "rgba(0,0,0,0.7)",
                HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)",
                CANVAS_BACKGROUND_COLOR = "rgb(50,50,50)",
                CAPITAL_TEXT_COLOR = "rgb(255,100,100)",
                CAPITAL_BACKGROUND_COLOR = "black",
                TEXT_COLOR = "white",
                CANVAS_PADDING = 20,
                SUBSECTOR_WIDTH = 8,
                SUBSECTOR_HEIGHT = 10,
                FONT = "sans-serif";
            var HEX_MATH = {
                radius:HEX_SIZE,
                xOffset:HEX_SIZE*3,
                yOffset:HEX_SIZE*4,
                diameter:HEX_SIZE*2
            }
            // 0-7 UWP, 8 importance, 9 total pop, 10 RU
            var mins = [-1,-1,-1,-1,-1,-1,-1,-1,-3,-1,-1], 
            maxes = [0,0,0,0,0,0,0,0,5,0,0], 
            labels = ["starport","size","atmo","hydro","pop","gov","law","tech"];
            var systems = {};
            var routes = [];
            
            var canvas = document.getElementById("canvas");
            canvas.setAttribute("width",SUBSECTOR_WIDTH*HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
            canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter + CANVAS_PADDING*2);
            var ctx = canvas.getContext('2d');
            
            var mapContent = [];
            document.getElementById("sizeSlider").value = HEX_SIZE;
            mapContent = generateHexes(SUBSECTOR_WIDTH,SUBSECTOR_HEIGHT);
            updateStyle();
            var fontSize = HEX_SIZE*1/3;
            ctx.font = ""+fontSize+"pt "+FONT;
            drawMap(mapContent);
            if(window.location.hash){
                processHash();
            }
            NameGenerator("js/names.jsonc",function(o){wordMaker = o; populateSubsector();},null,MathRandom);
            var lastHighlightedHex, lastSelectedHex;
            attachEventListeners();
            function processHash(){
                // first time process hash on page load
                var hash = window.location.hash;
                var seed = window.location.hash.substr(1);
                if(hash.indexOf("$") > 0){
                    seed = "";
                    var hashParamPairs = hash.substr(1).split("&");
                    console.log(hashParamPairs);
                    for(var i = 0, len = hashParamPairs.length; i < len; i++){
                        var pair = hashParamPairs[i].split("=");
                        console.log(pair);
                        if(pair[0].toLowerCase() === "$seed"){
                            seed = pair[1];
                        }
                        if(pair[0].toLowerCase() === "$size"){
                            var newSize = pair[1];
                            if(typeof newSize !== "undefined" && newSize.length > 0){
                                console.log("size = "+ newSize);
                                document.getElementById("slctMapSize").value = addCaps(newSize);
                                mapSizeChanged();
                            }
                        }
                        if(pair[0].toLowerCase() === "$density"){
                            var newDensity = pair[1];
                            if(typeof newDensity !== "undefined" && newDensity.length > 0){
                                console.log("density = "+ newDensity);
                                document.getElementById("slctStellarDensity").value = addCaps(newDensity);
                            }
                        }
                    }
                }
                if(seed.length > 0){
                    document.getElementById("txtSeed").value = decodeURI(seed);
                    document.getElementById("chkUseRandom").checked = false;
                    MathRandom = pseudoRandomNumberGenerator(decodeURI(seed));
                }
            }
            function attachEventListeners(){
                var abilityRoll = 0, skillRoll = 0;
                document.getElementById("btnGetSpecialAbility").addEventListener("click",function(){
                    var output = document.getElementById("specialAbility");
                    removeChildElements(output);
                    output.innerHTML = "Roll " + ++abilityRoll + ": " + getRandomSpecialAbility();
                });
                document.getElementById("btnGetCasteSkill").addEventListener("click",function(){
                    var output = document.getElementById("casteSkill");
                    removeChildElements(output);
                    output.innerHTML = "Roll " + ++skillRoll + ": " + getCasteSkill();
                });
                canvas.addEventListener("mousemove",function(e){
                    var hexIdentified = false;
                    var x = e.clientX - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                    var y = e.clientY - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                    if(lastHighlightedHex){
                        if(coordsInHexagon(x,y,lastHighlightedHex)){
                            hexIdentified = true;
                        }else{
                            lastHighlightedHex.highlighted = false;
                        }
                    }
                    if(!hexIdentified){
                        for(var i = 0, len = mapContent.length; i < len; i++){
                            var hex = mapContent[i];
                            if(!hexIdentified){
                                if(coordsInHexagon(x,y, hex)){
                                    hex.highlighted = true;
                                    hexIdentified = true;
                                    if(lastHighlightedHex){
                                        lastHighlightedHex.highlighted = false;
                                    }
                                    lastHighlightedHex = hex;
                                    drawMap(mapContent);
                                    break;
                                }
                            }
                        }
                        
                    }
                });
                canvas.addEventListener("click",function(e){
                    var x = e.clientX - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().left;
                    var y = e.clientY - HEX_MATH.diameter - CANVAS_PADDING - canvas.getBoundingClientRect().top;
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(coordsInHexagon(x,y, hex)){
                            if(hex.selected){
                                hex.selected = false;
                                var detailBlock = document.getElementById("SystemDetailsContainer");
                                detailBlock.style.display = "none";
                            }
                            else{
                                if(lastSelectedHex){
                                    lastSelectedHex.selected = false;
                                }
                                hex.selected = true;
                                lastSelectedHex = hex;
                                var detailBlock = document.getElementById("SystemDetailsContainer");
                                if(hex.system){
                                    renderSystem(hex.system);
                                    detailBlock.style.left = e.pageX + "px";// - canvas.getBoundingClientRect().left +"px";
                                    detailBlock.style.top = e.pageY + "px";//- canvas.getBoundingClientRect().top+"px";
                                    detailBlock.style.display = "inline-block";
                                }else{
                                    detailBlock.style.display = "none";
                                }
                                break;                                
                            }
                        }else{
                            if(hex.selected){
                                hex.selected = false;
                            }
                        }
                    }
                    drawMap(mapContent);
                });
                canvas.addEventListener("mouseout",function(e){
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(hex.highlighted){
                            hex.highlighted = false;
                        }
                    }
                    drawMap(mapContent);
                });
                var collapserHandles = document.querySelectorAll("fieldset legend");
                for(var i = 0, len = collapserHandles.length; i < len; i++){
                    var handle = collapserHandles[i];
                    handle.addEventListener("click",function(e){
                        var parent = e.target.parentElement;
                        if(parent.classList.contains("collapsed")){
                            parent.classList.remove("collapsed");
                        }else{
                            parent.classList.add("collapsed");
                        }
                    });
                }
                document.getElementById("dialog_close").addEventListener("click",function(){
                    document.getElementById("SystemDetailsContainer").style.display = "none";
                    if(lastSelectedHex){
                        lastSelectedHex.selected = false;
                    }
                    removeChildElements(document.getElementById("specialAbility"));
                    removeChildElements(document.getElementById("casteSkill"));
                });
                document.getElementById("txtSeed").addEventListener("keyup",function(e){
                    MathRandom = pseudoRandomNumberGenerator(this.value);
                    wordMaker.setRandom(MathRandom);
                    if(e.keyCode == 13){
                        document.getElementById("chkUseRandom").checked = false;
                        populateSubsector();
                    }                   
                });
                document.getElementById("slctMapSize").addEventListener("change",mapSizeChanged);
                
                document.getElementById("fontFamily").addEventListener("keyup",updateStyle);
                document.getElementById("hexBorderColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBorderColor").value;
                    updateHexBorderColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexfg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("textColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("textColor").value;
                    updateTextColor(newColor);
                    drawMap(mapContent);
                });
                document.getElementById("hexBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("hexBackgroundColor").value;
                    updateHexBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-hexbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("canvasBackgroundColor").addEventListener("keyup",function(){
                    var newColor = document.getElementById("canvasBackgroundColor").value;
                    updateCanvasBackgroundColor(newColor);
                    document.getElementById("slctStyle").setAttribute("data-canvasbg",newColor);
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyData").addEventListener("click",function(){
                    var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, JSON.parse(document.getElementById("data").value));
                    document.getElementById("sectordata").value = getSectorData(mapContent);
                    var systems = [];
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(hex.system){
                            systems.push(hex.system);
                        }
                    }
                    drawMap(mapContent);
                });
                document.getElementById("btnPopulateSystems").addEventListener("click",populateSubsector);
                document.getElementById("btnClearSystems").addEventListener("click",function(){
                    //var mapContent = [];
                    //document.getElementById("sizeSlider").value = HEX_SIZE;
                    mapContent = generateHexes(SUBSECTOR_WIDTH,SUBSECTOR_HEIGHT);
                    //updateStyle();
                    //ctx.font = ""+fontSize+"pt "+FONT;
                    drawMap(mapContent);
                });
                document.getElementById("slcHeatMap").addEventListener("change",function(){
                    drawMap(mapContent);
                });
                document.getElementById("chkShowTravelCodes").addEventListener("change",function(){
                    drawMap(mapContent);
                });
                document.getElementById("btnApplyTravelCodes").addEventListener("click",function(){
                    applyTravelCodes(mapContent);
                    drawMap(mapContent);
                    document.getElementById("sectordata").value = getSectorData(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = true;
                });
                document.getElementById("btnClearTravelCodes").addEventListener("click",function(){
                    clearTravelCodes(mapContent);
                    drawMap(mapContent);
                    document.getElementById("sectordata").value = getSectorData(mapContent);
                    document.getElementById("btnApplyTravelCodes").disabled = false;
                });
                document.getElementById("btnResetTravelCodes").addEventListener("click",resetTravelCodes);
                document.getElementById("btnCETravelCodes").addEventListener("click",selectCETravelCodes);
                document.getElementById("btnT5TravelCodes").addEventListener("click",selectT5TravelCodes);
                var zonePickers = document.querySelectorAll("select[data-color]");
                for(var i = 0, len = zonePickers.length; i < len; i++){
                    zonePickers[i].addEventListener("change",function(e){
                        e.target.setAttribute("data-color",e.target.value);
                        document.getElementById("btnApplyTravelCodes").disabled = false;
                        document.getElementById("btnResetTravelCodes").disabled = false;
                    });
                }

                document.getElementById("slctAmberGovLawThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctDangerousAtmoThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctDangerousAtmoThresholdMax").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctRedGovLawThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctMaxLawLevelThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("slctLawLevelThreshold").addEventListener("change",function(){
                    document.getElementById("btnApplyTravelCodes").disabled = false; 
                    document.getElementById("btnResetTravelCodes").disabled = false;
                });
                document.getElementById("btnExportCsv").addEventListener("click",function(){
                    var sectorData = document.getElementById("sectordata").value;
                    var a = document.createElement("a");
                    a.href = "data:text/tab-separated-values;charset=utf-8,"+encodeURIComponent(sectorData);
                    a.download = document.getElementById("txtSeed").value+".tsv";
                    a.click();
                });
                document.getElementById("btnExportTxt").addEventListener("click",function(){
                    var sectorData = document.getElementById("sectordata").value;
                    var a = document.createElement("a");
                    a.href = "data:text/tab-separated-values;charset=utf-8,"+encodeURIComponent(sectorData);
                    a.download = document.getElementById("txtSeed").value+".txt";
                    a.click();
                });
                document.getElementById("btnExportJSON").addEventListener("click",function(){
                    var sectorData = document.getElementById("data").value;
                    var a = document.createElement("a");
                    a.href = "data:text/json;charset=utf-8,"+encodeURIComponent(sectorData);
                    a.download = document.getElementById("txtSeed").value+".json";
                    a.click();
                });
                document.getElementById("btnImportJSON").addEventListener("change", function(){
                    var curFiles = document.getElementById("btnImportJSON").files;
                    if(curFiles.length > 0){
                        var reader = new FileReader();
                        reader.onload = function(event){
                            document.getElementById("data").value = event.target.result;
                            document.getElementById("btnApplyData").click();
                            document.getElementById("txtSeed").value = curFiles[0].name.replace(".json","");
                        }
                        reader.readAsText(curFiles[0]);
                        
                    }
                });
                document.getElementById("btnSaveImg").addEventListener("click",function(){
                    var a = document.createElement("a");
                    a.href = canvas.toDataURL("image/png");
                    a.download = document.getElementById("txtSeed").value+".png";
                    a.click();
                });
                document.getElementById("btnTravellerMapPoster").addEventListener("click",function(){
                    var sectorData = document.getElementById("sectordata").value;
                    var xhr = new XMLHttpRequest();
                    xhr.open("POST","https://travellermap.com/api/poster",true);
                    xhr.responseType = "arraybuffer";
                    xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
                    xhr.onreadystatechange = function(){
                        if(xhr.readyState === 4){
                            if(xhr.status === 200){
                                var bytes = new Uint8Array(xhr.response);
                                var len = bytes.byteLength, binary = '';
                                for (var i = 0; i < len; i++) {
                                    binary += String.fromCharCode( bytes[ i ] );
                                }
                                var blob = new Blob([xhr.response], {type: "image/png"});
                                var objectUrl = URL.createObjectURL(blob);
                                var img = document.createElement("a");
                                img.href = objectUrl;
                                img.download = "travmap_"+document.getElementById("txtSeed").value+".png";
                                img.click();                                
                            }

                        }
                    };
                    var size = document.getElementById("slctMapSize").value;
                    var subsector = ""
                    if(size==="Subsector"){
                        subsector = "&subsector=A";
                    }else if(size === "Quadrant"){
                        subsector = "&quadrant=Alpha"
                    }
                    xhr.send("data="+encodeURIComponent(sectorData)+subsector);
                });
                // event listener when window.location.hash changes
                window.addEventListener("hashchange", function(){
                    console.log("hash change");
                    var hash = window.location.hash;
                    if(hash.length > 0){
                        var seed = hash.substring(1), newSize = "", newDensity = "";
                        if(hash.indexOf("$") >= 0){
                            seed = "";
                            var hashParamPairs = hash.substr(1).split("&");
                            for(var i = 0, len = hashParamPairs.length; i < len; i++){
                                var pair = hashParamPairs[i].split("=");
                                if(pair[0].toLowerCase() === "$seed"){
                                    seed = pair[1];
                                }
                                if(pair[0].toLowerCase() === "$size"){
                                    newSize = pair[1];
                                    if(typeof newSize !== "undefined" && newSize.length > 0){
                                        newSize = addCaps(newSize);
                                        document.getElementById("slctMapSize").value = newSize;
                                    }
                                }
                                if(pair[0].toLowerCase() === "$density"){
                                    newDensity = pair[1];
                                    if(typeof newDensity !== "undefined" && newSize.length > 0){
                                        newDensity = addCaps(newDensity);
                                        document.getElementById("slctStellarDensity").value = newDensity;
                                    }
                                }
                            }
                            var newValue = decodeURI(seed);
                            if(document.getElementById("txtSeed").value == newValue && document.getElementById("slctStellarDensity").value == newDensity && document.getElementById("slctMapSize").value == newSize){
                                
                            }else{
                                document.getElementById("txtSeed").value = newValue;
                                var wasChecked = document.getElementById("chkUseRandom").checked;
                                if(typeof seed === "undefined" || seed.length === 0){
                                    document.getElementById("chkUseRandom").checked = true;
                                }else{
                                    document.getElementById("chkUseRandom").checked = false;
                                }
                                populateSubsector();
                                document.getElementById("chkUseRandom").checked = wasChecked;
                            }
                        }
                    }
                });
            }
            function mapSizeChanged(){
                    var choice = document.getElementById("slctMapSize").value;
                    switch(choice){
                        case "Subsector": SUBSECTOR_HEIGHT = 10; SUBSECTOR_WIDTH = 8; break;
                        case "Quadrant": SUBSECTOR_HEIGHT = 20; SUBSECTOR_WIDTH = 16; break;
                        case "Sector": SUBSECTOR_HEIGHT = 40; SUBSECTOR_WIDTH = 32; break;
                    }
                    //updateHexSize(+(document.getElementById("sizeSlider").value));
                    canvas.setAttribute("width",SUBSECTOR_WIDTH*HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
                    canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter + CANVAS_PADDING*2);
                    drawMap(mapContent);
                }
                document.getElementById("slctStyle").addEventListener("change",updateStyle);
                document.getElementById("sizeSlider").addEventListener("change",function(){
                    updateHexSize(+(document.getElementById("sizeSlider").value));
                    drawMap(mapContent);
                });
            function populateSubsector(){
                var useRandomSeed = document.getElementById("chkUseRandom").checked;
                var seed;
                if(useRandomSeed){ 
                    seed1 = Math.floor(Math.random()*1000000);
                    //MathRandom = pseudoRandomNumberGenerator(seed1.toString());
                    //wordMaker.setRandom(MathRandom);
                    seed = addCaps(wordMaker.getRandomName("system")+seed1);
                    //seed = "xCamp Arngarfps891823"
                    document.getElementById("txtSeed").value = seed;
                   
                }else{
                    seed = document.getElementById("txtSeed").value
                } 
                
                //console.log("Setting window hash");
                var $density = document.getElementById("slctStellarDensity").value
                console.log("density = " + $density);
                var $size = document.getElementById("slctMapSize").value
                console.log("size = " + $size);
                window.location.hash = "$seed="+encodeURI(seed)+"&$density="+$density+"&$size="+$size;
                
                //console.log("Seeding number generators");
                MathRandom = pseudoRandomNumberGenerator(seed.toString());
                wordMaker.setRandom(MathRandom);
                
                //console.log("Generating subsector map");
                
                var ggFrequency = document.getElementById("slctGGFrequency").value;
                var density = document.getElementById("slctStellarDensity").value;
                var permitDieback = document.getElementById("chkPermitDieback").checked;
                var maxTechLevel = document.getElementById("slctMaxTechLevel").value;
                var d = 1, target = 3, systems = {};
                switch(density){
                    case "Extra Galactic": d = 3, target = 3; break;
                    case "Rift": d = 2, target = 2; break;
                    case "Sparse": d = 1, target = 1; break;
                    case "Scattered": d = 1, target = 2; break;
                    case "Standard": d = 1, target = 3; break;
                    case "Dense": d = 1, target = 4; break;
                    case "Cluster": d = 1, target = 5; break;
                    case "Core": d = 2, target = 11; break;
                    case "Clump": d = 1, target = 2; break;
                }
                var namesSoFar = {};
                //  0-7 = UWP, 8 = Importance, 9 = Total Pop, 10 = RUs
                mins = [-1,-1,-1,-1,-1,-1,-1,-1,-3,-1,-1], maxes = [0,0,0,0,0,0,0,0,5,0,0];
                var systemArray = [];
                for(var x = 0; x < SUBSECTOR_WIDTH; x++){
                    for(var y = 0; y < SUBSECTOR_HEIGHT; y++){
                        if(density === "Clump"){
                            if(x >= SUBSECTOR_WIDTH/3 && x <= SUBSECTOR_WIDTH*2/3 && y >= SUBSECTOR_HEIGHT/3 && y <= SUBSECTOR_HEIGHT*2/3){
                                target = 4;
                            }else if(x >= SUBSECTOR_WIDTH/4 && x <= SUBSECTOR_WIDTH*3/4 && y >= SUBSECTOR_HEIGHT/4 && y <= SUBSECTOR_HEIGHT*3/4){
                                target = 3;
                            }else if(x >= SUBSECTOR_WIDTH/8 && x <= SUBSECTOR_WIDTH*7/8 && y >= SUBSECTOR_HEIGHT/8 && y <= SUBSECTOR_HEIGHT*7/8){
                                target = 2;
                            }else{
                                target = 1;
                            }
                        }
                        if(d6(d) <= target){
                            var name = wordMaker.getRandomName("system");
                            while(Object.keys(namesSoFar).indexOf(name) >= 0){
                                name = wordMaker.getRandomName("system");
                            }
                            while(name.indexOf("ths") >= 0){ 
                                name = name.replace("ths","th");

                            }
                            var tcoord = XYCoordToTCoord(x,y);
                            //console.log("Adding " + name + " to " + tcoord);
                            namesSoFar[name] = {hexlocation:tcoord,x:x,y:y};
                            var details = generateSystemDetails(addCaps(name), ggFrequency,document.getElementById("chkPermitDieback").checked,maxTechLevel,0,document.getElementById("slctMainworldRules").value,document.getElementById("chkPopulateNonMainworlds").checked);
                            //console.log(details);
                            for(var i = 0, len = mins.length; i < len; i++){
                                var currValue;
                                if(i < 8){
                                    currValue = details.mainworld[labels[i]];
                                    var currMin = mins[i], currMax = maxes[i];
                                    if(currValue < currMin){ mins[i] = currValue;}
                                    if(currValue > currMax){ maxes[i] = currValue;}
                                }
                                else if(i === 8){
                                    currValue = details.importance.extension;
                                }else if(i === 9){
                                    currValue = details.totalpop;
                                    if(currValue > 0){ currValue = Math.round(Math.log10(currValue)); }
                                    var currMin = mins[i], currMax = maxes[i];
                                    if(currValue < currMin){ mins[i] = currValue;}
                                    if(currValue > currMax){ maxes[i] = currValue;}
                                }else if(i === 10){
                                    currValue = details.economics.RU;
                                    var currMin = mins[i], currMax = maxes[i];
                                    if(currValue < currMin){ mins[i] = currValue; }
                                    if(currValue > currMax){ maxes[i] = currValue; }
                                }
                                
                            }
                            var system = {                                    
                                name: addCaps(name),
                                mainworld:details.mainworld,
                                uwp: details.uwp.toUpperCase(),
                                gg:details.gg,
                                isAsteroidBelt:details.mainworld.isAsteroidBelt,
                                planetoidBelts:details.planetoidBelts,
                                bases:details.bases,
                                stars:details.stars,
                                economics: details.economics,
                                importance: details.importance,
                                totalpop: details.totalpop,
                                tcoord: tcoord,
                                pbg: details.pbg,
                                allegiance: details.allegiance,
                                isRed:false,
                                isAmber:false
                            };
                            systems[tcoord] = system;
                            systemArray.push(system);
                        }
                    }
                }
                
                analyzeMap(systemArray);
                document.getElementById("data").value = JSON.stringify(systems);
                var mapContent = generateHexes(SUBSECTOR_WIDTH, SUBSECTOR_HEIGHT, systems);
                applyTravelCodes(mapContent);
                document.getElementById("sectordata").value = getSectorData(mapContent);
                if(document.getElementById("chkGenerateNatives").checked){
                    generateNatives(mapContent, document.getElementById("slctNativeLikelihood").value);
                }
                drawMap(mapContent);                
            }
            function generateNatives(mapContent, likelihood){                
                var max = 0;
                switch(likelihood){
                    case "rare": // ~1 per sector
                        max = 45;
                        break;
                    case "reasonable": // ~1 per subsector
                        max = 9;
                        break;
                    case "common": // 1 in 2 chance per candidate world
                        max = 2;
                        break;
                    case "everywhere": // every non-exotic candidate world
                        max = 1;
                        break;
                    case "really": // every candidate world
                        max = 1;
                        break;
                }
                var lifecount = 0;
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(mapContent[i].system){
                        if(mapContent[i].system.mainworld.atmo >= 2 && mapContent[i].system.mainworld.pop >= 7){
                            //console.log( mapContent[i].system.name + ": " + mapContent[i].system.mainworld.atmo +", " + mapContent[i].system.mainworld.pop);
                            var isExotic = likelihood !== "really" && mapContent[i].system.mainworld.atmo >= 10 && mapContent[i].system.mainworld.atmo <= 12;
                            var exoticMod = isExotic ? mapContent[i].system.mainworld.atmo - 9 : 0;
                            var check = ((MathRandom()*(max+exoticMod)) >>> 0)+1;
                            if(check === 1){
                                lifecount++;
                                //console.log("Native Intelligence on " + mapContent[i].system.tcoord + " " + mapContent[i].system.name + "!");
                                var species = {name:addCaps(wordMaker.getRandomName("word"))};
                                species.homeworld = mapContent[i].system;
                                generateRandomAlien(species, MathRandom);
                                delete species.homeworld;
                                mapContent[i].system.natives = species;
                            }
                        }
                    }
                }
                console.log(lifecount +" natives generated.");
            }
            function getSectorData(map){
                var sectordata = "Hex\tName\tUWP\tBases\tRemarks\tZone\tPBG\tAllegiance\tStars\t{Ix}\t(Ex)\t[Cx]";
                for(var i = 0, len = map.length; i < len; i++){
                    if(typeof map[i].system !== "undefined"){
                        var system = map[i].system;
                        sectordata += "\n"
                        + system.tcoord+"\t"
                        + system.name+"\t"
                        + system.uwp+"\t"
                        + getBasesAbbrev(system.bases)+"\t"
                        + system.mainworld.tradecodes.join(" ")+"\t"
                        + (system.isRed ? "R" : (system.isAmber ? "A" : ""))+"\t"
                        + system.pbg+"\t"
                        + system.allegiance+"\t"
                        + getStarsAbbrev(system.stars) + "\t"
                        + "{"+(system.importance.extension>0?"+":"")+system.importance.extension+"}\t"
                        + "("+system.economics.extension+")\t"
                        + "["+system.mainworld.cultural.extension+"]";
                    }
                }
                return sectordata;
            }
            function getStarsAbbrev(stars){
                var abbrev = getStarAbbrev(stars.primary);
                if(stars.primary_companion){
                    abbrev += " " + getStarAbbrev(stars.primary_companion);
                }
                if(stars.close){
                    abbrev += " " + getStarAbbrev(stars.close);
                    if(stars.close_companion){
                        abbrev += " " + getStarAbbrev(stars.close_companion);
                    }
                }
                if(stars.near){
                    abbrev += " " + getStarAbbrev(stars.near);
                    if(stars.near_companion){
                        abbrev += " " + getStarAbbrev(stars.near_companion);
                    }
                }
                if(stars.far){
                    abbrev += " " + getStarAbbrev(stars.far);
                    if(stars.far_companion){
                        abbrev += " " + getStarAbbrev(stars.far_companion);
                    }
                }
                return abbrev;
            }
            function getStarAbbrev(star){
                var abbrev = "";
                if(star.size === "D"){
                    abbrev = "D";
                }else if(star.type === "BD"){
                    abbrev = "BD";
                }else{
                    abbrev = star.type.toString() + star.decimal.toString() + " " + star.size;
                }
                return abbrev;
            }
            function getBasesAbbrev(bases){
                var text = "";
                for(var i = 0, len = bases.length; i < len; i++){
                    switch(bases[i]){
                        case "Naval": text += "N"; break;
                        case "Naval Depot": text += "D"; break;
                        case "Scout": text += "S"; break;
                        case "Way Station": text += "W"; break;
                    }
                }
                return text;
            }
            function analyzeMap(systemArray){
                var capital, maxImportance = -4, tradeCodeCount = 0;
                var uwpSums = [0,0,0,0,0,0,0], 
                uwpMins = [null,null,null,null,null,null,null], 
                uwpMaxes = [null,null,null,null,null,null,null];
                var ixSum = 0, ixMin = 5, ixMax = -3;
                var labels = ["size","atmo","hydro","pop","gov","law","tech"];
                var tracker = {"size":{},"atmo":{},"hydro":{},"pop":{},"gov":{},"law":{},"tech":{}};
                for(var i = 0, len = systemArray.length; i < len; i++){
                    var system = systemArray[i];
                    var mainworld = system.mainworld;
                    for(var j = 0, jlen = labels.length; j < jlen; j++){
                        var label = labels[j];
                        var value = mainworld[label];
                        uwpSums[j] += value;
                        if(tracker[label][value]){
                            tracker[label][value] += 1;
                        }else{
                            tracker[label][value] = 1;
                        }
                        if(uwpMins[j] === null || value < uwpMins[j]){ uwpMins[j] = value; }
                        if(uwpMaxes[j] === null || value > uwpMaxes[j]){ uwpMaxes[j] = value; }
                    }
                    if(system.importance.isImportant){
                        var importance = system.importance.extension;
                        if(system.isRed){importance -= 3; }
                        if(system.isAmber){importance -= 1; }
                        if(mainworld.starport === "A"){ importance += 1; }
                        var xy = TCoordToXYCoord(system.tcoord);
                        var desiredXFromBorder = SUBSECTOR_WIDTH/8;
                        var desiredYFromBorder = SUBSECTOR_HEIGHT/8;
                        var withinDesiredXRange = (xy.x > desiredXFromBorder && xy.x < SUBSECTOR_WIDTH - desiredXFromBorder);
                        var withinDesiredYRange = (xy.y > desiredYFromBorder && xy.y < SUBSECTOR_HEIGHT - desiredYFromBorder);
                        if(withinDesiredXRange){
                            importance += 1;
                        }else{
                            importance -=1;
                        }
                        if(withinDesiredYRange){
                                importance += 1;
                        }else{
                            importance -= 1;
                        }
                        if(withinDesiredXRange && withinDesiredYRange){
                            importance += 1;
                        }
                        if(importance > maxImportance){
                            capital = system;
                            maxImportance = importance;
                            tradeCodeCount = capital.mainworld.tradecodes.length | 0;
                        }else if(importance === maxImportance){
                            if(system.mainworld.tradecodes && system.mainworld.tradecodes.length > tradeCodeCount){
                                capital = system;
                                maxImportance = importance;
                            }
                        }
                    }
                    // throw in the Mongoose tech codes for good measure
                    var tech = mainworld.tech;
                    if(tech >= 12){ system.mainworld.tradecodes.push("Ht");}
                    else if(tech <= 5 ){ system.mainworld.tradecodes.push("Lt");}    
                    if(mainworld.tradecodes.indexOf("Cy") > 0){
                        // figure out the colony owner here!
                    }              
                }
                if(capital){
                    capital.isCapital = true;
                    capital.mainworld.tradecodes.push("Cp");
                    capital.mainworld.tradecodes.sort();
                }
               
            }
            
            function generateHexes(x,y, systems){
                var systemsPredefined = true;
                if(typeof systems === "undefined"){
                    _systems = {};
                    systemsPredefined = false;
                }else{
                    _systems = systems;
                }
                mapContent = [];
                for(var iy = 0; iy < y; iy++){
                    for(var ix = 0; ix < x; ix++){
                        var hexLabel = XYCoordToTCoord(ix,iy);
                        var system = _systems[hexLabel];
                        addHex(ix,iy,system);
                    }
                }
                return mapContent;
            }
            function addHex(x,y,system){
                mapContent.push({
                    x:x,
                    y:y,
                    system:system
                });
            }
            function coordsInHexagon(x,y,hex){
                
                var numVertices = hex.vertx.length;
                var isInside = false;
                for(var i = 0, j = numVertices-1; i < numVertices; j = i++){
                    if(((hex.verty[i] > y) != (hex.verty[j] > y )) && 
                    ( x < (hex.vertx[j] - hex.vertx[i]) * (y - hex.verty[i])/(hex.verty[j] -hex.verty[i]) + hex.vertx[i])){
                        isInside = !isInside;
                    }
                }
                return isInside;
            }
            function drawMap(mapContent, options){
                if(typeof options === "undefined"){
                    options = { 
                        heatMap: +(document.getElementById("slcHeatMap").value),
                        travelCodes: document.getElementById("chkShowTravelCodes").checked
                    };
                }
                ctx.textAlign = "center";
                var fontSize = HEX_SIZE*1/3;
                ctx.font = ""+fontSize+"pt "+FONT;
                var w =canvas.width, h =canvas.height;
                ctx.clearRect(0,0,w,h);
                if(CANVAS_BACKGROUND_COLOR !== "transparent"){
                    ctx.globalCompositeOperation = 'destination-over';
                    ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                    ctx.fillRect(0,0,w,h);
                }
                ctx.save();
                ctx.globalCompositeOperation = 'source-over';
                ctx.translate(HEX_MATH.diameter + CANVAS_PADDING, HEX_MATH.diameter + CANVAS_PADDING);
                for(var i = 0, len = mapContent.length; i < len; i++){
                    mapContent[i] = drawHex(mapContent[i], options);
                }
                for(var i = 0, len = mapContent.length; i < len; i++){
                    drawFinal(mapContent[i], options);
                }
                drawRoutes();
                ctx.restore();
                document.getElementById("data").value = JSON.stringify(_systems);
            }
            function selectT5TravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "Amber");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "Red");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                //document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "Red");
           
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "Red");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "N/A");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "N/A");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function selectCETravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "N/A");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 10);
                document.getElementById("slctDangerousAtmoThresholdMax").setAttribute("data-color",document.getElementById("slctDangerousAtmoThresholdMax").value = 15);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "N/A");
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "N/A");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "Amber");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "Amber");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "Amber");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "Amber");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "Amber");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = false;
            }
            function resetTravelCodes(){
                document.getElementById("slctAmberGovLaw").setAttribute("data-color",document.getElementById("slctAmberGovLaw").value = "N/A");
                document.getElementById("slctRedGovLaw").setAttribute("data-color",document.getElementById("slctRedGovLaw").value = "Amber");
                document.getElementById("slctAmberGovLawThreshold").setAttribute("data-color",document.getElementById("slctAmberGovLawThreshold").value = 20);
                document.getElementById("slctRedGovLawThreshold").setAttribute("data-color",document.getElementById("slctRedGovLawThreshold").value = 22);
                document.getElementById("slctDangerousAtmoThreshold").setAttribute("data-color",document.getElementById("slctDangerousAtmoThreshold").value = 12);
                document.getElementById("slctDangerousAtmoThresholdMax").setAttribute("data-color",document.getElementById("slctDangerousAtmoThresholdMax").value = 12);
                document.getElementById("slctRedZoneX").setAttribute("data-color",document.getElementById("slctRedZoneX").value = "Red");
                document.getElementById("slctAmberDieback").setAttribute("data-color",document.getElementById("slctAmberDieback").value= "Red");
                document.getElementById("slctAmberZoneBa").setAttribute("data-color",document.getElementById("slctAmberZoneBa").value= "Amber");
                document.getElementById("slctAmberZoneBaX").setAttribute("data-color",document.getElementById("slctAmberZoneBaX").value= "N/A");
                document.getElementById("slctAmberZoneAtmo").setAttribute("data-color",document.getElementById("slctAmberZoneAtmo").value= "Amber");
                document.getElementById("slctAmberZoneLL").setAttribute("data-color",document.getElementById("slctAmberZoneLL").value= "N/A");
                document.getElementById("slctAmberZone9LL").setAttribute("data-color",document.getElementById("slctAmberZone9LL").value= "N/A");
                document.getElementById("slctLawLevelThreshold").value= 9;
                document.getElementById("slctMaxLawLevelThreshold").value = 9;
                document.getElementById("slctAmberZone0LL").setAttribute("data-color",document.getElementById("slctAmberZone0LL").value= "N/A");
                document.getElementById("slctAmberZoneGov0").setAttribute("data-color",document.getElementById("slctAmberZoneGov0").value= "N/A");
                document.getElementById("slctAmberZoneGov7").setAttribute("data-color",document.getElementById("slctAmberZoneGov7").value= "N/A");
                document.getElementById("slctAmberZoneGov10").setAttribute("data-color",document.getElementById("slctAmberZoneGov10").value= "N/A");
                document.getElementById("btnApplyTravelCodes").disabled = false;
                document.getElementById("btnResetTravelCodes").disabled = true;
            }
            function applyTravelCodes(mapContent, highestLawLevel){
                var RedGovLaw = document.getElementById("slctRedGovLaw").value;
                var AmberDieback = document.getElementById("slctAmberDieback").value;
                var AmberGovLaw = document.getElementById("slctAmberGovLaw").value;
                var RedGovLawThreshold = document.getElementById("slctRedGovLawThreshold").value;
                var DangerousAtmoThreshold = document.getElementById("slctDangerousAtmoThreshold").value;
                var DangerousAtmoThresholdMax = document.getElementById("slctDangerousAtmoThresholdMax").value;
                var AmberGovLawThreshold = document.getElementById("slctAmberGovLawThreshold").value;
                var RedZoneX = document.getElementById("slctRedZoneX").value;
                var AmberZoneBa = document.getElementById("slctAmberZoneBa").value;
                var AmberZoneBaX = document.getElementById("slctAmberZoneBaX").value;
                var AmberZoneAtmo = document.getElementById("slctAmberZoneAtmo").value;
                var AmberZoneLL = document.getElementById("slctAmberZoneLL").value;
                var AmberZone9LL = document.getElementById("slctAmberZone9LL").value;
                var LLThreshold = document.getElementById("slctLawLevelThreshold").value;
                var MaxLLThreshold = document.getElementById("slctMaxLawLevelThreshold").value;
                var AmberZone0LL = document.getElementById("slctAmberZone0LL").value;
                var AmberZoneGov0 = document.getElementById("slctAmberZoneGov0").value;
                var AmberZoneGov7 = document.getElementById("slctAmberZoneGov7").value;
                var AmberZoneGov10 = document.getElementById("slctAmberZoneGov10").value;
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null){
                        mapContent[i].system.isAmber = false;
                        mapContent[i].system.isRed = false;
                        mapContent[i].system.travelcodenotes = "";
                        if(mapContent[i].system.mainworld.pop > 0){
                            if(AmberZoneLL !== "N/A"){ // amber zone highest law level
                                if(mapContent[i].system.mainworld.law === maxes[6] && maxes[6] >= MaxLLThreshold) {
                                    if(AmberZoneLL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Among strictest law levels in the subsector.  ";
                                }
                            }
                            if(AmberZone9LL !== "N/A"){ // amber zone 9+ law level 
                                if(mapContent[i].system.mainworld.law >= LLThreshold) {
                                    if(AmberZone9LL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Law levels "+LLThreshold.toString()+"+.  ";
                                }
                            }
                            if(AmberZone0LL !== "N/A"){ // amber zone 0 law level
                                if(mapContent[i].system.mainworld.law === 0) {
                                    if(AmberZone0LL === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "No law level enforced.  ";
                                }
                            }
                           
                            if(AmberZoneGov0 !== "N/A"){ // amber ungoverned
                                if(mapContent[i].system.mainworld.gov === 0) {
                                    if(AmberZoneGov0 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Anarchy.  ";
                                }
                            }
                            if(AmberZoneGov7 !== "N/A"){ // amber balkanized
                                if(mapContent[i].system.mainworld.gov === 7) {
                                    if(AmberZoneGov7 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Balkanized local governments.  ";
                                }
                            }
                            if(AmberZoneGov0 !== "N/A"){ // amber charismatic dictatorship
                                if(mapContent[i].system.mainworld.gov === 10) {
                                    if(AmberZoneGov0 === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Ruled by charismatic dictatorship.  ";
                                }
                            }
                            if(RedZoneX !== "N/A" && mapContent[i].system.mainworld.starport.toUpperCase() === "X"){ // red no starport
                                if(RedZoneX === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelcodenotes += "Population under interdiction.  ";
                            }
                            if(RedGovLaw !== "N/A"){
                                if(mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law >= RedGovLawThreshold){
                                    if(RedGovLaw === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Oppressive government.  ";
                                }
                                
                            }
                            if(AmberGovLaw !== "N/A"){
                                if(mapContent[i].system.mainworld.gov + mapContent[i].system.mainworld.law >= AmberGovLawThreshold){
                                    if(AmberGovLaw === "Red"){
                                        mapContent[i].system.isRed = true; 
                                    }else{
                                        mapContent[i].system.isAmber = true; 
                                    }
                                    mapContent[i].system.travelcodenotes += "Oppressive government.  ";
                                }
                                
                            }
                        }else{
                            if(AmberZoneBa !== "N/A" && mapContent[i].system.mainworld.tech === 0){ // amber zone uninhabited
                                
                                if(AmberZoneBa === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelcodenotes += "Barren/Uninhabited.  ";
                                
                            }
                            if(AmberZoneBaX !== "N/A" && mapContent[i].system.starport === "X"){ // amber zone uninhabited
                                
                                if(AmberZoneBaX === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                if(mapContent[i].system.mainworld.tech <=5){
                                    mapContent[i].system.travelcodenotes += "Protected population. No starport facilities.  ";
                                }else{
                                    mapContent[i].system.travelcodenotes += "Under interdiction. No starport facilities.  ";
                                }
                                
                            }
                            if(AmberDieback !== "N/A" && mapContent[i].system.mainworld.tech > 0){
                                if(AmberDieback === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                if(mapContent[i].system.mainworld.starport === "E"){
                                    mapContent[i].system.travelcodenotes += "Archaeological site (dieback world).  ";
                                }else{
                                    mapContent[i].system.travelcodenotes += "Dieback world.  ";
                                }
                            }
                        }
                        if(AmberZoneAtmo !== "N/A"){ // amber 10+ atmo
                            if(mapContent[i].system.mainworld.atmo >= DangerousAtmoThreshold && mapContent[i].system.mainworld.atmo <= DangerousAtmoThresholdMax) {
                                if(AmberZoneAtmo === "Red"){
                                    mapContent[i].system.isRed = true; 
                                }else{
                                    mapContent[i].system.isAmber = true; 
                                }
                                mapContent[i].system.travelcodenotes += "Dangerous atmosphere.  ";
                            }
                        }
                        var indexOfFo = mapContent[i].system.mainworld.tradecodes.indexOf("Fo");
                        if(mapContent[i].system.isRed){
                            mapContent[i].system.travelcodenotes = "RED ZONE: "+mapContent[i].system.travelcodenotes;
                            if(indexOfFo == -1){ mapContent[i].system.mainworld.tradecodes.push("Fo"); mapContent[i].system.mainworld.tradecodes.sort();}
                        }else{
                            if(indexOfFo >= 0){ mapContent[i].system.mainworld.tradecodes.splice(indexOfFo,1);}
                            if(mapContent[i].system.isAmber){
                                mapContent[i].system.travelcodenotes = "AMBER ZONE: "+mapContent[i].system.travelcodenotes;
                                
                            }
                        } 
                    }
                }
            }
            function clearTravelCodes(mapContent){
                for(var i = 0, len = mapContent.length; i < len; i++){
                    if(typeof mapContent[i].system !== "undefined" && mapContent[i].system !== null){
                        mapContent[i].system.isRed = false;
                        var indexOfFo = mapContent[i].system.mainworld.tradecodes.indexOf("Fo");
                        if(indexOfFo){
                            if(indexOfFo >= 0){ mapContent[i].system.mainworld.tradecodes.splice(indexOfFo,1);}
                        }
                        mapContent[i].system.isAmber = false;
                    }
                }
            }
            function TCoordToXYCoord(tcoord){
                if(tcoord.length && tcoord.length == 4){
                    var col = tcoord.substring(0,2);
                    var row = tcoord.substring(2,4);
                    if(row[0] == "0"){row = row[1];}
                    if(col[0] == "0"){col = col[1];}
                    return{x:+(col)-1,y:+(row)-1}
                }
            }
            function XYCoordToTCoord(x,y){
                var col = (+(x)+1).toString();
                if(+(x)+1 < 10){col = "0"+col;}
                var row = (+(y)+1).toString();
                if(+(y)+1 < 10){row = "0"+row;}
                return col+row;
            }
            function drawHex(hex, options){
                var drawMode = -1;
                if(typeof options.heatMap !== "undefined"){ drawMode = options.heatMap; }
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                var coords = {
                    x:hex.x*HEX_MATH.xOffset,
                    y:hex.x%2 == 0 ? hex.y*HEX_MATH.yOffset : hex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                };
                var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                    x2 = coords.x+HEX_MATH.radius; // top/bottom right vertex
                var x0 = x1 - HEX_MATH.radius, // center left vertex
                    x3 = x2 + HEX_MATH.radius, // center right vertex
                    x4 = x1 + (x2-x1)/2; // middle of the bottom edge
                var y0 = coords.y - HEX_MATH.diameter, 
                    y1 = coords.y,
                    y2 = y1 + HEX_MATH.diameter;
                ctx.strokeStyle = HEX_BORDER_COLOR;
                var oldLineWidth = ctx.lineWidth;
                
                ctx.beginPath();
                ctx.moveTo(x4,y2);
                hex.vertx = [x4,x2,x3,x2,x1,x0,x1,x4];
                hex.verty = [y2,y2,y1,y0,y0,y1,y2,y2];
                for(var i = 1; i < hex.vertx.length; i++){
                    ctx.lineTo(hex.vertx[i], hex.verty[i]);
                }
                ctx.stroke();
                ctx.fillStyle = HEX_BACKGROUND_COLOR;           
                ctx.fill();
                
                if(containsSystem){
                    if(drawMode >= 0){
                        var heatMapValue = 0;
                        var bgColor = "black";
                        var minValue = mins[drawMode], maxValue = maxes[drawMode];
                        switch(drawMode){
                            case 0: // starport
                                switch(hex.system.mainworld.starport){
                                    case "A": bgColor = "rgb(255,0,0)"; break; 
                                    case "B": bgColor = "rgb(200,0,50)"; break; 
                                    case "C": bgColor = "rgb(150,0,100)"; break; 
                                    case "D": bgColor = "rgb(100,0,150)"; break; 
                                    case "E": bgColor = "rgb(50,0,200)"; break; 
                                    case "X": bgColor = "rgb(0,0,205)";  break; 
                                }
                                
                            break;
                            case 1: heatMapValue = hex.system.mainworld.size; 
                            break;
                            case 2: heatMapValue = hex.system.mainworld.atmo; 
                            break;
                            case 3: heatMapValue = hex.system.mainworld.hydro; 
                            break;
                            case 4: heatMapValue = hex.system.mainworld.pop; break;
                            case 5: heatMapValue = hex.system.mainworld.gov; break;
                            case 6: heatMapValue = hex.system.mainworld.law; break;
                            case 7: heatMapValue = hex.system.mainworld.tech; break;
                            case 8: heatMapValue = hex.system.importance.extension; break;
                            case 9: 
                                var currValue = hex.system.totalpop;
                                if(currValue > 0){ currValue = Math.round(Math.log10(currValue)); }
                                heatMapValue = currValue; 
                                break;
                            case 10: heatMapValue = hex.system.economics.RU; break;
                            case 11: 
                                if(hex.system.natives){ bgColor = "rgb(255,0,0)";}
                                else{ bgColor = "rgb(0,0,205)";}
                                break;
                        }
                        if(drawMode > 0 && drawMode < 11){
                            var bValue = 200 - 200*((heatMapValue - minValue) / (maxValue - minValue)) >>> 0; 
                            var rValue = 255*((heatMapValue - minValue) / (maxValue - minValue)) >>> 0; 
                            bgColor = "rgb("+rValue+",0,"+bValue+")";
                        }
                        ctx.fillStyle = bgColor;
                        ctx.fill();
                    }
                    
                    if(hex.selected || hex.highlighted){
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if(ctx.strokeStyle.length === 7){
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if(hex.selected){                    
                            ctx.lineWidth = inc;
                        }else if(hex.highlighted){
                            ctx.lineWidth = inc/2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2,tx3,tx2,];//tx1,tx0,tx1];
                        var verty = [ty2,y1,ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1,tx0,tx1];
                        var verty = [ty0,y1,ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                    var zoneRadius = fontSize*5;
                    if(options.travelCodes && (hex.system.isRed || hex.system.isAmber)){

                        if(hex.system.isRed){
                            ctx.strokeStyle = "red";
                        }else if(hex.system.isAmber){
                            ctx.strokeStyle = "yellow";
                        }
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(x4,y1,zoneRadius,-Math.PI/2,Math.PI/4);
                        ctx.stroke();
            
                        ctx.beginPath();
                        ctx.arc(x4,y1,zoneRadius,-5*Math.PI/4,-Math.PI/2);
                        ctx.stroke();
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        
                    }

                    
                    if(hex.system.gg > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x2,y1-(y1-y0)/2,fontSize/2,0,2*Math.PI);
                        ctx.fill();
                    }
                    for(var i = 0, len = hex.system.bases.length; i < len; i++){
                        var base = hex.system.bases[i];
                        drawBase(base, x4, y1);
                    }
                    
                    // draw planet
                    if(hex.system.isAsteroidBelt){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2.5,y1 - (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/9,y1,fontSize/6,0,2*Math.PI);
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/5,y1 - (y1-y0)/11,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/6,y1 + (y1-y0)/9,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 + (x4 - x1)/2.5,y1 + (y1-y0)/18,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/2,y1 ,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/8,y1 - (y1-y0)/6,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.arc(x4 - (x4 - x1)/7,y1 + (y1-y0)/8,fontSize/6,0,2*Math.PI);
                        ctx.fill();
                    }else if(hex.system.mainworld.hydro > 0){
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.fill();
                    }else{
                        ctx.strokeStyle = TEXT_COLOR; 
                        ctx.lineWidth  = HEX_SIZE/10;
                        ctx.beginPath();
                        ctx.arc(x4,y1,fontSize,0,2*Math.PI);
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                    }                    

                    // write starport
                    var oldFont = ctx.font;
                    ctx.font = ""+(fontSize*1.2)+"pt "+FONT;
                    ctx.fillStyle = TEXT_COLOR; 
                    ctx.fillText(hex.system.uwp[0],x4,y0 + (y1-y0)/2);
                    ctx.font = oldFont;
                    
                    
                    
                }
                else{
                    if(hex.selected || hex.highlighted){
                        ctx.strokeStyle = HEX_BORDER_COLOR;
                        if(ctx.strokeStyle.length === 7){
                            ctx.strokeStyle = ctx.strokeStyle + "80";
                        }
                        var inc = HEX_SIZE / 6 >>> 0;
                        if(hex.selected){                    
                            ctx.lineWidth = inc;
                        }else if(hex.highlighted){
                            ctx.lineWidth = inc/2;
                        }
                        var tx1 = x1 + inc;
                        var tx2 = x2 - inc;
                        var tx0 = x0 + inc;
                        var tx3 = x3 - inc;
                        var ty0 = y0;
                        var ty2 = y2;
                        var vertx = [tx2,tx3,tx2,];//tx1,tx0,tx1];
                        var verty = [ty2,y1,ty0,];//ty0,y1,ty2];
                        ctx.moveTo(tx2, ty2);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                        var vertx = [tx1,tx0,tx1];
                        var verty = [ty0,y1,ty2];
                        ctx.moveTo(tx1, ty0);
                        ctx.beginPath();
                        for(var i = 0; i < vertx.length; i++){
                            ctx.lineTo(vertx[i], verty[i]);
                        }
                        ctx.stroke();
                    }
                }
                
                ctx.lineWidth = oldLineWidth;
                return hex;
            }
            function drawFinal(hex, options){
                var containsSystem = typeof hex.system !== "undefined" && hex.system !== null;
                if(containsSystem){

                    var coords = {
                        x:hex.x*HEX_MATH.xOffset,
                        y:hex.x%2 == 0 ? hex.y*HEX_MATH.yOffset : hex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                    };
                    var x1 = coords.x - HEX_MATH.radius, // top/bottom left vertex
                    x2 = coords.x+HEX_MATH.radius; // top/bottom right vertex
                    var x0 = x1 - HEX_MATH.radius, // center left vertex
                    x3 = x2 + HEX_MATH.radius, // center right vertex
                    x4 = x1 + (x2-x1)/2; // middle of the bottom edge
                    var y0 = coords.y - HEX_MATH.diameter, 
                    y1 = coords.y,
                    y2 = y1 + HEX_MATH.diameter;
                    var maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                    var name = hex.system.name;
                    var oldFontStyle = ctx.font;
                    if(hex.system.importance.isImportant){ 
                        ctx.font = "bold "+ oldFontStyle;
                        name = name.toUpperCase();
                    }
                    if(hex.system.mainworld.pop >= 9){
                        //ctx.font = "small-caps "+ oldFontStyle;
                        name = name.toUpperCase();
                    }
                    var lines = [];
                    if(ctx.measureText(name).width > maxWidth){
                        var words = name.split(" ");
                        var lineSoFar = "";
                        for(var i = words.length-1; i >= 0; i--){
                            var proposal = lineSoFar.length > 0 ? words[i] + " " + lineSoFar : words[i];
                            if(ctx.measureText(proposal).width < maxWidth){
                                lineSoFar = proposal;
                            }else{
                                if(lineSoFar.length > 0){
                                    lines.push(lineSoFar);
                                }
                                lineSoFar = words[i];
                            }
                            maxWidth += fontSize;
                        }
                        if(lineSoFar.length > 0){lines.push(lineSoFar);}
                    }else{
                        lines = [name];
                    }
                    // write text
                    ctx.textAlign = "center";
                    if(hex.system.isCapital){
                        ctx.fillStyle = CAPITAL_TEXT_COLOR;                    
                        ctx.font = "bold "+ oldFontStyle;
                        ctx.strokeStyle = CAPITAL_BACKGROUND_COLOR;
                        ctx.lineWidth = fontSize/8;
                    }else{
                        ctx.fillStyle = TEXT_COLOR;
                    }
                    maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                    var height = y2 - lines.length*fontSize;
                    var oldLineWidth = ctx.lineWidth;
                    for(var i = lines.length-1; i >= 0; i--){    
                        if(hex.system.isCapital){
                            ctx.lineWidth = fontSize/8;
                            ctx.strokeText(lines[i], x4, height, maxWidth);
                            ctx.lineWidth = oldLineWidth;
                        }                 
                        ctx.fillText(lines[i], x4, height, maxWidth);
                        
                        height += fontSize+(fontSize/4);
                    }
                    ctx.font = oldFontStyle;
                    if(hex.selected || hex.highlighted){
                        ctx.fillStyle = CANVAS_BACKGROUND_COLOR;
                        var backStyle = ctx.fillStyle;
                        
                        ctx.fillStyle = TEXT_COLOR; 
                        // write UWP
                        ctx.beginPath();
                        var oldGlobalCompositeOperation = ctx.globalCompositeOperation;
                        ctx.globalCompositeOperation = 'source-over';
                        var uwp = hex.system.uwp.toUpperCase();
                        var uwpSize = ctx.measureText(uwp);
                        ctx.fillStyle = backStyle;
                        var fontHeight = uwpSize.fontBoundingBoxAscent + uwpSize.fontBoundingBoxDescent;
                        ctx.fillRect(x4-uwpSize.width/2,y1-fontHeight/2-2,uwpSize.width,fontSize+2);
                        ctx.fillStyle = TEXT_COLOR; 
                        ctx.fillText(uwp,x4,y1);
                        // write trade codes
                        maxWidth = x3 - x0 - (x1-x0)/2 - (x3-x2)/2 - fontSize*2;
                        var codes = hex.system.mainworld.tradecodes.join(" ");
                        var codesSize = ctx.measureText(codes);
                        lines = [codes];
                        if(codesSize.width > maxWidth){
                            var line1 = hex.system.mainworld.tradecodes.slice(0,hex.system.mainworld.tradecodes.length/2>>0).join(" ");
                            var line2 = hex.system.mainworld.tradecodes.slice(hex.system.mainworld.tradecodes.length/2>>0).join(" ");
                            lines = [line1, line2]
                        }
                        height = y1 + fontHeight;
                        var blockHeight = y1 + fontHeight/2 - 2;
                        for(var i = lines.length-1; i >= 0; i--){ 
                            var lineWidth = ctx.measureText(lines[i]).width;
                            ctx.fillStyle = backStyle;
                            ctx.fillRect(x4-lineWidth/2,blockHeight,lineWidth,fontSize+2);
                            ctx.fillStyle = TEXT_COLOR; 
                            ctx.fillText(lines[i], x4, height, maxWidth);
                            height += fontSize+(fontSize/3);
                            blockHeight += fontSize+(fontSize/3);
                        }
                        ctx.globalCompositeOperation = oldGlobalCompositeOperation;
                    }
                }
            }
            function drawBase(baseType, hexX, hexY){
                switch(baseType){
                    case "Scout":
                        var scale = fontSize/2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.moveTo(hexX - scale*8, hexY + scale*4);
                        ctx.lineTo(hexX - scale*6, hexY + scale*4);
                        ctx.lineTo(hexX - scale*7, hexY + scale*2);
                        ctx.lineTo(hexX - scale*8, hexY + scale*4);
                        ctx.closePath();
                        ctx.fill();
                        break;
                    case "Naval":
                        var scale = fontSize/2;
                        drawStar(hexX - scale*5, hexY - scale*5, 5, scale*0.7, scale*1.7);
                        break;
                    case "Naval Depot":
                        var scale = fontSize/2;
                        strokeStar(hexX - scale*5, hexY - scale*5, 5, scale*0.7, scale*1.7);
                        break;
                    case "Way Station":
                    var scale = fontSize/2;
                        ctx.beginPath();
                        ctx.fillStyle = TEXT_COLOR;
                        ctx.moveTo(hexX - scale*8, hexY + scale*4);
                        ctx.lineTo(hexX - scale*6, hexY + scale*4);
                        ctx.lineTo(hexX - scale*7, hexY + scale*2);
                        ctx.lineTo(hexX - scale*8, hexY + scale*4);
                        ctx.closePath();
                        var oldLineWidth = ctx.lineWidth;
                        ctx.lineWidth = 1;
                        ctx.strokeStyle =TEXT_COLOR;
                        ctx.stroke();
                        ctx.lineWidth = oldLineWidth;
                        break;
                }
            }
            function drawStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    
                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)                    
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                ctx.fillStyle=TEXT_COLOR;
                ctx.fill();
            }
            function strokeStar(cx, cy, spikes, outerRadius, innerRadius) {
                var rot = Math.PI / 2 * 3;
                var x = cx;
                var y = cy;
                var step = Math.PI / spikes;
                ctx.strokeSyle = "#000";
                ctx.beginPath();
                ctx.moveTo(cx, cy - outerRadius);
                rot += step;
                for (i = 0; i < spikes; i++) {
                    x = cx + Math.cos(rot) * outerRadius;
                    y = cy + Math.sin(rot) * outerRadius;
                    
                    ctx.lineTo(x, y)
                    rot += step

                    x = cx + Math.cos(rot) * innerRadius;
                    y = cy + Math.sin(rot) * innerRadius;
                    ctx.lineTo(x, y)                    
                    rot += step
                }
                ctx.lineTo(cx + Math.cos(rot) * outerRadius, cy + Math.sin(rot) * outerRadius)
                ctx.closePath();
                var oldLineWidth = ctx.lineWidth;
                ctx.lineWidth = 1;
                ctx.strokeStyle =TEXT_COLOR;
                ctx.stroke();
                ctx.lineWidth = oldLineWidth;
            }
            function updateStyle(){
                var select = document.getElementById("slctStyle");
                var val = select.value;
                if(val === "custom"){
                    document.getElementById("hexBorderColor").value = select.getAttribute("data-hexfg");
                    document.getElementById("hexBackgroundColor").value = select.getAttribute("data-hexbg");
                    document.getElementById("canvasBackgroundColor").value = select.getAttribute("data-canvasbg");
                    document.getElementById("textColor").value = select.getAttribute("data-text");
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                   
                }else if(val === "light"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "white";
                    document.getElementById("textColor").value = "black";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "dark"){
                    document.getElementById("hexBorderColor").value = "white";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "black";
                    document.getElementById("textColor").value = "white";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                }else if(val === "transparent"){
                    document.getElementById("hexBorderColor").value = "black";
                    document.getElementById("hexBackgroundColor").value = "transparent";
                    document.getElementById("canvasBackgroundColor").value = "transparent";
                    HEX_HIGHLIGHT_BACKGROUND_COLOR = "rgba(255,255,255,0.5)";
                    document.getElementById("textColor").value = "black";
                }
                updateHexBorderColor(document.getElementById("hexBorderColor").value);
                updateHexBackgroundColor(document.getElementById("hexBackgroundColor").value);
                updateCanvasBackgroundColor(document.getElementById("canvasBackgroundColor").value);
                updateTextColor(document.getElementById("textColor").value);
                updateFont(document.getElementById("fontFamily").value);
                drawMap(mapContent);
            }
            function updateFont(newFont){
                FONT = newFont;
                ctx.font = ""+fontSize+"pt " + newFont;
            }
            function updateHexSize(newSize){
                HEX_SIZE = newSize;
                HEX_MATH.radius = HEX_SIZE;
                HEX_MATH.xOffset = HEX_SIZE*3;
                HEX_MATH.yOffset = HEX_SIZE*4;
                HEX_MATH.diameter = HEX_SIZE*2;
                canvas.setAttribute("width",SUBSECTOR_WIDTH * HEX_MATH.xOffset+HEX_MATH.radius+CANVAS_PADDING*2);
                canvas.setAttribute("height",SUBSECTOR_HEIGHT*HEX_MATH.yOffset+HEX_MATH.diameter+CANVAS_PADDING*2);
                fontSize = (newSize*1/3);
                ctx.font = ""+fontSize+"pt " + FONT;
                document.getElementById("sizeIndicator").innerHTML = newSize;
            }
            function updateHexBorderColor(newColor){
                HEX_BORDER_COLOR = newColor;
            }
            function updateHexBackgroundColor(newColor){
                HEX_BACKGROUND_COLOR = newColor;
            }
            function updateCanvasBackgroundColor(newColor){
                CANVAS_BACKGROUND_COLOR = newColor;
            }
            function updateTextColor(newColor){
                TEXT_COLOR = newColor;
            }
            function addCaps(text) {
                var capitalizedString = "";
                var lastCharacter = null, currCharacter = " ";
                for (var i = 0, len = text.length; i < len; i++) {
                    lastCharacter = currCharacter;
                    currCharacter = text[i];
                    if (lastCharacter === " " || lastCharacter === "-") {
                        capitalizedString += currCharacter.toUpperCase();
                    } else {
                        capitalizedString += currCharacter;
                    }
                }
                return capitalizedString;
            }
            function calcRoutes(mapContent, rules){
                if(rules === "T5"){
                    var importantWorlds = [];
                    routes = [];
                    for(var i = 0, len = mapContent.length; i < len; i++){
                        var hex = mapContent[i];
                        if(hex.system){
                            if(hex.system.importance.isImportant && !hex.system.isRed){
                                hex.system.routes = [];
                                importantWorlds.push(hex.system);
                            }
                        }    
                        
                    }
                    if(importantWorlds.length > 1){
                        for(var i = 0, len = importantWorlds.length; i < len; i++){
                            var hexId = importantWorlds[i].tcoord;
                            var neighbors = getNeighbors(hexId,4);
                            for(var j = 0, jlen = neighbors.length; j < jlen; j++){
                                var neighbor = neighbors[j];
                                if(neighbor.importance.isImportant){
                                    if(importantWorlds[i].routes.indexOf(neighbor.tcoord) === -1){
                                        importantWorlds[i].routes.push(neighbor.tcoord);
                                        neighbor.routes.push(hexId);
                                        routes.push([hexId,neighbor.tcoord]);
                                        console.log("Trade route from " +hexId + " to " + neighbor.tcoord);
                                    }
                                }
                            }
                        }
                    }
                }
            }
            function getRoute(tcoord1, tcoord2, maxJump){
                // TO DO: Build array of system coordinates between two coordinates
            }
            function getNeighbors(tcoord, range, excluded){
                if(typeof excluded == "undefined"){
                    excluded = {};
                }
                excluded[tcoord] = true;
               var xy = TCoordToXYCoord(tcoord);
               var x = xy.x, y = xy.y;
               var candidates = [];
                if(x%2===0){
                    if(x > 1){
                        candidates.push(XYCoordToTCoord(x-1,y));
                        if(y < SUBSECTOR_HEIGHT){
                            candidates.push(XYCoordToTCoord(x-1,y+1));
                        }
                    }
                    if(y > 1){
                        candidates.push(XYCoordToTCoord(x,y-1));
                    }
                    if(y < SUBSECTOR_HEIGHT){
                        candidates.push(XYCoordToTCoord(x, y+1));
                    }
                    if(x < SUBSECTOR_WIDTH){
                        candidates.push(XYCoordToTCoord(x+1,y));
                        if(y < SUBSECTOR_HEIGHT){
                            candidates.push(XYCoordToTCoord(x+1,y+1));
                        }
                    }
                }else{
                    if(x > 1){
                        if(y > 1){
                            candidates.push(XYCoordToTCoord(x-1,y-1));
                        }
                        candidates.push(XYCoordToTCoord(x-1,y));
                    }
                    if(y > 1){
                        candidates.push(XYCoordToTCoord(x,y-1));
                    }
                    if(y < SUBSECTOR_HEIGHT){
                        candidates.push(XYCoordToTCoord(x, y+1));
                    }
                    if(x < SUBSECTOR_WIDTH){
                        if(y > 1){
                            candidates.push(XYCoordToTCoord(x+1,y-1));
                        }
                        candidates.push(XYCoordToTCoord(x+1,y));
                    }
                }
                var neighbors = [];
                for(var i = 0; i < candidates.length; i++){
                    var candidate  = candidates[i];
                    if(!excluded[candidate]){
                        if(_systems[candidate]){
                            neighbors.push(_systems[candidate])
                        }
                    }
                    excluded[candidate] = true;
                    if(range > 1){
                        var moreNeighbors = getNeighbors(candidate, range-1, excluded);
                        if(moreNeighbors.length > 0){
                            neighbors.push(...moreNeighbors);
                        }
                    }
                }
                return neighbors;
            }
            function isConnected(hex1,hex2){
                for(var i = 0, len = hex1.routes.length; i < len; i++){
                    if(hex1.routes[i] === hex2.tcoord){
                        return true;
                    }
                }
                return false;
            }
            function drawRoutes(){
                //ctx.save();
                //ctx.globalCompositeOperation = 'source-over';
                //ctx.translate(HEX_MATH.diameter + CANVAS_PADDING, HEX_MATH.diameter + CANVAS_PADDING);
                var keys = Object.keys(_systems);
                var oldStrokeStyle = ctx.strokeStyle;
                var oldLineWidth = ctx.lineWidth;
                ctx.strokeStyle = "rgba(255,255,255,0.4)";
                ctx.lineWidth = HEX_SIZE/10;
                for(var i = 0, len = routes.length; i < len; i++){
                    var key = routes[i][0];
                    var destKey = routes[i][1];
                    var hex = TCoordToXYCoord(key);
                    var coords = {
                        x:hex.x*HEX_MATH.xOffset,
                        y:hex.x%2 == 0 ? hex.y*HEX_MATH.yOffset : hex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                    };
                    ctx.moveTo(coords.x,coords.y);
                    ctx.beginPath();
                    ctx.moveTo(coords.x,coords.y);
                    var destHex = TCoordToXYCoord(destKey);
                    var dest = {
                        x:destHex.x*HEX_MATH.xOffset,
                        y:destHex.x%2 == 0 ? destHex.y*HEX_MATH.yOffset : destHex.y*HEX_MATH.yOffset + HEX_MATH.diameter
                    };
                    ctx.lineTo(dest.x,dest.y);
                    ctx.stroke();
                    ctx.closePath();
                }
                ctx.strokeStyle = oldStrokeStyle;
                ctx.lineWidth = oldLineWidth;
               //ctx.restore();
            }
            function renderSystem(system){
                var lookups = {
                    orbitdistance:{
                        "-1":"<0.2 AU",
                        "0":"0.2 AU",
                        "1":"0.4 AU",
                        "2":"0.7 AU",
                        "3":"1.0 AU",
                        "4":"1.6 AU",
                        "5":"2.8 AU",
                        "6":"5.2 AU",
                        "7":"10 AU",
                        "8":"20 AU",
                        "9":"40 AU",
                        "10":"77 AU",
                        "11":"154 AU",
                        "12":"308 AU",
                        "13":"615 AU",
                        "14":"1230 AU",
                        "15":"2500 AU",
                        "16":"4900 AU",
                        "17":"9800 AU",
                        "18":"19500 AU",
                        "19":"39500 AU",
                        "20":"78700 AU"
                    },
                    tradecode:{
                        "As":"Asteroid Belt",
                        "De":"Desert",
                        "Fl":"Fluid Oceans",
                        "Ga":"Garden World",
                        "He":"Hellworld",
                        "Ic":"Ice-Capped",
                        "Oc":"Ocean World",
                        "Va":"Vacuum",
                        "Wa":"Water World",
                        "Sa":"Satellite (far satellite)",
                        "Lk":"Locked (close satellite)",
                        "Di":"Dieback",
                        "Ba":"Barren",
                        "Lo":"Low Population",
                        "Ni":"Non-Industrial",
                        "Ph":"Pre-High Population",
                        "Hi":"High Population",
                        "Pa":"Pre-Agricultural",
                        "Ag":"Agricultural",
                        "Na":"Non-Agricultural",
                        "Px":"Prison or Exile Camp",
                        "Pi":"Pre-Industrial",
                        "In":"Industrial",
                        "Po":"Poor",
                        "Pr":"Pre-Rich",
                        "Ri":"Rich",
                        "Fr":"Frozen",
                        "Ho":"Hot",
                        "Co":"Cold",
                        "Tr":"Tropic",
                        "Tu":"Tundra",
                        "Tz":"Twilight Zone",
                        "Cp":"Capital",
                        "Cy":"Colony",
                        "Lt":"Low Tech",
                        "Ht":"High Tech",
                        "Fo":"Forbidden",
                        "Mr":"Military Rule",
                        "Re":"Reserve"
                    },
                    "port":{
                        "A":"A - Excellent",
                        "B":"B - Good",
                        "C":"C - Routine",
                        "D":"D - Poor",
                        "E":"E - Frontier",
                        "X":"X - None"
                    },
                    "size":{
                        "0":"Planetoid/Belt (<800 Km) - Microgravity",
                        "1":"Small (200 - 2400 Km) - Very Low Gravity",
                        "2":"Small (2400 - 4000 Km) - Low Gravity (Luna)",
                        "3":"Small (4000 - 5600 Km) - Low Gravity (Mercury)",
                        "4":"Medium (5600 - 7200 Km) - Low Gravity (Mars)",
                        "5":"Medium (7200 - 8800 Km) - Standard/Low Gravity",
                        "6":"Medium (8800 - 10400 Km) - Standard/Low Gravity",
                        "7":"Large (10400 - 12000 Km) - Standard Gravity",
                        "8":"Large (12000 - 13600 Km) - Standard Gravity (Terra)",
                        "9":"Large (13600 - 15200 Km) - Standard Gravity",
                        "10":"Huge (15200 - 16800 Km) - Standard/High Gravity",
                        "11":"Huge (16800 - 18400 Km) - High Gravity",
                        "12":"Huge (18400 - 19400 Km) - High Gravity",
                        "13":"Massive (~20,800 Km) - High Gravity",
                        "14":"Massive (~22,400 Km) - High Gravity",
                        "15":"Massive (~24,000 Km) - High Gravity"

                    },
                    "atmo":{
                        "0":"Vacuum",
                        "1":"Trace",
                        "2":"Very Thin / Tainted",
                        "3":"Very Thin",
                        "4":"Thin / Tainted",
                        "5":"Thin",
                        "6":"Standard",
                        "7":"Standard / Tainted",
                        "8":"Dense",
                        "9":"Dense / Tainted",
                        "10":"Exotic",
                        "11":"Corrosive",
                        "12":"Insidious",
                        "13":"Dense, high",
                        "14":"Ellipsoid",
                        "15":"Thin, low"
                    },
                    "hydro":{
                        "0":"0-5% Desert",
                        "1":"6-15% Dry",
                        "2":"16-25% Dry, A Few Small Seas",
                        "3":"26-35% Wet, Small Seas and Oceans",
                        "4":"36-45% Wet World",
                        "5":"46-55% Wet, A Large Ocean",
                        "6":"56-65% Wet, Large Oceans",
                        "7":"66-75% Wet, Earthlike",
                        "8":"76-85% Very Wet, Marine",
                        "9":"86-95% Very Wet, Almost Entirely Ocean",
                        "10":"96-100% Water World"

                    },
                    "pop":{
                        "0":"",
                        "1":"0",
                        "2":" hundred",
                        "3":" thousand",
                        "4":"0 thousand",
                        "5":" hundred thousand",
                        "6":" million",
                        "7":"0 Million",
                        "8":" hundred million",
                        "9":" billion",
                        "10":"0 billion",
                        "11":" hundred billion",
                        "12":" trillion",
                        "13":"0 trillion",
                        "14":" hundred trillion",
                        "15":" quadrillion"
                    },
                    "gov":{
                        "0":"No government structure",
                        "1":"Company/Corporation",
                        "2":"Participating Democracy",
                        "3":"Self-Perpetuating Oligarchy",
                        "4":"Representative Democracy",
                        "5":"Feudal Technocracy",
                        "6":"Captive Government",
                        "7":"Balkanization",
                        "8":"Civil Service Bureaucracy",
                        "9":"Impersonal Bureaucracy",
                        "10":"Charismatic Dictator",
                        "11":"Non-Charismatic Leader",
                        "12":"Charismatic Oligarchy",
                        "13":"Religious Dictatorship",
                        "14":"Religious Autocracy",
                        "15":"Totalitarian Oligarchy"

                    },
                    "law":{
                        "0":"0 - No Law",
                        "1":"1 - Low Law, No Explosives/Poisons",
                        "2":"2 - Low Law, No Portable Energy Weapons",
                        "3":"3 - Low Law, No Automatic Weapons",
                        "4":"4 - Moderate Law, No Submachine Guns, Energy Weapons",
                        "5":"5 - Moderate Law, No Concealable Firearms, EMP Weapons, Gauss Weapons",
                        "6":"6 - Moderate Law, No Firearms Except Shotguns",
                        "7":"7 - Moderate Law, No Firearms Including Shotguns",
                        "8":"8 - High Law, Blades controlled, No open display of weapons",
                        "9":"9 - High Law, No Weapons Outside Home",
                        "10":"10 - Extreme Law, No Weapon Possession",
                        "11":"11 - Extreme Law, Civilian movement controlled",
                        "12":"12 - Extreme Law, Unrestricted invasion of privacy",
                        "13":"13 - Extreme Law, Paramilitary law enforcement",
                        "14":"14 - Extreme Law, Full-fledged police state",
                        "15":"15 - Extreme Law, All facets of daily life rigidly controlled",
                        "16":"16 - Extreme Law, Severe punishment for petty infractions",
                        "17":"17 - Extreme Law, Legalized oppression",
                        "18":"18 - Extreme Law, Routinely oppressive and restrictive",
                    },
                    "tech":{
                        "0":"TL0 - Neolithic",
                        "1":"TL1 - Bronze/Iron Age",
                        "2":"TL2 - Age of Sail",
                        "3":"TL3 - Industrial Revolution",
                        "4":"TL4 - Mechanized Age",
                        "5":"TL5 - Broadcast Age",
                        "6":"TL6 - Atomic Age",
                        "7":"TL7 - Space Age",
                        "8":"TL8 - Information Age",
                        "9":"TL9 - Gravitics Age",
                        "10":"TL10 - Basic Fusion Age",
                        "11":"TL11 - FusionPlus Age",
                        "12":"TL12 - Positronics Age",
                        "13":"TL13 - Cloning Age",
                        "14":"TL14 - Geneering Age",
                        "15":"TL15 - Anagathics Age",
                        "16":"TL16 - Artificial Persons Age",
                        "17":"TL17 - Personality Transfer Age",
                        "18":"TL18 - Exotics Age",
                        "19":"TL19 - Antimatter Age",
                        "20":"TL20 - Skip Drive Age",
                        "21":"TL21 - Stasis Age",
                        "22":"TL22 - Planet-scrubber Age",
                        "23":"TL23 - Psychohistory Age",
                        "24":"TL24 - Rosette Age",
                        "25":"TL25 - Psionic Engineering Age",
                        "26":"TL26 - Star Energy Age",
                        "27":"TL27 - Ringworlds Age",
                        "28":"TL28 - Reality Engineering Age",
                        "29":"TL29 - Dyson Sphere Age",
                        "30":"TL30 - Remote Technology Age",
                        "30":"TL30 - Pocket Universes Age"
                    },
                    "heterogeneity":{
                        // pop + flux -> max 20
                        "0":"N/A",
                        "1":"Perfectly homogeneous, ",
                        "2":"Nearly entirely homogenous, ",
                        "3":"Very homogenous, ",
                        "4":"Mostly homogenous, ",
                        "5":"Somewhat homogenous, ",
                        "6":"Slightly homogenous, ",
                        "7":"Average diversity, ",
                        "8":"Slightly diverse, ",
                        "9":"Somewhat diverse, ",
                        "10":"Mostly diverse, ",
                        "11":"Very diverse, ",
                        "12":"Cosmopolitan, ",
                        "13":"Extremely Diverse, ",
                        "14":"Extremely Diverse, ",
                        "15":"Extremely Diverse, ",
                        "16":"Extremely Diverse, ",
                        "17":"Extremely Diverse, ",
                        "18":"Extremely Diverse, ",
                        "19":"Extremely Diverse, ",
                        "20":"Extremely Diverse, "                   },
                    "acceptance":{
                        // Pop + Importance -> max 20/21
                        "0":"",
                        "1":"Extremely xenophobic, ",
                        "2":"Very Xenophobic, ",
                        "3":"Xenophobic, ",
                        "4":"Somewhat Xenophobic, ",
                        "5":"Very cautious of outsiders, ",
                        "6":"Cautious of outsiders, ",
                        "7":"Reasonably cautious of outsiders, ",
                        "8":"Reasonably tolerant of outsiders, ",
                        "9":"Tolerant of outsiders, ",
                        "10":"Very tolerant of outsiders, ",
                        "11":"Generally friendly toward outsiders, ",
                        "12":"Welcoming toward outsiders, ",
                        "13":"Very welcoming toward outsiders, ",
                        "14":"Extremely welcoming toward outsiders, ",
                        "15":"Excessively welcoming toward outsiders, ",
                        "16":"Xenophilic, ",
                        "17":"Very Xenophilic, ",
                        "18":"Extremely Xenophilic, ",
                        "19":"Excessively Xenophilic, ",
                        "20":"Fanatically Xenophilic, ",
                        "21":"Fanatically Xenophilic, "
                    },
                    "strangeness":{
                        // interstellar norm of 7, max 10
                        "0":"",
                        "1":"No local cultural input, ",
                        "2":"Almost no local cultural input, ",
                        "3":"Very slight local cultural input, ",
                        "4":"Slight local cultural input, ",
                        "5":"Minor local cultural input, ",
                        "6":"Only Modest cultural input and deviation from interstellar standards of behavior, ",
                        "7":"Average cultural input and deviation from interstellar standards of behavior, ",
                        "8":"Somewhat strange and deviant from interstellar standards of behavior, ",
                        "9":"Considerably strange and deviant from interstellar standards of behavior, ",
                        "10":"Strange culture, extremely deviant from interstellar standards of behavior, "
                    },

                    "symbols":{
                        // max of 27
                        "0":"",
                        "1":"Only concrete symbols",
                        "2":"Extremely concrete symbols",
                        "3":"Mostly concrete symbols",
                        "4":"Strong tendency toward more concrete symbols",
                        "5":"Tendency toward more concrete symbols",
                        "6":"Slight tendency toward more concrete symbols",
                        "7":"Normal complexity of symbols",
                        "8":"Slight tendency toward more abstract symbols",
                        "9":"Tendency toward more abstract symbols",
                        "10":"Strong tendency toward more abstract symbols",
                        "11":"Unusually abstract symbols",
                        "12":"Unusually abstract symbols",
                        "13":"Extremely abstract symbols",
                        "14":"Extremely abstract symbols",
                        "15":"Extremely abstract symbols",
                        "16":"Extremely abstract symbols",
                        "17":"Extremely abstract symbols",
                        "18":"Extremely abstract symbols",
                        "19":"Extremely abstract symbols",
                        "20":"Extremely abstract symbols",
                        "21":"Extremely abstract symbols",
                        "22":"Extremely abstract symbols",
                        "23":"Extremely abstract symbols",
                        "24":"Extremely abstract symbols",
                        "25":"Extremely abstract symbols",
                        "26":"Extremely abstract symbols",
                        "27":"Extremely abstract symbols",
                    }
                };
                if(system.natives){
                document.getElementById("nativedetailscontainer").style.display = "block";
                document.querySelectorAll("[data-detail]").forEach(function(elmt){
                    var source = elmt.getAttribute("data-source");
                    var detail = elmt.getAttribute("data-detail");
                    var value = source === "species" ? system.natives[detail] : ( source === "mainworld" ? system.mainworld[detail] : system.natives[source][detail]);
                    if(elmt.getAttribute("data-index")){
                        value = value[+(elmt.getAttribute("data-index"))];
                    }
                    removeChildElements(elmt);
                    if(typeof value !== "undefined"){
                        if(elmt.getAttribute("data-html")){                            
                            elmt.insertAdjacentHTML("beforeend", value);
                        }else{
                            
                            elmt.appendChild(document.createTextNode(value));
                        }
                    }
                    
                });
                var noteContainer = document.querySelector(".statnotes");
                    if(noteContainer){
                        removeChildElements(noteContainer);
                        var notes = system.natives.statnotes;
                        for(var i = 0; i < notes.length; i++){
                            var note = notes[i];
                            var noteElmt = document.createElement("li");
                            noteElmt.classList.add("note");
                            note = note.replace(/(?<=\[)(Str)?(Agi)?(Gra)?(Vig)?(Sta)?(Ins)?(Tra)?(Cas)?(Cha)?(?=\])/g,"<strong>$&</strong>");
                            note = note.replace(/(?<=\. ).+/g,"<p style=\"font-size:smaller; margin-top:0px; max-width:520px\">$&</p>")
                            noteElmt.insertAdjacentHTML("beforeend",note);
                            noteContainer.appendChild(noteElmt);
                        }
                    }
            }else{
                document.getElementById("nativedetailscontainer").style.display = "none";
            }
                var systemTokens = document.querySelectorAll("[data-system]");
            for(var i = 0, len = systemTokens.length; i < len; i++){
                var el = systemTokens[i];
                var key = el.getAttribute("data-system");
                var val = {};
                if(typeof system[key] === "string" || typeof system[key] === "number"){
                    val = system[key];
                }else{
                    Object.assign(val,system[key]);
                    if(el.getAttribute("data-lookup")){
                        var keys = Object.keys(val);
                        for(var j = 0, jlen = keys.length; j < jlen; j++){
                            if(lookups[el.getAttribute("data-lookup")][val[keys[j]]]){
                                val[keys[j]] = lookups[el.getAttribute("data-lookup")][val[keys[j]]];
                            }
                        }
                    }
                    if(el.getAttribute("data-join")){
                        if(!val.join){
                            val = Object.values(val);
                        }
                        val = val.join(el.getAttribute("data-join"));
                    }
                }
                if(val.toString() == ""){
                    if(el.getAttribute("data-ifblank")){
                        val = el.getAttribute("data-ifblank");
                    }
                }
                el.innerHTML = val;
            }
            var mainworldTokens = document.querySelectorAll("[data-mainworld]");
            
            for(var i = 0, len = mainworldTokens.length; i < len; i++){
                var el = mainworldTokens[i];
                var key = el.getAttribute("data-mainworld");
                
                var val = {};
                
                if(typeof system.mainworld[key] === "string" || typeof system.mainworld[key] === "number"){
                    val = system.mainworld[key];
                    if(el.getAttribute("data-lookup")){
                        val = lookups[el.getAttribute("data-lookup")][val];
                    }
                    if(el.getAttribute("data-format")==="number"){
                        val = +val;
                        val = val.toLocaleString((navigator.languages && navigator.languages.length ? navigator.languages[0] : navigator.language) || 'en-us');
                    }
                }else if(typeof system.mainworld[key] === "boolean"){
                    if(system.mainworld[key]){
                        val = el.getAttribute("data-iftrue");
                    }else{
                        val = el.getAttribute("data-iffalse");
                    }
                }else{
                    Object.assign(val,system.mainworld[key]);
                    if(el.getAttribute("data-lookup")){
                        var keys = Object.keys(val);
                        for(var j = 0, jlen = keys.length; j < jlen; j++){
                            if(lookups[el.getAttribute("data-lookup")][val[keys[j]]]){
                                val[keys[j]] = lookups[el.getAttribute("data-lookup")][val[keys[j]]];
                            }
                        }
                    }
                }
                if(typeof val === "undefined" || val.toString() == ""){
                    if(el.getAttribute("data-ifblank")){
                        val = el.getAttribute("data-ifblank");
                    }
                }
                if(el.getAttribute("data-join")){
                    if(!val.join){
                        val = Object.values(val);
                    }
                    val = val.join(el.getAttribute("data-join"));
                }
                el.innerHTML = val;
            }
            var importanceTokens = document.querySelectorAll("[data-importance]");
            for(var i = 0, len = importanceTokens.length; i < len; i++){
                var el = importanceTokens[i];
                var key = el.getAttribute("data-importance");
                var val = system.importance[key]
                if(el.getAttribute("data-showsign")){
                    val = (+val >= 0 ? "+" : "") + val;
                }
                el.innerHTML = val;
                
            }
            var economicsTokens = document.querySelectorAll("[data-economics]");
            for(var i = 0, len = economicsTokens.length; i < len; i++){
                var el = economicsTokens[i];
                var key = el.getAttribute("data-economics");
                var val = system.economics[key]
                if(el.getAttribute("data-showsign")){
                    val = (+val >= 0 ? "+" : "") + val;
                }
                el.innerHTML = val;
            }
            var cultureTokens = document.querySelectorAll("[data-culture]");
            for(var i = 0, len = cultureTokens.length; i < len; i++){
                var el = cultureTokens[i];
                var key = el.getAttribute("data-culture");
                var val = system.mainworld.cultural[key]
                if(el.getAttribute("data-showsign")){
                    val = (+val >= 0 ? "+" : "") + val;
                }
                if(el.getAttribute("data-lookup")){
                    val = lookups[el.getAttribute("data-lookup")][val];
                }
                el.innerHTML = val;
            }
            var list = document.getElementById("maplist");
            clearElement(list);
            var description;
            if(system.stars.primary.size == "D"){
                description = "D";
            }else{
                description = system.stars.primary.type + (typeof system.stars.primary.decimal === "undefined" ? "" : system.stars.primary.decimal.toString()) + " " + system.stars.primary.size ;
            }
            description += ". " + getLimitString(system.stars.primary);
            var primli = list.appendChild(document.createElement("li"));
            primli.appendChild(document.createTextNode(
                "Primary Star: " + description
            ));
            primli.classList.add("star");
            for(var i = 0, len = system.stars.primary.satellites.length; i < len; i++){
                var slot = system.stars.primary.satellites[i];
                if(slot && typeof slot !== "undefined"){
                    var description = "";
                    var orbitingStar = false;
                    var types = slot.worldtype.split(" ");
                    if(slot.worldtype.toLowerCase().indexOf("star") >= 0){
                        orbitingStar = true;
                        if(slot.type === "BD"){
                            description = "Brown Dwarf";
                        }else{
                            if(slot.size == "D"){
                                description = "White Dwarf";
                            }else{
                                description = slot.type + (typeof slot.decimal === "undefined" ? "" : slot.decimal.toString()) + " " + slot.size ;
                            }
                        }
                        description += "; " + getLimitString(slot)
                    }else{
                        orbitingStar = false;
                        description = slot.uwp;
                        if(typeof description === "undefined"){ console.log("undefined uwp."); console.log(slot);}
                    }
                    var li = list.appendChild(document.createElement("li"));
                    for(var s = 0; s < types.length; s++){
                        li.classList.add(types[s]);
                    }
                    li.appendChild(document.createTextNode(
                        "Orbit "+slot.decimalOrbit+" ("+slot.au+" AU): "+addCaps(slot.worldtype) + " ("+ description + ")"
                    ));
                    if(!orbitingStar && slot.worldtype !== "Occupied" && slot.worldtype !== "Solar Surface" && slot.uwp){ 
                        var pop = dext(slot.uwp[4]);
                        if(pop > 0){
                            li.classList.add("populated"); 
                            li.appendChild(document.createTextNode("👤"));
                        }else if(slot.uwp[8] !== "0"){
                           
                            li.classList.add("dieback"); 
                            li.appendChild(document.createTextNode("💀"));
                        }
                        if(+(slot.uwp[1]) === 0 && !li.classList.contains("Belt") && !li.classList.contains("Ring") && !li.classList.contains("Occupied") && !li.classList.contains("Surface")){
                            li.classList.add("Worldlet");
                        }
                    }
                    if(slot.satellites){
                        var subOrbitingStar = false;
                        var sublist = list.appendChild(document.createElement("ul"));
                        for(var j = 0, jlen = slot.satellites.length; j < jlen; j++){
                            if(typeof slot.satellites[j] !== "undefined" && slot.satellites[j]){
                                var subslot = slot.satellites[j];
                                var desc = "";
                                var subtypes = subslot.worldtype.split(" ");
                                if(subslot.worldtype.toLowerCase().indexOf("star") >= 0){
                                    subOrbitingStar = true;
                                    if(subslot.type === "BD"){
                                        desc = "Brown Dwarf";
                                    }else{
                                        if(subslot.size == "D"){
                                            desc = "White Dwarf";
                                        }else{
                                            desc = subslot.type + (typeof subslot.decimal === "undefined" ? "" : subslot.decimal.toString()) + " " + subslot.size ;
                                        }
                                        
                                    }
                                    desc += "; " + getLimitString(subslot)
                                }else{
                                    subOrbitingStar = false;
                                    desc = subslot.uwp;
                                }
                                var text = "";
                                if(!orbitingStar){
                                    text = "Orbit " +sat(j)+" ("+satDistance(j,subslot.primarysize,slot.worldtype.indexOf("Giant") > 0).toString()+"): " + addCaps(subslot.worldtype) +" ("+desc+")" ;
                                }else{
                                    text =  "Orbit "+subslot.decimalOrbit+" ("+subslot.au+" AU): " + addCaps(subslot.worldtype) +" ("+desc+")";
                                }
                                var li = sublist.appendChild(document.createElement("li"));
                                li.appendChild(document.createTextNode(text));
                                for(var s = 0; s < subtypes.length; s++){
                                    li.classList.add(subtypes[s]);
                                }
                                if(subslot.isMainworld){ li.classList.add("mainworld");}
                                if(!subOrbitingStar && subslot.worldtype !== "Occupied" && subslot.worldtype !== "Solar Surface" && subslot.uwp){ 
                                    var pop = dext(subslot.uwp[4]);
                                    if(pop > 0){
                                        li.classList.add("populated"); 
                                        li.appendChild(document.createTextNode("👤"));
                                    }else if(subslot.uwp[8] !== "0"){
                                       
                                        li.classList.add("dieback"); 
                                        li.appendChild(document.createTextNode("💀"));
                                    }
                                    if(+(subslot.uwp[1]) === 0 && !li.classList.contains("Belt") && !li.classList.contains("Ring") && !li.classList.contains("Occupied") && !li.classList.contains("Surface")){
                                        li.classList.add("Worldlet");
                                    }
                                }
                                if(subslot.satellites){
                                    subsublist = sublist.appendChild(document.createElement("ul"));
                                    for(var k = 0, klen = subslot.satellites.length; k < klen; k++){
                                        var subsub = subslot.satellites[k];
                                        var desc = "";
                                        if(typeof subsub !== "undefined" && subsub){
                                            if(subsub.worldtype.indexOf("star") >= 0){
                                                if(subsub.type === "BD"){
                                                    desc = "Brown Dwarf";
                                                }else{
                                                    if(subsub.size == "D"){
                                                        desc = "White Dwarf";
                                                    }else{
                                                        desc = subsub.type + (typeof subsub.decimal === "undefined" ? "" : subsub.decimal.toString()) + " " + subsub.size ;
                                                    }
                                                    
                                                }
                                                desc += "; " + getLimitString(subsub)
                                            }else{
                                                desc = subsub.uwp;
                                            }
                                            
                                            var subsubtypes = subsub.worldtype.split(" ");
                                            var text = "";
                                            if(subOrbitingStar){                                               
                                                text = "Orbit "+subsub.decimalOrbit+" ("+subsub.au+" AU): " +addCaps(subsub.worldtype) + " ("+desc+")";
                                                
                                            }else{
                                                text = "Orbit " + sat(k) + " ("+satDistance(k,subsub.primarysize,subslot.worldtype.indexOf("Giant") > 0).toString()+"): " +addCaps(subsub.worldtype) + " ("+desc+")";                                                
                                            }
                                            var li = subsublist.appendChild(document.createElement("li"))
                                            li.appendChild(document.createTextNode(text));
                                            for(var s = 0; s < subsubtypes.length; s++){
                                                li.classList.add(subsubtypes[s]);
                                            }
                                            if(subsub.isMainworld){li.classList.add("mainworld");}
                                            if(!subOrbitingStar && subsub.worldtype !== "Occupied" && subsub.worldtype !== "Solar Surface" &&  subsub.uwp){ 
                                                var pop = dext(subsub.uwp[4]);
                                                if(pop > 0){
                                                    li.classList.add("populated"); 
                                                    li.appendChild(document.createTextNode("👤"));
                                                }else if(subsub.uwp[8] !== "0"){
                                                    
                                                    li.classList.add("dieback"); 
                                                    li.appendChild(document.createTextNode("💀"));
                                                }
                                                if(+(subsub.uwp[1]) === 0 && !li.classList.contains("Belt") && !li.classList.contains("Ring") && !li.classList.contains("Occupied") && !li.classList.contains("Surface")){
                                                    li.classList.add("Worldlet");
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            console.log(system);
            function getLimitString(star){
                return "100D=Orbit " + star.jlimit.toString() + " (" + lookups["orbitdistance"][star.jlimit.toString()]+") 1000D=Orbit "+ star.mlimit + " ("+lookups["orbitdistance"][star.mlimit.toString()]+")"
            }
        }
        function dext(txt){
            var tempInt = parseInt(txt,36);
            if(tempInt <= 17){
                return tempInt;
            }else if(tempInt <= 23){
                return tempInt - 1;
            }else {
                return tempInt - 2;
            }
        }
        
       function sat(i){
            var orbits = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
            return orbits[i];
        }
        function satDistance(i,primarySize,isGasGiant){
            if(typeof isGasGiant == "undefined"){isGasGiant = false;}
            var multipliers = [1,2,3,4,5,6,8,10,20,30,40,50,60,70,80,100,150,200,250,300,400,500,600,700,800,1000];
            if(isGasGiant){
                var sizeCalc = primarySize;
                switch(sizeCalc){
                    case 21: primarySize = 30; break;
                    case 22: primarySize = 40; break;
                    case 23: primarySize = 50; break;
                    case 24: primarySize = 60; break;
                    case 25: primarySize = 70; break;
                    case 26: primarySize = 80; break;
                    case 27: primarySize = 90; break;
                    case 28: primarySize = 125; break;
                    case 29: primarySize = 180; break;
                    case 30: primarySize = 220; break;
                    case 31: primarySize = 250; break;
                    default: break;
                }
            }
            var distance = multipliers[i] * 1000 * primarySize;
            if(distance < 1495978){
                var strDistanceUnformatted = distance.toString();
                var strDistance = "";
                var cursor = strDistanceUnformatted.length-1;

                if(strDistanceUnformatted.length > 3){
                    var counter = 0;
                    while(cursor >= 0){
                        var digit = strDistanceUnformatted[cursor];
                        cursor -=1;
                        
                        if(counter%3==0 && counter > 0){
                            strDistance = digit + "," + strDistance;
                        }else{
                            strDistance = digit + strDistance;
                        }
                        counter +=1;
                    }

                }else{
                    strDistance = strDistanceUnformatted;
                }
                /*for(var j = strDistance.length-1; j >= 0; j--){
                    if(j % 3 === 0 && j !== 0){
                        strDistance = strDistance.substring(0,j) + "," + strDistance.substring(j);
                    }
                }*/
                strDistance += " km";
            }else{
                strDistance = (distance / 149597871).toFixed(2) + " AU";
            }
            return strDistance;// / 149 597 871;
        }        
        function removeChildElements(element){
            while(element.childNodes.length > 0){
                element.removeChild(element.childNodes[element.childNodes.length-1]);
            }
        }
        function clearElement(el){
            while(el.children.length > 0){
                el.removeChild(el.children[el.children.length-1]);
            }
        }
        })();
    </script>
</body>
</html>
