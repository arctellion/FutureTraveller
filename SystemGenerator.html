<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Generator</title>
</head>
<body>
    <div>
        <input type="button" value="Generate System" id="btnGenerateSystem" />
        <div id="SystemDetails">
            <h1 data-system="name">System Name</h1>
            <h2 data-system="uwp">Mainworld</h2>
            <h3><span data-importance="description">System Importance</span> system (<span data-importance="weeklytraffic"></span> ships/week)</h3>
            <h3>System Map:</h3>
            <ul id="maplist"></ul>
        </div>
    </div>
    <script src="NameGenerator.js"></script>
    <script src="SystemGenerator.js"></script>
    <script>
        function sat(i){
            var orbits = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
            return orbits[i];
        }
        NameGenerator("names.jsonc",function(generator){
            document.getElementById("btnGenerateSystem").addEventListener("click",function(){
                console.clear();
                var gasGiantFrequency = 8, permitDieback = false, maxTechLevel = 16;
                var system = generateSystemDetails(
                    addCaps(generator.getRandomName("system")), 
                    gasGiantFrequency,
                    maxTechLevel
                );
                renderSystem(system);
            });
            var gasGiantFrequency = 8, permitDieback = false, maxTechLevel = 16;
            var system = generateSystemDetails(
                addCaps(generator.getRandomName("system")), 
                gasGiantFrequency,
                maxTechLevel
            );
            renderSystem(system);
        });
        function renderSystem(system){
                var lookups = {
                    tradecode:{
                        "As":"Asteroid Belt",
                        "De":"Desert",
                        "Fl":"Fluid Oceans",
                        "Ga":"Garden World",
                        "He":"Hellworld",
                        "Ic":"Ice-Capped",
                        "Oc":"Ocean World",
                        "Va":"Vacuum",
                        "Wa":"Water World",
                        "Sa":"Satellite (far satellite)",
                        "Lk":"Locked (close satellite)",
                        "Di":"Dieback",
                        "Ba":"Barren",
                        "Lo":"Low Population",
                        "Ni":"Non-Industrial",
                        "Ph":"Pre-High Population",
                        "Hi":"High Population",
                        "Pa":"Pre-Agricultural",
                        "Ag":"Agricultural",
                        "Na":"Non-Agricultural",
                        "Px":"Prison or Exile Camp",
                        "Pi":"Pre-Industrial",
                        "In":"Industrial",
                        "Po":"Poor",
                        "Pr":"Pre-Rich",
                        "Ri":"Rich",
                        "Fr":"Frozen",
                        "Ho":"Hot",
                        "Co":"Cold",
                        "Tr":"Tropic",
                        "Tu":"Tundra",
                        "Tz":"Twilight Zone",
                        "Cp":"Capital",
                        "Cy":"Colony",
                        "Lt":"Low Tech",
                        "Ht":"High Tech"
                    }
                };
            var systemTokens = document.querySelectorAll("[data-system]");
            for(var i = 0, len = systemTokens.length; i < len; i++){
                var el = systemTokens[i];
                var key = el.getAttribute("data-system");
                var val = {};
                if(typeof system[key] === "string"){
                    val = system[key];
                }else{
                    Object.assign(val,system[key]);
                    if(el.getAttribute("data-lookup")){
                        var keys = Object.keys(val);
                        for(var i = 0, len = keys.length; i < len; i++){
                            if(lookups[el.getAttribute("data-lookup")][val[keys[i]]]){
                                val[keys[i]] = lookups[el.getAttribute("data-lookup")][val[keys[i]]];
                            }
                        }
                    }
                    if(el.getAttribute("data-join")){
                        if(!val.join){
                            val = Object.values(val);
                        }
                        val = val.join(el.getAttribute("data-join"));
                    }
                }
                if(val.toString() === ""){
                    if(el.getAttribute("data-ifblank")){
                        val = el.getAttribute("data-ifblank");
                    }
                }
                el.innerHTML = val;
            }
            var mainworldTokens = document.querySelectorAll("[data-mainworld]");
            for(var i = 0, len = mainworldTokens.length; i < len; i++){
                var el = mainworldTokens[i];
                var key = el.getAttribute("data-mainworld");
                var val = {};
                if(typeof system.mainworld[key] === "string"){
                    val = system.mainworld[key];
                }else{
                    Object.assign(val,system.mainworld[key]);
                    if(el.getAttribute("data-lookup")){
                        var keys = Object.keys(val);
                        for(var i = 0, len = keys.length; i < len; i++){
                            if(lookups[el.getAttribute("data-lookup")][val[keys[i]]]){
                                val[keys[i]] = lookups[el.getAttribute("data-lookup")][val[keys[i]]];
                            }
                        }
                    }
                }
                if(el.getAttribute("data-join")){
                    if(!val.join){
                        val = Object.values(val);
                    }
                    val = val.join(el.getAttribute("data-join"));
                }
                el.innerHTML = val;
            }
            var importanceTokens = document.querySelectorAll("[data-importance]");
            for(var i = 0, len = importanceTokens.length; i < len; i++){
                var el = importanceTokens[i];
                var key = el.getAttribute("data-importance");
                el.innerHTML = system.importance[key];
                
            }
            var list = document.getElementById("maplist");
            clearElement(list);
            var description = system.stars.primary.type + (typeof system.stars.primary.decimal === "undefined" ? "" : system.stars.primary.decimal.toString()) + system.stars.primary.size;
            list.appendChild(document.createElement("li")).appendChild(document.createTextNode(
                "Primary Star: " + description
            ))
            for(var i = 0, len = system.stars.primary.satellites.length; i < len; i++){
                var slot = system.stars.primary.satellites[i];
                if(slot && typeof slot !== "undefined"){
                    var description = "";
                    var orbitingStar = false;
                    if(slot.worldtype.indexOf("star") >= 0){
                        orbitingStar = true;
                        if(slot.type === "BD"){
                            description = "Brown Dwarf";
                        }else{
                            description = slot.type + (typeof slot.decimal === "undefined" ? "" : slot.decimal.toString()) + slot.size ;
                        }
                    }else{
                        orbitingStar = false;
                        description = slot.uwp;
                        if(typeof description === "undefined"){ console.log(slot);}
                    }
                    var li = list.appendChild(document.createElement("li"));
                    li.appendChild(document.createTextNode(
                        "Orbit "+i+": "+addCaps(slot.worldtype) + " ("+ description + ")"+(slot.isMainworld?"**":"")
                    ));
                    if(slot.isMainworld){li.style.fontWeight = "bold";}
                    if(slot.satellites){
                        var subOrbitingStar = false;
                        var sublist = list.appendChild(document.createElement("ul"));
                        for(var j = 0, jlen = slot.satellites.length; j < jlen; j++){
                            if(typeof slot.satellites[j] !== "undefined"){
                                var subslot = slot.satellites[j];
                                var desc = "";
                                if(subslot.worldtype.indexOf("star") >= 0){
                                    subOrbitingStar = true;
                                    if(subslot.type === "BD"){
                                        desc = "Brown Dwarf";
                                    }else{
                                        desc = subslot.type + (typeof subslot.decimal === "undefined" ? "" : subslot.decimal.toString()) + subslot.size ;
                                    }
                                }else{
                                    subOrbitingStar = false;
                                    desc = subslot.uwp;
                                }
                                var text = "";
                                if(!orbitingStar){
                                    text = "Orbit " +sat(j)+": " + addCaps(subslot.worldtype) +" ("+desc+")" +(subslot.isMainworld?"**":"");
                                }else{
                                    text =  "Orbit " +j+": " + addCaps(subslot.worldtype) +" ("+desc+")" +(subslot.isMainworld?"**":"")
                                }
                                var li = sublist.appendChild(document.createElement("li"));
                                li.appendChild(document.createTextNode(text));
                                if(subslot.isMainworld){ li.style.fontWeight = "bold"; }
                                
                                if(subslot.satellites){
                                    subsublist = sublist.appendChild(document.createElement("ul"));
                                    for(var k = 0, klen = subslot.satellites.length; k < klen; k++){
                                        var subsub = subslot.satellites[k];
                                        if(typeof subsub !== "undefined"){
                                            desc = subsub.uwp;
                                            var text = "";
                                            if(subOrbitingStar){                                               
                                                text = "Orbit " + k + ": " +addCaps(subsub.worldtype) + " ("+desc+")"+(subsub.isMainworld?"**":"");
                                                
                                            }else{
                                                text = "Orbit " + sat(k) + ": " +addCaps(subsub.worldtype) + " ("+desc+")"+(subsub.isMainworld?"**":"");                                                
                                            }
                                            var li = subsublist.appendChild(document.createElement("li"))
                                            li.appendChild(document.createTextNode(text));
                                            if(subsub.isMainworld){li.style.fontWeight = "bold";}
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
            console.log(system);
        }
       
        function clearElement(el){
            while(el.children.length > 0){
                el.removeChild(el.children[el.children.length-1]);
            }
        }
        function addCaps(text) {
            var capitalizedString = "";
            var lastCharacter = null, currCharacter = " ";
            if(typeof text === "undefined"){return text;}
            for (var i = 0, len = text.length; i < len; i++) {
                lastCharacter = currCharacter;
                currCharacter = text[i];
                if (lastCharacter === " " || lastCharacter === "-") {
                    capitalizedString += currCharacter.toUpperCase();
                } else {
                    capitalizedString += currCharacter;
                }
            }
            return capitalizedString;
        }
    </script>
</body>
</html>